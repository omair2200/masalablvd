;/*FB_PKG_DELIM*/

__d("EchoBackupCompareUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b;return{contentSubtype:a.contentSubtype,contentType:a.contentType,reactionTsList:(b=a.reactionAuthoritativeTimestampMs)==null?void 0:b.map(function(a){return a.displayName==null?null:Number(a.displayName)/1e3}).filter(Boolean).sort(),receiptTsList:(b=a.receiptStatusList)==null?void 0:b.map(function(a){return a.timestampMs==null?null:a.timestampMs/1e3}).filter(Boolean).sort()}}function g(a,b){if(a==null&&b==null)return!0;if(a!=null&&b!=null)return a.length===b.length&&a.every(function(a,c){return a===b[c]});return a==null&&(b==null?void 0:b.length)===0||b==null&&(a==null?void 0:a.length)===0?!0:!1}function b(a,b){return b!=null&&a.contentSubtype===b.contentSubtype&&a.contentType===b.contentType&&g(a.reactionTsList,b.reactionTsList)}f.buildEchoDocCacheValue=a;f.echoEquals=b}),66);
__d("EchoCommonUtils",[],(function(a,b,c,d,e,f){"use strict";c="Echo-Doc-Version";function a(a,b){var c=a.localKey;a=a.transportKey;return c+"@"+a+"-"+b}function b(a,b,c){return a==null?{localKey:b,transportKey:c}:{displayName:a,localKey:b,transportKey:c}}f.ECHO_COMMON_FIELD_DOCUMENT_VERSION=c;f.getEchoAddressFieldNameWithSuffix=a;f.craftEchoAddress=b}),66);
__d("EchoConstants",[],(function(a,b,c,d,e,f){"use strict";a=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);f.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=a}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(a,b,c,d,e,f,g,h){"use strict";function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."]);u=function(){return a};return a}var v=new Set([]);function w(a,b){if(a.length===0)return;var c=a.indexOf(":");if(c===-1){d("WALogger").ERROR(u());return}var e=a.substring(0,c).trim();a=a.substring(c+1).trim();if(e.length===0){d("WALogger").ERROR(t());return}if(a.length===0){b.has(e)&&b["delete"](e);return}b.set(e,a)}function x(a,b,c,e){c===void 0&&(c=new Set());var f=!1,g=b==="conditional"&&a[0]==='"',h="",i=g?1:0;while(i<a.length){var j=a[i];if(b==="conditional"&&!g&&j==='"')break;if(!g&&c.has(j))break;if(g&&!f&&j==='"'){g=!1;i++;break}if(g&&!f&&j==="\\"){if(i===a.length-1)break;f=!0}else f&&j==="r"?h+="\r":f&&j==="n"?h+="\n":h+=j,f=!1;i++}if(g||h.length===0){c=(j=e)!=null?j:"unknown";d("WALogger").ERROR(s(),c);return{remainder:a,result:null,success:!1}}return{remainder:a.substring(i),result:h,success:!0}}function y(a,b){if(a.length===0){d("WALogger").ERROR(r());return{remainder:a,result:null,success:!1}}var c=a.trimLeft();c=x(c,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,b);if(!c.success){d("WALogger").ERROR(q());return{remainder:a,result:null,success:!1}}c.result!=null||h(0,47923);if(c.remainder[0]==="@"){var e=z(c.remainder,c.result,b);return{remainder:e.remainder,result:e.result,success:e.success}}e=c.result;c=c.remainder.trimLeft();if(c.startsWith("<")){c=z(c.substring(1),void 0,b);b=c.result;var f=c.remainder;if(c.success&&b!=null&&f.startsWith(">"))if(e.length===0)return{remainder:f.substring(1),result:b,success:!0};else return{remainder:f.substring(1),result:babelHelpers["extends"]({},b,{displayName:e}),success:!0}}d("WALogger").ERROR(p());return{remainder:a,result:null,success:!1}}function z(a,b,c){var e=b==null?a.trimLeft():a;b=b;if(b==null){var f=x(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);if(!f.success){d("WALogger").ERROR(o());return{remainder:a,result:null,success:!1}}b=f.result;e=f.remainder}if(b==null||b.length===0||e[0]!=="@"){d("WALogger").ERROR(n());return{remainder:a,result:null,success:!1}}f=x(e.substring(1),"never",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);e=f.result;if(f.success&&e!=null&&e.length>0)return{remainder:f.remainder,result:{localKey:b,transportKey:e},success:!0};else{d("WALogger").ERROR(m());return{remainder:a,result:null,success:!1}}}function A(a,b){if(a.length===0){d("WALogger").ERROR(l());return{result:null,success:!1}}var c=y(a,b);if(!c.success){d("WALogger").ERROR(k(),a);return{result:null,success:!1}}c.result!=null||h(0,47927);a=[c.result];c=c.remainder;while(c.startsWith(",")){var e=y(c.substring(1).trimLeft(),b);if(e.success)e.result!=null&&a.push(e.result),c=e.remainder;else break}return{result:a,success:!0}}function a(a){var b=new Map(),c=a.split("\r\n");if(c.length===1&&c[0]===a){d("WALogger").ERROR(j());return b}c.forEach(function(a){return w(a,b)});return b}function b(a,b){a=a.get(b);if(a==null||a.length===0||a==='""')return{result:null,success:!1};a=x(a,"conditional",v,b);b=a.result;a=a.success;return{result:b,success:a}}function c(a,b){a=B(a,b);return{result:(b=a.result)!=null?b:0,success:a.success}}function B(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=parseInt(a,10);if(isNaN(a)){d("WALogger").ERROR(i(),b);return{result:null,success:!1}}else return Number.isSafeInteger(a)?{result:a,success:!0}:{result:a>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function e(a,b){a=C(a,b);return{result:(b=a.result)!=null?b:!1,success:a.success}}function C(a,b){a=B(a,b);return!a.success||a.result!==0&&a.result!==1?{result:null,success:!1}:{result:a.result===1,success:!0}}function f(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=y(a,b);b=a.result;a=a.success;return{result:b,success:a}}function D(a,b){a=a.get(b);return a==null||a.length===0?{result:null,success:!1}:A(a,b)}function E(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};b=a.split(",").map(function(a){return a.trim()}).filter(Boolean);return b.length===0?{result:null,success:!1}:{result:b,success:!0}}g.echoDecodeFields=a;g.echoDecodeStringField=b;g.echoDecodeIntField=c;g.echoDecodeNullableIntField=B;g.echoDecodeBooleanField=e;g.echoDecodeNullableBooleanField=C;g.echoDecodeAddressField=f;g.echoDecodeAddressListField=D;g.echoDecodeObjectIdListField=E}),98);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","MAWMsgType","WABase64","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(['"',"\\","\n","\r","\0"]),i=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"',"\\"]);function j(a,b){for(var b=b,c=Array.isArray(b),d=0,b=c?b:b[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var e;if(c){if(d>=b.length)break;e=b[d++]}else{d=b.next();if(d.done)break;e=d.value}e=e;if(a.indexOf(e)>=0)return!0}return!1}function k(a,b,d){d===void 0&&(d=new Set());if(a.length<=0)throw c("unrecoverableViolation")("The input string must be non-empty","labyrinth_web");var e=b;b==="conditional"&&(j(a,d)?e="always":e="never");if(e==="never")return a;b='"';for(d=0;d<a.length;d++){e=a[d];h.has(e)?(b+="\\",e==="\r"?b+="r":e==="\n"?b+="n":b+=e):b+=e}return b+'"'}function l(a){if(!Number.isSafeInteger(a))throw c("unrecoverableViolation")("The input value must be a safe integer","labyrinth_web");return a.toString()}function m(a){var b="",c=a.displayName,e=a.localKey;a=a.transportKey;c!=null&&c.length>0&&(b+=k(c,"always")+" <");b+=k(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a;c!=null&&c.length>0&&(b+=">");return b}function n(a,b,c){c!=null&&c.length!==0&&a.set(b,k(c,"conditional",i))}function a(a,b,c){if(c!=null){c=l(c);n(a,b,c)}}function b(a,b,c){if(c!=null){c=l(c?1:0);n(a,b,c)}}function e(a,b,c){c!=null&&a.set(b,m(c))}function f(a,b,c){if(c!=null){var d="";c.forEach(function(a,b){d+=m(a),b<c.length-1&&(d+=", ")});a.set(b,d)}}function o(a){var b="";a.forEach(function(a,c){b=b+c+": "+a+"\r\n"});return b}function p(a){return d("WABase64").encodeB64UrlSafe(a)}function q(a){switch(a){case d("MAWMsgType").MSG_TYPE.TEXT:return d("EchoMessage").EchoXMessageContentType.TEXT;case d("MAWMsgType").MSG_TYPE.IMAGE:return d("EchoMessage").EchoXMessageContentType.IMAGE;case d("MAWMsgType").MSG_TYPE.VIDEO:return d("EchoMessage").EchoXMessageContentType.VIDEO;case d("MAWMsgType").MSG_TYPE.PTT:return d("EchoMessage").EchoXMessageContentType.AUDIO;case d("MAWMsgType").MSG_TYPE.STICKER:return d("EchoMessage").EchoXMessageContentType.STICKER;case d("MAWMsgType").MSG_TYPE.GIF:return d("EchoMessage").EchoXMessageContentType.GIF;case d("MAWMsgType").MSG_TYPE.XMA:return d("EchoMessage").EchoXMessageContentType.XMA;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("EchoMessage").EchoXMessageContentType.DOCUMENT;case d("MAWMsgType").MSG_TYPE.REACTION:return d("EchoMessage").EchoXMessageContentType.REACTION;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return d("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case d("MAWMsgType").MSG_TYPE.REVOKED:return d("EchoMessage").EchoXMessageContentType.UNSEND;case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("EchoMessage").EchoXMessageContentType.BUMP;default:return d("EchoMessage").EchoXMessageContentType.UNKNOWN}}function r(a){if(a==null)return void 0;switch(a){case d("EchoMessage").EchoXMessageContentType.TEXT:return d("MAWMsgType").MSG_TYPE.TEXT;case d("EchoMessage").EchoXMessageContentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessage").EchoXMessageContentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessage").EchoXMessageContentType.AUDIO:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessage").EchoXMessageContentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessage").EchoXMessageContentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessage").EchoXMessageContentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessage").EchoXMessageContentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;case d("EchoMessage").EchoXMessageContentType.REACTION:return d("MAWMsgType").MSG_TYPE.REACTION;case d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS:return d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN;case d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE:return d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE;case d("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME:return d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME;case d("EchoMessage").EchoXMessageContentType.UNSEND:return d("MAWMsgType").MSG_TYPE.REVOKED;case d("EchoMessage").EchoXMessageContentType.GROUP_INVITES:return d("MAWMsgType").MSG_TYPE.GROUP_INVITE;case d("EchoMessage").EchoXMessageContentType.BUMP:return d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE;default:return void 0}}g.echoSetStringField=n;g.echoSetIntField=a;g.echoSetBooleanField=b;g.echoSetAddressField=e;g.echoSetAddressListField=f;g.echoEncodeFields=o;g.convertMediaKeyToString=p;g.convertDbMsgTypeToXMessageContentType=q;g.convertXMessageContentTypeToDbMsgType=r}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]);m=function(){return a};return a}var n="Message-ID",o="Thread-ID",p="Sort-Order",q="Display-Timestamp",r="Authoritative-Timestamp",s="From",t="Text",u="Text-Size",v="Send-Error",w="Is-Tombstoned",x="Expire-Timestamp",y="Delete-Timestamp",z="Ephemeral-Duration",A="Message-Content-Type",B="X-Message-Content-Type",C="Message-Content-Subtype",D="Is-Forwarded",E="X-Offline-Threading-ID",F="X-Thread-ID",G="X-Message-Placeholder-Type",H="Reactions",I="Reaction-Authoritative-Timestamps",J="X-Reaction-Offline-Threading-IDs",K="Echo-Serialization-Origin",L="Revoke-Sent-Timestamp",M="Revoke-Unsent-Timestamp",N="Edit-Count",O="Edit-Contents-",P="Edit-Timestamps-";f="Group-ID";var Q="Group-Index",R="Group-Size",S=1,T=(b=b("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),U=b({NONE:"none",UNSEND:"unsend"}),V=b({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),W=b({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),X=b({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),Y=b({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function a(a){var b=new Map();fa(b,a);"mediaData"in a&&a.mediaData&&d("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(b,a.mediaData);return d("EchoEncodingUtils").echoEncodeFields(b)}function Z(a,b){var c,e=[],f=new Set();b.forEach(function(c,g,h){c=g.startsWith(O);h=g.startsWith(P);if(c||h){h=g.slice(c?O.length:P.length);if(!f.has(h)){f.add(h);c=(g=d("EchoDecodingUtils").echoDecodeStringField(b,""+O+h).result)!=null?g:"";g=((g=d("EchoDecodingUtils").echoDecodeIntField(b,""+P+h).result)!=null?g:0)/1e3;e.push({messageId:h,originalMessageId:a,text:c,timestamp:g})}}});c=(c=d("EchoDecodingUtils").echoDecodeIntField(b,N).result)!=null?c:0;return{editCount:c,editHistory:e}}function e(a){a=d("EchoDecodingUtils").echoDecodeFields(a);if(a.size===0){d("WALogger").ERROR(m());return null}var b=d("EchoDecodingUtils").echoDecodeStringField(a,n),e=d("EchoDecodingUtils").echoDecodeStringField(a,o),f=d("EchoDecodingUtils").echoDecodeIntField(a,p),g=d("EchoDecodingUtils").echoDecodeIntField(a,q),N=d("EchoDecodingUtils").echoDecodeStringField(a,A),O=d("EchoDecodingUtils").echoDecodeStringField(a,B),P=d("EchoDecodingUtils").echoDecodeStringField(a,C);if(b.success&&e.success&&f.success){b=b.result;if(b==null)throw c("FBLogger")("messenger_web_devx").mustfixThrow("The decoded messageId cannot be null");e=e.result;if(e==null)throw c("FBLogger")("messenger_web_devx").mustfixThrow("The decoded threadId cannot be null");N=N==null?void 0:N.result;if(N==null)throw c("FBLogger")("messenger_web_devx").mustfixThrow("The decoded contentTypeString cannot be null");var Q=Z(b,a),R=Q.editCount;Q=Q.editHistory;P={contentSubtype:ca(P.result),contentType:aa(N),displayTimestampMs:g.success?g.result:f.result,editCount:R,editHistory:Q,messageId:b,sortOrderMs:f.result,threadId:e};N=ba(O.result);N!=null&&(P.xContentType=N);g=d("EchoDecodingUtils").echoDecodeAddressField(a,s);g.success&&g.result!=null&&(P.from=g.result);R=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,w);R.success&&R.result!=null&&(P.isTombstoned=R.result);Q=d("EchoDecodingUtils").echoDecodeStringField(a,t);Q.success&&Q.result!=null&&(P.text=Q.result);b=d("EchoDecodingUtils").echoDecodeStringField(a,u);if(b.success&&b.result!=null){f=$(b.result);P.textSize=f}e=d("EchoDecodingUtils").echoDecodeStringField(a,G);if(e.success&&e.result!=null){O=da(e.result);P.xMessagePlaceholderType=O}N=d("EchoDecodingUtils").echoDecodeStringField(a,v);N.success&&N.result!=null&&(P.sendError=N.result);g=d("EchoDecodingUtils").echoDecodeNullableIntField(a,x);g.success&&g.result!=null&&(P.expireTimestampMs=g.result);R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,y);R.success&&R.result!=null&&(P.deleteTimestampMs=R.result);Q=d("EchoDecodingUtils").echoDecodeNullableIntField(a,z);Q.success&&Q.result!=null&&(P.ephemeralDurationInSec=Q.result);b=d("EchoDecodingUtils").echoDecodeNullableIntField(a,r);b.success&&b.result!=null&&(P.authoritativeTimestampMs=b.result);f=d("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(a);f.length>0&&(P.receiptStatusList=f);e=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,D);e.success&&e.result!=null&&(P.isForwarded=e.result);d("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(a,P);O=d("EchoDecodingUtils").echoDecodeStringField(a,E);O.success&&O.result!=null&&(P.xOfflineThreadingId=O.result);N=d("EchoDecodingUtils").echoDecodeStringField(a,F);N.success&&N.result!=null&&(P.xThreadId=N.result);g=d("EchoDecodingUtils").echoDecodeStringField(a,K);g.success&&g.result!=null&&(P.serializationOrigin=ea(g.result));R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);P.version=R.success&&R.result!=null?R.result:S;Q=d("EchoDecodingUtils").echoDecodeAddressListField(a,H);Q.success&&Q.result!=null&&(P.reactions=Q.result);b=d("EchoDecodingUtils").echoDecodeAddressListField(a,I);b.success&&b.result!=null&&(P.reactionAuthoritativeTimestampMs=b.result);f=d("EchoDecodingUtils").echoDecodeAddressListField(a,J);f.success&&f.result!=null&&(P.reactionXOfflineThreadingIds=f.result);e=d("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(a);e!=null&&(P.quoteData=e);O=(P==null?void 0:P.contentType)===V.XMA&&a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS));if((P==null?void 0:P.contentType)===V.MEDIA||O){N=d("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(a,P==null?void 0:P.contentType,P==null?void 0:P.xContentType);g="[labyrinth_web] mandatory media data is missing from media message, msgId: "+P.messageId+".";N!=null?(N.length!==1&&N.length!==2&&((P==null?void 0:P.contentType)===V.MEDIA&&d("WALogger").ERROR(l(),g,P.serializationOrigin),(P==null?void 0:P.contentType)===V.XMA&&d("WALogger").WARN(k(),g,P.serializationOrigin)),P.mediaData=N[0],N.length===2&&(P.previewMediaData=N[1])):((P==null?void 0:P.contentType)===V.MEDIA&&d("WALogger").ERROR(j(),g,P.serializationOrigin),(P==null?void 0:P.contentType)===V.XMA&&d("WALogger").WARN(i(),g,P.serializationOrigin))}if(P.contentType===V.PLACEHOLDER&&P.contentSubtype===U.UNSEND){R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,L);R.success&&R.result!=null&&(P.revokeSentTimestampMs=R.result);Q=d("EchoDecodingUtils").echoDecodeNullableIntField(a,M);Q.success&&Q.result!=null&&(P.revokeUnsentTimestampMS=Q.result)}if(P.contentType===V.XMA){b=d("EchoMessageXMAFieldUtils").decodeXMAFields(a);if(b!=null)P.xmaData=b;else{d("WALogger").ERROR(h(),P.messageId);return null}}return P}else return null}function $(a){return(a=T.cast(a))!=null?a:T.NONE}function aa(a){return(a=V.cast(a))!=null?a:V.TEXT}function ba(a){return W.cast(a)}function ca(a){return(a=U.cast(a))!=null?a:U.NONE}function da(a){return(a=X.cast(a))!=null?a:X.NO_PLACEHOLDER}function ea(a){return(a=Y.cast(a))!=null?a:Y.UNKNOWN}function fa(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,n,b.messageId);c.echoSetStringField(a,o,b.threadId);c.echoSetIntField(a,p,b.sortOrderMs);c.echoSetIntField(a,q,b.displayTimestampMs);c.echoSetIntField(a,r,b.authoritativeTimestampMs);c.echoSetAddressField(a,s,b.from);c.echoSetStringField(a,t,b.text);b.textSize!=null&&d("EchoEncodingUtils").echoSetStringField(a,u,b.textSize);b.xMessagePlaceholderType!=null&&d("EchoEncodingUtils").echoSetStringField(a,G,b.xMessagePlaceholderType);d("EchoEncodingUtils").echoSetStringField(a,v,b.sendError);d("EchoEncodingUtils").echoSetBooleanField(a,w,b.isTombstoned);d("EchoEncodingUtils").echoSetIntField(a,x,b.expireTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,y,b.deleteTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,z,b.ephemeralDurationInSec);b.contentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,A,b.contentType);b.xContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,B,b.xContentType);d("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(a,b.receiptStatusList);d("EchoEncodingUtils").echoSetBooleanField(a,D,b.isForwarded);d("EchoEncodingUtils").echoSetStringField(a,E,b.xOfflineThreadingId);d("EchoEncodingUtils").echoSetStringField(a,F,b.xThreadId);d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,b.version);b.contentSubtype!=null&&d("EchoEncodingUtils").echoSetStringField(a,C,b.contentSubtype);d("EchoEncodingUtils").echoSetAddressListField(a,H,b.reactions);d("EchoEncodingUtils").echoSetAddressListField(a,I,b.reactionAuthoritativeTimestampMs);d("EchoEncodingUtils").echoSetAddressListField(a,J,b.reactionXOfflineThreadingIds);d("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(a,b);b.serializationOrigin!=null&&d("EchoEncodingUtils").echoSetStringField(a,K,b.serializationOrigin);b.revokeSentTimestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,L,b.revokeSentTimestampMs);b.revokeUnsentTimestampMS!=null&&d("EchoEncodingUtils").echoSetIntField(a,M,b.revokeUnsentTimestampMS);d("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(a,b);c=b.xmaData;c!=null&&d("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(a,c);((c=b.editHistory)==null?void 0:c.length)>0&&(d("EchoEncodingUtils").echoSetIntField(a,N,b.editCount),b.editHistory.forEach(function(b){var c=b.messageId;c!=null&&(d("EchoEncodingUtils").echoSetStringField(a,O+c,b.text),d("EchoEncodingUtils").echoSetIntField(a,P+c,b.timestamp*1e3))}))}g.ECHO_SERIALIZATION_ORIGIN=K;g.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=N;g.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=O;g.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=P;g.ECHO_MESSAGE_FIELD_GROUP_ID=f;g.ECHO_MESSAGE_FIELD_GROUP_INDEX=Q;g.ECHO_MESSAGE_FIELD_GROUP_SIZE=R;g.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=S;g.MessageTextSize=T;g.EchoMessageContentSubtype=U;g.EchoMessageContentType=V;g.EchoXMessageContentType=W;g.EchoMessagePlaceholderType=X;g.EchoSerializationOriginType=Y;g.encodeEchoMessage=a;g.decodeEchoMessage=e}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields"]);u=function(){return a};return a}var v="X-Object-Id",w="X-Attachment-Object-Ids",x="Attachment-Type",y="Content-Type",z="X-Encrypted-Hash",A="X-Attachment-Type",B="X-Backup-Ent-Fbid",C="X-Backup-Status",D="X-Content-Type",E="X-Direct-Path",F="Height",G="X-Media-Key",H="X-Media-Key-Timestamp",I="Playable-Duration",J="Preview-Height",K="Preview-Content-Type",L="Preview-Width",M="Size",N="Width",O="X-Plaintext-Hash",P="File-Name",Q="Header-Attribution-Content-Type",R=(e=b("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),S=e({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),T=e({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),U=e({FULL:"full",PREVIEW:"preview"});function V(a){var b=a.attachmentObjectId,c=a.attachmentType,e=a.backupEntFbid,f=a.directPath,g=a.filename,h=a.encryptedHash,i=a.height,j=a.mediaBackupStatus,k=a.mediaContentType,l=a.mediaKey,m=a.mediaKeyTimestamp,n=a.mediaPlayableDuration,o=a.plaintextHash,v=a.previewContentHeight,w=a.previewContentType,x=a.previewContentWidth,y=a.size,z=a.width,A=a.xAttachmentType,B=a.xContentType;a=a.xmaData;if(b==null)d("WALogger").ERROR(u());else if(c==null)d("WALogger").ERROR(t());else if(f==null)d("WALogger").ERROR(s());else if(o==null)d("WALogger").ERROR(r());else if(B==null)d("WALogger").ERROR(q());else if(A==null)d("WALogger").ERROR(p());else return{attachmentObjectId:b,attachmentType:c,backupEntFbid:e,directPath:f,encryptedHash:h,filename:g,height:i,mediaBackupStatus:j,mediaContentType:k,mediaKey:l,mediaKeyTimestamp:m,mediaPlayableDuration:n,plaintextHash:o,previewContentHeight:v,previewContentType:w,previewContentWidth:x,size:y,width:z,xAttachmentType:A,xContentType:B,xmaData:a}}function a(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,v,b.attachmentObjectId);c.echoSetStringField(a,x,b.attachmentType);c.echoSetStringField(a,O,b.plaintextHash);c.echoSetStringField(a,z,b.encryptedHash);c.echoSetIntField(a,M,b.size);c.echoSetStringField(a,G,b.mediaKey);c.echoSetIntField(a,H,b.mediaKeyTimestamp);c.echoSetStringField(a,E,b.directPath);b.mediaContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,y,b.mediaContentType);d("EchoEncodingUtils").echoSetIntField(a,N,b.width);d("EchoEncodingUtils").echoSetIntField(a,F,b.height);b.previewContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,K,b.previewContentType);b.headerAttributionContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,Q,b.headerAttributionContentType);d("EchoEncodingUtils").echoSetIntField(a,L,b.previewContentWidth);d("EchoEncodingUtils").echoSetIntField(a,J,b.previewContentHeight);d("EchoEncodingUtils").echoSetIntField(a,I,b.mediaPlayableDuration);b.xAttachmentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,A,b.xAttachmentType);d("EchoEncodingUtils").echoSetStringField(a,D,b.xContentType);d("EchoEncodingUtils").echoSetStringField(a,B,b.backupEntFbid);d("EchoEncodingUtils").echoSetStringField(a,C,b.mediaBackupStatus);d("EchoEncodingUtils").echoSetStringField(a,P,b.filename)}function c(a,b,c){var e={},f=!1,g=!1,h=!1;if(aa(a)){var i=$(a,b,c);if(i==null){d("WALogger").ERROR(o(),b,c);return null}i.length!==2&&d("WALogger").ERROR(n());c=!1;var j=!1,k=i[0];i=i[1];var l={};f=Y(a,e,k);c=Y(a,l,i);g=X(a,e,b,k,k);j=X(a,l,b,i,k);h=W(a,e,k);k=W(a,l,i);if(!f||!g||!h||!c||!j||!k)return null;i=V(e);c=V(l);if(i!=null&&c!=null)return[i,c]}else{f=Y(a,e);g=X(a,e,b);h=W(a,e);if(!f||!g||!h)return null;j=V(e);if(j!=null)return[j]}return null}function W(a,b,c){var e;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";c=[{fieldName:"height",id:F},{fieldName:"width",id:N},{fieldName:"size",id:M},{fieldName:"previewContentHeight",id:J},{fieldName:"previewContentWidth",id:L},{fieldName:"mediaKeyTimestamp",id:c!=null?c+"-"+H:H}];var f=[{attachmentTypes:[T.VIDEO,T.AUDIO],fieldName:"mediaPlayableDuration",id:I}];for(var g=0;g<f.length;g++){var h=f[g],i=h.attachmentTypes,j=h.fieldName;h=h.id;h=d("EchoDecodingUtils").echoDecodeIntField(a,h);var k=h.result;h=h.success;if(h&&k!=null)b[j]=k;else if(!(b.xAttachmentType!=null&&!Z(i,b.xAttachmentType)||b.attachmentType===R.XMA)){d("WALogger").ERROR(m(),j,b.xAttachmentType,b.attachmentType,e);return!1}}c.map(function(f){var c=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var e=f.result;f=f.success;f&&e!=null&&(b[c]=e)});return!0}function X(a,b,c,e,f){var g,h,i;g=(g=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?g:"";var j=[{fieldName:"filename",id:P}];e!=null&&f!=null?(b.attachmentObjectId=e,h=[{fieldName:"plaintextHash",id:e+"-"+O},{fieldName:"directPath",id:e+"-"+E},{fieldName:"xContentType",id:e+"-"+D}],j.push({fieldName:"mediaKey",id:e+"-"+G}),i=f+"-"+B,e=e+"-"+z):(h=[{fieldName:"attachmentObjectId",id:v},{fieldName:"plaintextHash",id:O},{fieldName:"directPath",id:E},{fieldName:"xContentType",id:D}],j.push({fieldName:"mediaKey",id:G}),i=B,e=z);j.push({fieldName:"backupEntFbid",id:i});j.push({fieldName:"mediaContentType",id:y});j.push({fieldName:"encryptedHash",id:e});i=f!=null?f+"-"+C:C;j.push({fieldName:"mediaBackupStatus",id:i});e=[];for(f=h,i=Array.isArray(f),h=0,f=i?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var m;if(i){if(h>=f.length)break;m=f[h++]}else{h=f.next();if(h.done)break;m=h.value}m=m;var n=m.fieldName;m=m.id;m=d("EchoDecodingUtils").echoDecodeStringField(a,m);var o=m.result;m=m.success;m&&o!=null?b[n]=o:e.push(n)}if(e.length>0){m=e.join(", ");c===d("EchoMessage").EchoMessageContentType.XMA?d("WALogger").WARN(l(),m,b.attachmentType,g):d("WALogger").ERROR(k(),m,b.attachmentType,g);return!1}j.map(function(f){var c=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeStringField(a,f);var e=f.result;f=f.success;f&&e!=null&&(b[c]=e)});return!0}function Y(a,b,c){var e;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";var f=d("EchoDecodingUtils").echoDecodeStringField(a,x);f=f.result==="file"?R.DOCUMENT:R.cast(f.result);f!=null&&(b.attachmentType=f);var g=d("EchoDecodingUtils").echoDecodeStringField(a,K);g=S.cast(g.result);g!=null&&(b.previewContentType=g);var h=d("EchoDecodingUtils").echoDecodeStringField(a,Q);h=h.result;h!=null&&(b.headerAttributionContentType=h);h=d("EchoDecodingUtils").echoDecodeStringField(a,c!=null?c+"-"+A:A);h.success&&h.result!=null&&(a=ba(h.result),a!=null&&(b.xAttachmentType=a));if(f!=null&&(g!=null||f===R.DOCUMENT||f===R.PTT))return!0;else d("WALogger").ERROR(j(),f,g,h,e);return!1}function Z(a,b){return a.reduce(function(a,c){return a||c===b},!1)}function aa(a){return a.has(w)}function $(a,b,c){var e=d("EchoDecodingUtils").echoDecodeObjectIdListField(a,w),f=e.result;e=e.success;if(!e||f==null||f.length!==2){d("WALogger").ERROR(i(),f,b,c);return null}e=f.find(function(b){b=b+"-"+C;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null)return!0});if(e!=null){b=e===f[0]?f[1]:f[0];return[e,b]}e=f.find(function(b){b=b+"-"+D;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null&&U.cast(c)===U.FULL)return!0});if(e!=null){c=e===f[0]?f[1]:f[0];return[e,c]}return f}function ba(a){var b=T.cast(a);b==null&&d("WALogger").ERROR(h(),a);return(a=b)!=null?a:T.INVALID}g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=v;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=w;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=x;g.AttachmentType=R;g.EchoMessageMediaPreviewType=S;g.EchoMessageActMediaAttachmentType=T;g.convertMediaMetadataDetailsToMediaMetadata=V;g.echoMessageSetMediaMetadataFields=a;g.echoMessageDecodeMediaDataFields=c;g.setMediaIntFields=W;g.setMediaEnumFields=Y;g.getAttachmentObjectIdsFromMultiBlobMediaMsg=$}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b.groupId!=null&&d("EchoEncodingUtils").echoSetStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,b.groupId),b.groupIndex!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,b.groupIndex),b.groupSize!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,b.groupSize)}function b(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);c.success&&c.result!=null&&(b.groupId=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);c.success&&c.result!=null&&(b.groupIndex=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);c.success&&c.result!=null&&(b.groupSize=c.result)}g.echoMessageSetMediaGroupFields=a;g.decodeMessageMediaGroupFields=b}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(a,b,c,d,e,f,g){"use strict";var h="Reply-Message-Id",i="Reply-Message-Sender",j="Reply-Sort-Order",k="Reply-Type",l="Reply-Status",m=b("$InternalEnum").Mirrored(["BUMP"]),n=b("$InternalEnum")({VALID:"valid"});function a(a){var b={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},c=o(a,b),d=p(a,b),e=q(a,b);a=r(a,b);return!c||!d||!e||!a?null:b}function c(a,b){b=b.quoteData;if(b==null)return;d("EchoEncodingUtils").echoSetStringField(a,h,b.quoteMessageId);d("EchoEncodingUtils").echoSetAddressField(a,i,b.quoteMessageSender);d("EchoEncodingUtils").echoSetIntField(a,j,b.quoteSortOrderInMs);b.status!=null&&d("EchoEncodingUtils").echoSetStringField(a,l,b.status);b.replyType!=null&&d("EchoEncodingUtils").echoSetStringField(a,k,b.replyType)}function o(a,b){var c=[{fieldName:"quoteMessageSender",id:i}];for(var e=0;e<c.length;e++){var f=c[e],g=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeAddressField(a,f);var h=f.result;f=f.success;if(f&&h!=null)b[g]=h;else return!1}return!0}function p(a,b){var c=[{fieldName:"quoteMessageId",id:h}];for(var e=0;e<c.length;e++){var f=c[e],g=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeStringField(a,f);var i=f.result;f=f.success;if(f&&i!=null)b[g]=i;else return!1}return!0}function q(a,b){var c=[{fieldName:"quoteSortOrderInMs",id:j}];for(var e=0;e<c.length;e++){var f=c[e],g=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var h=f.result;f=f.success;if(f&&h!=null)b[g]=h;else return!1}return!0}function r(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,k);c=m.cast(c.result);c!=null&&(b.replyType=c);c=d("EchoDecodingUtils").echoDecodeStringField(a,l);a=n.cast(c.result);a!=null&&(b.status=a);return!0}g.EchoMessageQuoteReplyType=m;g.EchoMessageQuoteStatus=n;g.echoMessageDecodeQuoteFields=a;g.echoMessageSetQuoteFields=c}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""]);h=function(){return a};return a}var i="Receipt-Status",j="Receipt-Timestamp",k=b("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function a(a,b){if(b==null||b.length===0)return;b.forEach(function(b){d("EchoEncodingUtils").echoSetStringField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,i),b.status),b.timestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,j),b.timestampMs)})}function c(a){var b=[];l(a).forEach(function(c){var e=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,i);e=d("EchoDecodingUtils").echoDecodeStringField(a,e);if(e.success){e=(e=k.cast(e.result))!=null?e:k.UNKNOWN;var f=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,j);f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,f);f.result!=null?b.push({address:c,status:e,timestampMs:f.result}):b.push({address:c,status:e})}});return b}function l(a){var b=new Set();for(var a=a.keys(),c=Array.isArray(a),e=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(c){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;if(f.includes(i))try{f=f.split("@");var g=f[0];f=m(f[1]);b.add({localKey:g,transportKey:f})}catch(a){d("WALogger").ERROR(h(),a)}}return Array.from(b)}function m(a){a=a.split(i);return a[0].split("-")[0]}g.MessageReceiptStatus=k;g.echoMessageSetReceiptStatusDataFields=a;g.echoMessageDecodeReceiptStatusDataFields=c}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]);k=function(){return a};return a}var l="XMA-Default-CTA",m="XMA-Gating-Type",n="XMA-Header-Subtitle",o="XMA-Header-Title",p="XMA-Is-Tombstoned",q="XMA-Layout-Type",r="XMA-Max-Subtitle-Num-Lines",s="XMA-Max-Title-Num-Lines",t="XMA-Subtitle-Text",u="XMA-Target-Expiry",v="XMA-Target-ID",w="XMA-Target-Type",x="XMA-Target-Username",y="XMA-Title-Text",z="XMA-Content-Ref",A=b("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT"]),B=b("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT"]),C=b("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function a(a,b){b.xmaLayoutType!=null&&d("EchoEncodingUtils").echoSetStringField(a,q,b.xmaLayoutType),b.xmaTargetType!=null&&d("EchoEncodingUtils").echoSetStringField(a,w,b.xmaTargetType),d("EchoEncodingUtils").echoSetStringField(a,x,b.xmaTargetUsername),d("EchoEncodingUtils").echoSetStringField(a,v,b.xmaTargetId),b.xmaTargetExpiry!=null&&d("EchoEncodingUtils").echoSetIntField(a,u,b.xmaTargetExpiry),d("EchoEncodingUtils").echoSetStringField(a,l,b.xmaDefaultCTA),d("EchoEncodingUtils").echoSetStringField(a,o,b.xmaHeaderTitle),d("EchoEncodingUtils").echoSetStringField(a,n,b.xmaHeaderSubtitle),d("EchoEncodingUtils").echoSetStringField(a,y,b.xmaTitleText),d("EchoEncodingUtils").echoSetStringField(a,t,b.xmaSubtitleText),b.xmaMaxTitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,s,b.xmaMaxTitleNumLines),b.xmaMaxSubtitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,r,b.xmaMaxSubtitleNumLines),b.xmaGatingType!=null&&d("EchoEncodingUtils").echoSetStringField(a,m,b.xmaGatingType),d("EchoEncodingUtils").echoSetBooleanField(a,p,b.xmaIsTombstoned),b.xmaContentRef!=null&&d("EchoEncodingUtils").echoSetStringField(a,z,b.xmaContentRef)}function c(a){var b=F(a,p);if(b==null){d("WALogger").ERROR(k());return null}var c=C.cast(d("EchoDecodingUtils").echoDecodeStringField(a,m).result),e=A.cast(d("EchoDecodingUtils").echoDecodeStringField(a,q).result),f=B.cast(d("EchoDecodingUtils").echoDecodeStringField(a,w).result);return{xmaContentRef:D(a,z),xmaDefaultCTA:D(a,l),xmaGatingType:c,xmaHeaderSubtitle:D(a,n),xmaHeaderTitle:D(a,o),xmaIsTombstoned:b,xmaLayoutType:e,xmaMaxSubtitleNumLines:E(a,r),xmaMaxTitleNumLines:E(a,s),xmaSubtitleText:D(a,t),xmaTargetExpiry:E(a,u),xmaTargetId:D(a,v),xmaTargetType:f,xmaTargetUsername:D(a,x),xmaTitleText:D(a,y)}}function D(a,b){a=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(j(),b)}function E(a,b){a=d("EchoDecodingUtils").echoDecodeIntField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(i(),b)}function F(a,b){a=d("EchoDecodingUtils").echoDecodeBooleanField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(h(),b)}g.XMALayoutType=A;g.XMAContentType=B;g.XMAGatingType=C;g.echoMessageSetXMAFields=a;g.decodeXMAFields=c}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum")({MSGR:"msgr",IGD:"igd"});c=a;f["default"]=c}),66);
__d("LSEBPayloadSerializerError",[],(function(a,b,c,d,e,f){a=Object.freeze({INVALID_BACKUP_OPERATION:-7,INVALID_CONTENT_TYPE:-6,INVALID_PAYLOAD_FORMAT:-5,CQL_DB_ERROR:-4,REQUIRED_COLUMN_NOT_PRESENT_ON_CLIENT:-3,DEPRECATED_SPROC:-2,UNKNOWN_ERROR:-1,NOT_AN_ERROR:0,BACKUP_NOT_FOUND:1,REQUIRED_TABLE_NOT_FOUND:2,NATIVE_OP_NOT_FOUND:3,BACKUP_UPLOAD_KILLSWITCHED:4,TASK_ID_NOT_FOUND:5,NOT_IMPLEMENTED:6,NOT_SUPPORTED_ON_WEB:7,DUPLICATE_TASK:8,CLIENT_STATE_NOT_LOADED:9,RECOVERY_CODE_NOT_FOUND:10,EPOCH_KEYS_NOT_FOUND:11,DEVICE_PAYLOAD_NOT_CREATED:12,NULL_DEVICE_PAYLOAD:13,EPOCH_PAYLOAD_NOT_CREATED:14,NULL_EPOCH_PAYLOAD:15,VIRTUAL_DEVICE_PAYLOAD_NOT_CREATED:16,NULL_VIRTUAL_DEVICE_PAYLOAD:17,DEVICE_METADATA_NOT_FOUND:18,NO_MATCHING_DEVICE_PUBLIC_KEY:19,NULL_MAILBOX_ROOT_KEY:20,NULL_ENCRYPTION_VERSION:21,NULL_OCMF_KEY:22,NULL_EPOCH_KEYS:23,NULL_DEVICE_ID:24,OPE_KEY_DERIVATION_FAILED:25,MESSAGE_KEY_DERIVATION_FAILED:26,NULL_MAILBOX_ROOT_KEY_V2:27,ECHO_DOCUMENT_ENCODING_FAILED:30,ECHO_PAYLOAD_CREATION_DISABLED:31,MESSAGE_PAYLOAD_ENCRYPTION_FAILED:40,SERVER_THREAD_ID_NOT_FOUND_FOR_JID:52,UNKNOWN_PROTOBUF_TYPE:60,SUPPLEMENTARY_DATA_KEY_UNEXPECTED:61,PROTOBUF_ENCRYPTION_FAILED:62,PROTOBUF_NOT_FOUND_IN_TOPLEVEL_TABLE:63,PROTOBUF_NOT_FOUND_IN_SUPPLEMENTAL_TABLE:64,SUPPLEMENTAL_KEY_NOT_SET_IN_CONTEXT_TABLE:65,SUPPLEMENTAL_ENCRYPTION_FAILED:66,PROTOBUF_CONTEXT_ROW_NOT_FOUND:67,PROTOBUF_FORMATTING_FAILED:68,SUPPLEMENTAL_FORMATTING_FAILED:69,PROTOBUF_ALREADY_DELETED:70,THREAD_PK_NOT_FOUND_FOR_JID:100,MESSAGE_DECRYPTION_FAILED:101,EPOCH_KEY_FETCH_FAILED:102,TOO_MANY_OPEN_EPOCHS:103,MESSAGE_RANGE_PREPARE_FAILURE:104,ECHO_DOCUMENT_RESTORE_FAILED:105,MISMATCH_POINT_QUERY_MESSAGE_AND_RANGE_LENGTH:106,INITIAL_THREADS_FETCH_FOR_RESTORE_FAILED:107,MISSING_SUPPLEMENTAL_KEY_CIPHERTEXT:108,SUPPLEMENTAL_KEY_DECRYPTION_FAILURE:109,DEVICE_ID_MISMATCH:110,RESTORE_TO_TAM_INFO:111,MISSING_SERVER_THREAD_KEY:112,EB_ADD_DEVICE_FOUND_NO_LOCAL_THREADS:113,EB_MORE_THREADS_IN_MAPPING_TABLE:114,MESSAGE_PK_NOT_FOUND_IN_CLIENT_MESSAGES:200,OTID_NOT_FOUND_IN_ACT_MESSAGES:201,THREAD_ID_NOT_FOUND_IN_ACT_THREADS:202,THREAD_PK_NOT_FOUND_IN_CLIENT_THREADS:203,FAILED_TO_GET_THREAD_SORT_KEY:204,MEDIA_INFO_INVALID:205,REVERB_DB_NOT_ENABLED_FOR_INSTAMADILLO:206,SKIPPED_EB_DISABLED:300,SKIPPED_THREAD_NOT_ELIGIBLE:301,SKIPPED_MESSAGE_NOT_ELIGIBLE:302,NO_EPOCHS_FOUND:400,LATEST_EPOCH_QUERY_BY_ID_FAILED:401,FOUND_EPOCH_WITH_NULL_ROOT_KEY:402,FOUND_EPOCH_WITH_NULL_ANON_ID:403,NO_RECOVERY_CODE:501,NO_ERROR:601,ERROR_GENERAL:602,UNKNOWN:603,ONBOARDING_MATERIAL_DERIVATION_FAILURE:604,NULL_DEVICE_HMAC:605,MISSING_LATEST_EPOCH_AT_ONBOARDING:606,NO_THREADS_TO_COMPARE:701,START_SORT_KEY_FAILURE:702,END_SORT_KEY_FAILURE:703,LOOPING_UPLOAD_PAYLOAD_NOT_FOUND:704,NULL_ECHO_IDENTIFIERS:705,ECHO_TIMESTAMP_CONVERSION_FAILED:706,ECHO_PROTOBUF_THREAD_ID_MISMATCH:707,ECHO_PROTOBUF_TIMESTAMP_MISMATCH:708,ECHO_PROTOBUF_OTID_MISMATCH:709,NULL_ECHO_DOCUMENT:710,INVALID_PROTOBUF_BACKUP_ACTION:711,EMPTY_ENCODED_ECHO_DOCUMENT:712,ECHO_DOCUMENT_ENCODING_UNKNOWN_ENCODING_ERROR:750,ECHO_DOCUMENT_ENCODING_MESSAGE_PK_NOT_FOUND_ERROR:751,ECHO_DOCUMENT_ENCODING_DISK_WRITE_CHECK_FAILED:752,ECHO_DOCUMENT_ENCODING_THREAD_TRANSPORT_ID_FETCH_FAILED:753,ECHO_DOCUMENT_ENCODING_FILE_WRITE_FAILED:754,ECHO_DOCUMENT_ENCODING_DISK_WRITE_DISABLED:755,ECHO_DOCUMENT_ENCODING_SHOULD_NOT_PERSIST:756,MISSING_SUPPLEMENTAL_DATA:757,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REPLY_PROXY_ERROR:758,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_QUERY_ERROR:759,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_ERROR:760,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_RECEIPTS_ERROR:761,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REACTIONS_ERROR:762,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_VISUAL_MESSAGE_ACTIONS_ERROR:763,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_POLLS_ERROR:764});f["default"]=a}),66);
__d("LSQueryBulkUtils",["ReQL"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b){b=await Promise.all(b.map(function(b){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a).getKeyRange(b))}));return b.flat()}async function b(a,b){await Promise.all(b.map(function(b){return a.put(b)}));return b}g.bulkGetByIndex=a;g.bulkPut=b}),98);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return!0},user:function(a){return!1}});return{authoritativeThreadKey:c,cannotReplyReason:a.cannotReplyReason,clientThreadKey:b,description:e,folder:a.folder,isGroup:g,jid:a.jid,lastActivityTs:d("MAWTimeUtils").ensureValidMillisTime(a.snippetMsgTs!=null&&d("WATimeUtils").fromMillisTime(a.snippetMsgTs)!==0?a.snippetMsgTs:f)||d("WATimeUtils").castToMillisTime(0),lastReadTs:d("MAWTimeUtils").ensureValidMillisTime(a.lastReadMsgTs)||d("WATimeUtils").castToMillisTime(0),muteExpireTimeMs:(c=a.muteExpireTimeMs)!=null?c:0}}function b(a,b,c,d){return{lastActivityTimestampMs:c,lastReadWatermarkTs:b,markUnread:d,threadJid:a}}g.createBridgeThread=a;g.createBridgeThreadTimestampsUpdated=b}),98);
__d("MAWBridgeTypesCreators",["I64","MAWDbMsg","MAWImageUtils","MAWMsgType","WAGlobals","WAJids","WAMediaUtils","WATimeUtils","err","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return{threadJid:a}}function i(a){var b,c=a.ts;switch(a.type){case d("MAWMsgType").MSG_TYPE.REVOKED:c=(b=a.originalTs)!=null?b:a.ts;break;default:c=d("MAWDbMsg").getCanonicalTsFromMsg(a)}return{msgId:a.msgId,ts:c}}function b(a,b){b=b.map(i);return{messages:b,threadJid:a}}function e(a){return{ravenMsgId:a.msgId,threadJid:a.threadJid}}function f(a,b){return a.filter(function(a){return b===a.threadJid}).map(function(a){return a.msgId})}function j(a){var b,e=a.chatJid,f=a.filteredMsgIds,g=a.hasMediaForUI,h=a.media,i=a.offlineAttachmentId,j=a.ravenSettings;a=a.sortOrderMs;switch(h.mediaType){case"Image":return{duration:null,ephemeralMediaState:j==null?void 0:j.ephemeralMediaState,ephemeralMediaViewMode:j==null?void 0:j.ephemeralMediaViewMode,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:(b=h.validatedImageInfo)==null?void 0:b.jpegThumbnailHeight,previewHeightLarge:(b=h.validatedImageInfo)==null?void 0:b.height,previewWidth:(b=h.validatedImageInfo)==null?void 0:b.jpegThumbnailWidth,previewWidthLarge:(b=h.validatedImageInfo)==null?void 0:b.width,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Video":return{duration:((b=h.validatedVideoInfo)==null?void 0:b.duration)!=null?((b=h.validatedVideoInfo)==null?void 0:b.duration)*1e3:0,ephemeralMediaState:j==null?void 0:j.ephemeralMediaState,ephemeralMediaViewMode:j==null?void 0:j.ephemeralMediaViewMode,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:(b=h.validatedVideoInfo)==null?void 0:b.jpegThumbnailHeight,previewHeightLarge:(j=h.validatedVideoInfo)==null?void 0:j.height,previewWidth:(b=h.validatedVideoInfo)==null?void 0:b.jpegThumbnailWidth,previewWidthLarge:(j=h.validatedVideoInfo)==null?void 0:j.width,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Ptt":return{duration:((b=h.validatedAudioInfo)==null?void 0:b.duration)?h.validatedAudioInfo.duration*1e3:null,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Gif":return{duration:null,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:h.msgIds,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:(j=h.validatedImageInfo)==null?void 0:j.jpegThumbnailHeight,previewHeightLarge:(b=h.validatedImageInfo)==null?void 0:b.height,previewWidth:(j=h.validatedImageInfo)==null?void 0:j.jpegThumbnailWidth,previewWidthLarge:(b=h.validatedImageInfo)==null?void 0:b.width,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"Sticker":j=d("MAWImageUtils").boundHeightWidth((j=h.validatedImageInfo)==null?void 0:j.jpegThumbnailHeight,(b=h.validatedImageInfo)==null?void 0:b.jpegThumbnailWidth,128);b=j.height;j=j.width;return{duration:null,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:h.msgIds,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:b,previewHeightLarge:b,previewWidth:j,previewWidthLarge:j,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};case"DocumentFile":b={};for(var j=h.mediaEntries,k=Array.isArray(j),l=0,j=k?j:j[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var m;if(k){if(l>=j.length)break;m=j[l++]}else{l=j.next();if(l.done)break;m=l.value}m=m;var n=m[0];m=m[1];m=d("WAMediaUtils").mediaEntryDataToRawData(h.plaintextHash,m);m=m.filename;m!=null&&(b[n]=m)}return{defaultFilename:(n=h.validatedDocumentFileInfo)==null?void 0:n.filename,duration:null,filenames:b,filesize:h.size,hasMedia:g,mediaId:h.mediaId,mediaType:h.mediaType,msgIds:f,offlineAttachmentId:i,plaintextHash:h.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:d("WATimeUtils").castToMillisTime(a!=null?a:h.ts*1e3),threadJid:e,ts:d("WATimeUtils").castToUnixTime(a!=null?a/1e3:h.ts)};default:h.mediaType;throw c("err")("[createBridgeMedia] Unsupported media type: "+h.mediaType)}}function k(a,b,c,e,f){return{chatJid:a,deliveredWatermarkTs:(a=c)!=null?a:d("WATimeUtils").castToUnixTime(0),fbid:b,lastReadActionTs:(c=f)!=null?c:d("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:(a=e)!=null?a:d("WATimeUtils").castToUnixTime(0)}}function l(a){var b=a.cannotReplyReason,c=a.folder,d=a.muteExpireTimeMs,e=a.snippetParams,f=a.snippetSenderContactId,g=a.snippetType;a=a.threadJid;return{cannotReplyReason:b,folder:c,muteExpireTimeMs:d,snippetContactIDs:e==null?void 0:e.contactIDs,snippetMentionJIDs:e==null?void 0:e.mentionJIDs,snippetParams:e==null?void 0:e.strings,snippetSenderContactId:f,snippetType:g,threadJid:a}}function m(a){return{chatJid:a.groupJid,memberAddMode:a.memberAddMode,threadName:a.name}}function n(a,b,c,e,f,g,i,j){return{description:i,lastActivityTs:b,lastMsgExternalId:j!==void 0?(h||(h=d("I64"))).of_string_opt(j):void 0,lastReadTs:(i=c)!=null?i:d("WATimeUtils").castToMillisTime(0),snippetContactIDs:f.contactIDs,snippetMentionJIDs:(b=f.mentionJIDs)!=null?b:[],snippetParams:f.strings,snippetSenderContactId:g,snippetType:e,threadJid:a}}function o(a){var b=a.bumpTimestampMs,c=a.description,d=a.isMessageAuthorMe,e=a.skipBumpTimestampValidation,f=a.skipServerThreadBump,g=a.snippetParams,h=a.snippetSenderContactId,i=a.snippetType;a=a.threadJid;return{bumpTimestampMs:b,description:c,isMessageAuthorMe:d,skipBumpTimestampValidation:(b=e)!=null?b:!1,skipServerThreadBump:(c=f)!=null?c:!1,snippetContactIDs:g.contactIDs,snippetMentionJIDs:(d=g.mentionJIDs)!=null?d:[],snippetParams:g.strings,snippetSenderContactId:h,snippetType:i,threadJid:a}}function p(a){var b;if(c("gkx")("239"))return 0;return!c("justknobx")._("2319")?d("MAWDbMsg").getOriginalTsFromMsg(a)*1e3:(b=a.sortOrderMs)!=null?b:d("MAWDbMsg").getOriginalTsFromMsg(a)*1e3}function q(a,b,d,e,f,g){g===void 0&&(g="before");b=b;if(b.length===0)return{chatJid:a,rangeExtensionType:null};if(d)return{chatJid:a,rangeExtensionType:{hasMoreBefore:e,maxMsgId:b[0].msgId,minMsgId:b[b.length-1].msgId,minMsgTs:p(b[b.length-1]),rangeKind:"initial"}};return c("gkx")("23927")?{chatJid:a,rangeExtensionType:{hasMoreAfter:f,hasMoreBefore:e,maxMsgId:b[0].msgId,maxMsgTs:p(b[0]),minMsgId:b[b.length-1].msgId,minMsgTs:p(b[b.length-1]),rangeKind:g==="before"?"before":"after"}}:{chatJid:a,rangeExtensionType:{hasMoreBefore:e,minMsgId:b[b.length-1].msgId,minMsgTs:p(b[b.length-1]),rangeKind:"extensionBefore"}}}function r(a){var b=d("WAJids").extractDeviceIDParts(d("WAGlobals").getMyDeviceJid()).userId,c=a.author,e=a.chatJid,f=a.reaction,g=a.reactToMsgId;a=a.ts;return{actorId:d("WAJids").authorToUserId(c,b),chatJid:e,messageId:g,reaction:f,ts:a}}function s(a){var b=a.newestMsgId,c=a.newestMsgTs,e=a.oldestMsgId;a=a.thread;return{hasMoreAfter:!1,hasMoreBefore:!1,maxMsgId:b,maxMsgTs:c,minMsgId:e,minMsgTs:d("WATimeUtils").castToMillisTime(0),threadJid:a.jid}}function t(a){var b=d("WAJids").extractDeviceIDParts(d("WAGlobals").getMyDeviceJid()).userId,c=a.author,e=a.chatJid;a=a.reactToMsgId;return{actorId:d("WAJids").authorToUserId(c,b),chatJid:e,messageId:a}}function u(a){return{creationTs:a.creationTs,creator:a.creator,groupJid:a.groupJid,msgExpiration:a.msgExpiration,name:a.name,nameOwner:a.nameOwner,nameTs:a.nameTs,participantVersion:a.participantVersion}}function v(a){var b=a.threadJid,c=a.inviteeJid;return{caption:a.caption,inviteCode:a.inviteCode,inviteeId:c,inviteExpireTs:a.inviteExpirationTs,inviterId:d("WAJids").extractUserId(a.inviterJid),threadJid:b}}function w(a){return{threadJid:a}}function x(a,b,c){return{senderId:d("WAJids").extractUserId(b),state:c,threadJid:a}}g.createBridgeUpdateE2EEMetadataParticipants=a;g.createBridgeDeleteMessages=b;g.createBridgeRavenAction=e;g.getMsgIdsFilteredByJid=f;g.createBridgeMedia=j;g.createBridgeReceivedReceipt=k;g.createBridgeUpdatedThread=l;g.createBridgeUpdatedGroupInfo=m;g.createBridgeBumpedThread=n;g.createBridgeBumpedThreadV2=o;g.createBridgeMsgsLoadedInfo=q;g.createBridgeUpsertReaction=r;g.createBridgeUpdateMessageRange=s;g.createBridgeDeleteReaction=t;g.createBridgeGroupInfo=u;g.createBridgeGroupInvite=v;g.createBridgeDeleteGroupInvite=w;g.createBridgeReceivedChatState=x}),98);
__d("MAWDbAppMeta",[],(function(a,b,c,d,e,f){"use strict";a={allowSecurityAlert:"allowSecurityAlert",allowSecurityAlertForSelf:"allowSecurityAlertForSelf",deviceJid:"deviceJid",hasMigratedFromDexie:"hasMigratedFromDexie",hmacKey:"hmacKey",hotlikeSticker:"hotlikeSticker",isBackfilledForOccamadillo:"isBackfilledForOccamadillo",msgTypeVersion:"msgTypeVersion",restoreMigrationAttempts:"restoreMigrationAttempts",restoreToDexieMigrationComplete:"restoreToDexieMigrationComplete"};f.AppMetaKeysEnum=a}),66);
__d("MAWDbMsgTypeVersionTxns",["MAWDbAppMeta","MAWDexieTable"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return a.appMeta.get({key:d("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion}).then(function(a){return a==null?void 0:a.value.msgTypeVersion})}function b(a,b){return a.appMeta.add({key:d("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion,value:{msgTypeVersion:b}})}function c(a,b){return a.appMeta.put({key:d("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion,value:{msgTypeVersion:b}})}function e(a,b){return a.appMeta.add({key:d("MAWDbAppMeta").AppMetaKeysEnum.hmacKey,value:{hmacKey:b}})}function f(a){return a.appMeta.get({key:d("MAWDbAppMeta").AppMetaKeysEnum.hmacKey}).then(function(a){return a==null?void 0:a.value.hmacKey})}function i(a,b){return a.appMeta.get({key:b})}function j(a,b){return a.appMeta.put({key:d("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert,value:{allowSecurityAlert:b}}).then(function(){})}function k(a,b){return a.appMeta.put({key:d("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf,value:{allowSecurityAlertForSelf:b}}).then(function(){})}function l(a){return i(a,d("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert).then(function(a){return(a=a==null?void 0:a.value.allowSecurityAlert)!=null?a:!1})}function m(a){return i(a,d("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf).then(function(a){return(a=a==null?void 0:a.value.allowSecurityAlertForSelf)!=null?a:!0})}function n(a,b){return a.appMeta.add({key:d("MAWDbAppMeta").AppMetaKeysEnum.hotlikeSticker,value:{hotlikeSticker:b}})}function o(a){return d("MAWDexieTable").dexieAll([m(a),l(a)]).then(function(a){var b=a[0];a=a[1];return{allowSecurityAlertForContact:a,allowSecurityAlertForSelf:b}})}g.MSG_TYPE_VERSION=(h=d("MAWDbAppMeta")).AppMetaKeysEnum.msgTypeVersion;g.ALLOW_SECURITY_ALERT_FOR_CONTACT=h.AppMetaKeysEnum.allowSecurityAlert;g.ALLOW_SECURITY_ALERT_FOR_SELF=h.AppMetaKeysEnum.allowSecurityAlertForSelf;g.HOT_LIKE=h.AppMetaKeysEnum.hotlikeSticker;g.getMsgTypeVersion=a;g.addMsgTypeVersion=b;g.updateMsgTypeVersion=c;g.addHMACKey=e;g.getHMACKey=f;g.getAppMetaValue=i;g.updateSecurityAlertValueForContact=j;g.updateSecurityAlertValueForSelf=k;g.getSecuritySettingForContact=l;g.getSecuritySettingForSelf=m;g.addHotLike=n;g.maybeBulkGetSecuritySetting=o}),98);
__d("MAWHMACKey",["MAWCryptoConsts","MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWKeychainUtil","MAWSubtleCrypto","MAWTransactionMode","WABase64","tweetnacl-auth"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=d("MAWKeychainUtil").getBufferWithRandomValuesFromLength(d("MAWCryptoConsts").HKDF_SEED_LENGTH_IN_BYTES);return i(a).then(function(a){return d("MAWSubtleCrypto").MAWSubtleCrypto.exportKey("raw",a)})}function a(a,b){a=new TextEncoder().encode(a);b=new Uint8Array(b);a=c("tweetnacl-auth")(a,b);return d("WABase64").encodeB64UrlSafe(a)}function b(){return h().then(function(a){return d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READWRITE},"generateAndInsertHMACKey",function(b){return function(){return d("MAWDbMsgTypeVersionTxns").getHMACKey(b).then(function(c){return c!=null?c:d("MAWDbMsgTypeVersionTxns").addHMACKey(b,a).then(function(){return a})})}})()})}function i(a){return d("MAWSubtleCrypto").MAWSubtleCrypto.importKey("raw",a,{hash:"SHA-256",name:"HMAC"},!0,["sign"])}g.genHMACKey=h;g.hmacTweetNaCl=a;g.generateAndInsertHMACKey=b}),98);
__d("MAWMediaUtils",["MAWDbMedia","MAWHMACKey","WAGlobals","WAHashUtils","WAMediaUtils","WAMsgType","WATimeUtils","asyncToGeneratorRuntime","err","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b===void 0&&(b="media");switch(a){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return b==="xma-media"?"xma-image":"image";case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return"video";case d("MAWDbMedia").MEDIA_TYPE.PTT:return"ptt";case d("MAWDbMedia").MEDIA_TYPE.GIF:return"gif";case d("MAWDbMedia").MEDIA_TYPE.STICKER:return"sticker";case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return"document";default:throw c("err")("get a wrong media file with type "+a)}}function h(a){try{return d("WAMediaUtils").blobToArrayBuffer(a).then(i)}catch(a){throw c("err")("Got "+a+" when convert the blob to Uint8Array")}}function i(a){return self.crypto.subtle.digest("SHA-256",a).then(function(a){return new Uint8Array(a)})}function e(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield h(a));a=d("WAHashUtils").toPlaintextHash(a);var b=k(a);return[a,b]});return j.apply(this,arguments)}function k(a){var b=d("WAGlobals").getHMACKey();return d("WAHashUtils").toHashedPlaintextHash(d("MAWHMACKey").hmacTweetNaCl(a,b))}function f(a){var b="preview-"+d("WATimeUtils").unixTime().toString()+".jpeg";return l(a,b,"image/jpeg")}function l(a,b,c){return new File([new Blob([new Uint8Array(a)],{type:c})],b,{type:c})}function m(a,b){return a.messages.where("msgId").anyOf(b.msgIds).filter(function(a){return a.type!==d("WAMsgType").REVOKED}).toArray().then(function(a){var e=a.map(function(a){return a.msgId});if(c("qex")._("1113")===!0){a=a.reduce(function(a,b){a[b.msgId]=d("WATimeUtils").castToMillisTime(b.sortOrderMs!=null?b.sortOrderMs:b.ts*1e3);return a},{});return babelHelpers["extends"]({},b,{messagesSortOrderMs:a,msgIds:e})}return babelHelpers["extends"]({},b,{msgIds:e})})}g.getServerMediaTypeFromMediaType=a;g.hashBlob=h;g.hashArrayBuffer=i;g.genBlobHashes=e;g.genHMACPlaintextHash=k;g.convertJpegThumbnailArrayBufferToFile=f;g.getBridgeMediaAnnotatedForDisplay=m}),98);
__d("MAWDbChunkTxns",["MAWMediaUtils","WAErrorMessage","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. Error: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. For hashedPlaintextHash: ",". Error: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk after retry. Error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk for hashedPlaintextHash: ",". Error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Chunk found after retry for hashedPlaintextHash: ",""]);l=function(){return a};return a}var m=d("WATagsLogger").TAGS(["MAWDbChunkTxns"]);b=function a(b,c,e,f,g){g===void 0&&(g=0);var n=d("MAWMediaUtils").genHMACPlaintextHash(c);return b.chunk.where("hashedPlaintextHash").equals(n).first().then(function(o){if(o){g>0&&m.LOG(l(),n);return o}else{var p={blobData:e,hashedPlaintextHash:n,mimetype:f,plaintextHash:c};return b.chunk.add(p).then(function(a){return babelHelpers["extends"]({},p,{chunkId:a})})["catch"](function(l){var o=d("WAErrorMessage").maybeGetMessageFromError(l);if(g>0){m.WARN(k(),n,o);m.ERROR(j(),o);throw l}else{m.WARN(i(),n,o);m.ERROR(h(),o);return a(b,c,e,f,g+1)}})}})};c=function(a,b){return n(a,b).then(function(a){return a!=null})};var n=function(a,b){return a.chunk.where("hashedPlaintextHash").equals(b).first()};e=function(a,b){return a.chunk.where("hashedPlaintextHash").anyOf(b).toArray().then(function(a){return new Map(a.map(function(a){return[a.hashedPlaintextHash,a]}))})};function a(a,b){return a.chunk.bulkGet(b)}f=function(a,b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return a.chunk.get({hashedPlaintextHash:b})};g.getOrCreateMediaChunk=b;g.hasMediaChunk=c;g.maybeGetChunkFromHash=n;g.maybeBulkGetChunksFromHash=e;g.bulkGetChunks=a;g.maybeGetChunkByPlaintextHash=f}),98);
__d("MAWJidUtils",["FBLogger","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){if(d("WAJids").isAuthorSystem(a)||b==null||e==null){c("FBLogger")("messenger_web_devx").warn("Failed to create protocolMsgId with externalId %s for a msg to edit",e);return}return{author:a,chat:b,externalId:e}}function a(a){var b;return h(a.author,a.threadJid,(b=a.externalId)!=null?b:a.editExternalId)}function b(a){return d("WAJids").isAuthorMe(a)?d("WAGlobals").getMyUserJid():a}g.maybeToProtocolMsgId=h;g.toProtocolMsgId=a;g.getAuthorJid=b}),98);
__d("MAWLoadReplyMediaTxns",["MAWDbChunkTxns","MAWDbMedia","MAWDbMsg","MAWDbXMATxns","MAWDexieTable","MAWJidUtils","MAWMediaUtils","MAWMsgType","MAWXMAUtils","WAAssertUnreachable","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media XMA with id ",": ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media with id ",": ",""]);i=function(){return a};return a}function j(a,b,e){if(c("gkx")("2419")&&e!=null){e=d("MAWMediaUtils").genHMACPlaintextHash(e);return a.media.where("hashedPlaintextHash").equals(e).first().then(function(b){return b==null?[void 0,void 0]:d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b.hashedPlaintextHash).then(function(a){return a==null?[void 0,b]:[a,b]})})}else return a.media.get(b).then(function(b){return b==null?[void 0,void 0]:d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b.hashedPlaintextHash).then(function(a){return a==null?[void 0,b]:[a,b]})})}var k=new Set([(e=d("MAWDbMedia")).MEDIA_TYPE.IMAGE,e.MEDIA_TYPE.GIF,e.MEDIA_TYPE.PTT,e.MEDIA_TYPE.STICKER,e.MEDIA_TYPE.VIDEO,e.MEDIA_TYPE.DOCUMENT_FILE]);function l(a){var b;switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.STICKER:b=a.validatedImageInfo;break;case d("MAWDbMedia").MEDIA_TYPE.VIDEO:b=a.validatedVideoInfo;break}a=b||{};var c=a.jpegThumbnailHeight;a=a.jpegThumbnailWidth;return{replyMediaPreviewHeight:c,replyMediaPreviewWidth:a}}function m(a){switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return!0;case d("MAWMsgType").MSG_TYPE.XMA:return d("MAWXMAUtils").isXMAShare(a.xmaMessageType);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("WAMsgType").NOTE_REPLY:return!1;default:return c("WAAssertUnreachable")(a.type)}}function n(a,b,c){return b==null?d("MAWDexieTable").dexieResolve():j(a,b,c).then(function(a){var c=a[0];a=a[1];if(a==null)return d("WAResultOrError").makeError("reply_media_not_found");if(!k.has(a.mediaType))return d("WAResultOrError").makeError("reply_media_type_unknown");var e=l(a),f=e.replyMediaPreviewHeight;e=e.replyMediaPreviewWidth;var g;c!=null&&(g=c.mimetype);return d("WAResultOrError").makeResult({replyMediaId:b,replyMediaPreviewHeight:f,replyMediaPreviewWidth:e,replyMediaUrlMimeType:g,replyPlaintextHash:a.plaintextHash})}).then(function(a){if(a.success!==!0){d("WALogger").ERROR(i(),b,a.error);return}return a.value})}function o(a,b){var c=b.defaultPreviewMediaId;return c==null?d("MAWDexieTable").dexieResolve({replyXMAId:b.xmaId}):j(a,c).then(function(a){var c=a[0];a=a[1];if(c==null||a==null)return d("WAResultOrError").makeError("reply_xma_media_not_found");if(!k.has(a.mediaType))return d("WAResultOrError").makeError("reply_xma_media_type_unknown");a=l(a);var e=a.replyMediaPreviewHeight;a=a.replyMediaPreviewWidth;return d("WAResultOrError").makeResult({replyMediaPreviewHeight:e,replyMediaPreviewWidth:a,replyMediaUrlMimeType:c.mimetype,replyXMAId:b.xmaId})}).then(function(a){if(a.success!==!0){d("WALogger").ERROR(h(),b.xmaId,a.error);return}return a.value})}function a(a,b){var c,e;c=((c=b.quote)==null?void 0:c.content)||{};var f=c.author,g=c.externalId,h=c.mediaId,i=c.plaintextHash;c=c.xmaMessageType;if(((e=b.quote)==null?void 0:e.content)==null||!m((e=b.quote)==null?void 0:e.content))return d("MAWDexieTable").dexieResolve();e=b.threadJid;b=f===d("WAGlobals").getMyUserJid();b=b?d("WAJids").AUTHOR_ME:f;return d("MAWXMAUtils").isXMAShare(c)?p(a,d("MAWJidUtils").maybeToProtocolMsgId(b,e,g)):n(a,h,i)}function p(a,b){return b==null?d("MAWDexieTable").dexieResolve():d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,b).then(function(b){if(b==null||d("MAWXMAUtils").isXMAExpired(b.isTombstoned,b.targetExpiringAtSec))return;return o(a,b)})}function b(a,b){var c=b.author,e=b.externalId,f=b.mediaId,g=b.plaintextHash,h=b.threadJid,i=b.xmaMessageType;i=d("MAWXMAUtils").isXMAShare(i);return!d("MAWDbMsg").isMediaMsg(b)&&!i?d("MAWDexieTable").dexieResolve():i?p(a,d("MAWJidUtils").maybeToProtocolMsgId(c,h,e)):n(a,f,g)}g.MSG_MEDIA_TYPE=k;g.getImageAttributes=l;g.isMediaReplyContent=m;g.getReplyMediaForMsgQuote=a;g.getReplyMediaForMsg=b}),98);
__d("WAMsgMap",[],(function(a,b,c,d,e,f){"use strict";a=function(){function a(a){var b=this;this.$1=new Map();a==null?void 0:a.forEach(function(a){var c=a[0];a=a[1];b.set(c,a)})}var b=a.prototype;b.clear=function(){this.$1.clear()};b["delete"]=function(a){var b;(b=this.$1.get(a.externalId))==null?void 0:(b=b.get(a.author))==null?void 0:b["delete"](a.chat)};b.get=function(a){var b;return(b=this.$1.get(a.externalId))==null?void 0:(b=b.get(a.author))==null?void 0:b.get(a.chat)};b.has=function(a){var b;return(b=(b=this.$1.get(a.externalId))==null?void 0:(b=b.get(a.author))==null?void 0:b.has(a.chat))!=null?b:!1};b.set=function(a,b){var c,d;c=(c=this.$1.get(a.externalId))!=null?c:new Map();this.$1.has(a.externalId)||this.$1.set(a.externalId,c);d=(d=c.get(a.author))!=null?d:new Map();c.has(a.author)||c.set(a.author,d);d.set(a.chat,b);return this};b.keys=function(){var a=[],b=this.$1;for(var c=b.keys(),d=Array.isArray(c),e=0,c=d?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f,g;if(d){if(e>=c.length)break;g=c[e++]}else{e=c.next();if(e.done)break;g=e.value}g=g;f=(f=b.get(g))!=null?f:new Map();for(var h=f.keys(),i=Array.isArray(h),j=0,h=i?h:h[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k,l;if(i){if(j>=h.length)break;l=h[j++]}else{j=h.next();if(j.done)break;l=j.value}l=l;k=(k=f.get(l))!=null?k:new Map();for(var k=k.keys(),m=Array.isArray(k),n=0,k=m?k:k[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var o;if(m){if(n>=k.length)break;o=k[n++]}else{n=k.next();if(n.done)break;o=n.value}o=o;a.push({externalId:g,author:l,chat:o})}}}return a};b.entries=function(){var a=[],b=this.$1;for(var c=b.keys(),d=Array.isArray(c),e=0,c=d?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f,g;if(d){if(e>=c.length)break;g=c[e++]}else{e=c.next();if(e.done)break;g=e.value}g=g;f=(f=b.get(g))!=null?f:new Map();for(var h=f.keys(),i=Array.isArray(h),j=0,h=i?h:h[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k,l;if(i){if(j>=h.length)break;l=h[j++]}else{j=h.next();if(j.done)break;l=j.value}l=l;k=(k=f.get(l))!=null?k:new Map();for(var m=k.keys(),n=Array.isArray(m),o=0,m=n?m:m[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var p;if(n){if(o>=m.length)break;p=m[o++]}else{o=m.next();if(o.done)break;p=o.value}p=p;var q=k.get(p);q!=null&&a.push([{externalId:g,author:l,chat:p},q])}}}return a};b.values=function(){return this.entries().map(function(a){return a[1]})};return a}();f.MsgMap=a}),66);
__d("MAWDbMsgUtil",["WAJids","WALogger","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Invalid author when converting msg array to map"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing jid prevents adding message to array map"]);i=function(){return a};return a}function a(a){return a.reduce(function(a,b){var c=b.threadJid;if(c==null){d("WALogger").ERROR(i());return a}if(b.author==="@system"){d("WALogger").ERROR(h());return a}a.set({author:b.author,chat:c,externalId:b.externalId},b);return a},new(d("WAMsgMap").MsgMap)())}function b(a){return d("WAJids").isAuthorSystem(a.author)||a.threadJid==null?null:{author:a.author,chat:a.threadJid,externalId:a.externalId}}g.convertMsgArrayToMap=a;g.getProtocolMsgIdFromDbMsg=b}),98);
__d("MAWDbUnrenderedMsgTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","WAJids","WALogger","WAMsgMap","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAckForUnrenderedMsg on non existing message"]);j=function(){return a};return a}function a(a,b){var c=b.author,e=b.chat,f=b.externalId;return a.threads.get({jid:e}).then(function(b){return b==null?d("WAResultOrError").makeError("missing_thread_unrendered_msg"):k(a,f,e,c).then(function(a){return a==null?d("WAResultOrError").makeError("missing_unrendered_msg"):d("WAResultOrError").makeResult(a)})})}function b(a,b){var c=b.map(function(a){a=a.externalId;return a});return a.unrenderedMessages.where("externalId").anyOf(c).toArray().then(function(a){var c=d("MAWDbMsgUtil").convertMsgArrayToMap(a),e=new(d("WAMsgMap").MsgMap)();b.forEach(function(a){var b=c.get(a);b!=null&&e.set(a,b)});return e})}function k(a,b,c,d){return a.unrenderedMessages.where("externalId").equals(b).filter(function(a){return a.author===d&&a.threadJid===c}).first()}function l(a,b){return a+"_"+b}function c(a,b){var c=b.map(function(a){a=a.externalId;return a}),e=Array.from(new Set(b.map(function(a){return a.chat})));return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.unrenderedMessages.where("externalId").anyOf(c).toArray()]).then(function(a){var c=a[0];a=a[1];if(a.length===0||c.length===0)return[];var d=new Map();b.forEach(function(a){var b=a.author,c=a.chat;a=a.externalId;var e=d.get(a)||new Set();e.add(l(b,c));d.set(a,e)});return a.filter(function(a){var b=a.author,c=a.externalId;a=a.threadJid;c=d.get(c);return c!=null&&a!=null&&c.has(l(b,a))})})}function e(a,b,c){return m(a,[{ack:c,msgId:b}]).then(function(a){a=a[0];if(a==null){d("WALogger").LOG(j());return null}return a})}function m(a,b){var c=b.map(function(a){return a.msgId}),e=new Map();b.forEach(function(a){return e.set(a.msgId,{ack:a.ack})});return a.unrenderedMessages.where("msgId").anyOf(c).toArray().then(function(b){if(b.length===0)return b;var c=[],f=[];b.forEach(function(a){var b;if(a.author!==d("WAJids").AUTHOR_ME){d("WALogger").ERROR(i());c.push(a);return}if(a.ack>d("MAWAckLevel").ACK.clock){d("WALogger").LOG(h());c.push(a);return}b=(b=e.get(a.msgId))==null?void 0:b.ack;if(b==null)return null;a=babelHelpers["extends"]({},a,{ack:b});b===d("MAWAckLevel").ACK.sent&&delete a.resendCount;f.push(a)});return a.unrenderedMessages.bulkPut(f).then(function(){return[].concat(f,c)})})}function f(a,b){b=b.map(function(b){return a.unrenderedMessages.get({msgId:b})});return d("MAWDexieTable").dexieAll(b)}function n(a,b){return a.unrenderedMessages.where("msgId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").msgIdsInChatUpperBound(b.chatId)).last().then(function(a){a=a==null?0:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.msgId);return a+1})}g.maybeGetUnrenderedMsgByProtocolMsgId=a;g.getUnrenderedMsgMapByProtocolMsgId=b;g.maybeGetUnrenderedMsgByExternalId=k;g.getUnrenderedMsgsByProtocolMsgId=c;g.updateSystemAckForUnrenderedMsg=e;g.bulkUpdateSystemAckForUnrenderedMsgs=m;g.getUnrenderedMsgsByMsgIds=f;g.getNextUnrenderedMsgIdNumberForThread=n}),98);
__d("MAWDbMsgTxns",["MAWAckLevel","MAWBridgeMsg","MAWDbMsg","MAWDbMsgUtil","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWMsgType","MAWSharedMsgIdUtil","MAWUpdateThreadMsgMetadataApi","Random","WAJids","WALogger","WAMsgMap","WAResultOrError","WATimeUtils","err","gkx","justknobx","promiseDone","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfull deleted "," messages"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Replacing mediaId for message with pre-existing media. type=",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["getFutureproofMsg gets a message "," with unsupported type ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMsgsFromOffset() newest msg thread jid is not equal to thread jid.\n            msg.threadJid: ",",\n            thread.jid: ",",\n            thread.chatId: ",",\n            offsetMsgId: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMsgsFromOffset, fetched msgs length: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["getMsgsFromOffset input: offsetMsgId: ",", numMsgs: ",", includeOffset: ",", includeExpired: ",", direction: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAck on non existing message"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByExternalId] Found "," messages with external id ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Suspected multiple instances of same message!"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Can't have "," messages with the same protocolMsgId!"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[CacheDiscrepancy] Thread "," has a discrepancy between the cached and uncached values for field: ",". Cached value: ",", uncached value: ",".\n        Cached msgType: ",", uncached msgType: ",".\n        Cached ts: ",", uncached sortOrderMs: ","."]);v=function(){return a};return a}function w(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.messages.get({msgId:b})}function a(a,b){var c="newestMsg",e=E("query_by_sortOrderMs",c),f=e.isCacheBypassed;e=e.isLoggingExpected;var g=b.newestMsg==null;a=a.messages.where("threadJid").equals(b.jid).count().then(function(a){return a===0});e&&y(b,c,g,a);return f?a:d("MAWDexieTable").dexieResolve(g)}function x(a,b,c,e,f,g){d("WALogger").LOG(v(),a.jid,b,c,e,f==null?void 0:f.type,g==null?void 0:g.type,a.newestMsgTs,g==null?void 0:g.sortOrderMs)}function y(a,b,c,d){return d.then(function(d){if(c===d)return;x(a,b,c,d,null,null)})}function z(a,b,c,e){return d("MAWDexieTable").dexieAll([c,e]).then(function(c){var d=c[0];c=c[1];if((d==null?void 0:d.msgId)===(c==null?void 0:c.msgId))return;x(a,b,d==null?void 0:d.msgId,c==null?void 0:c.msgId,d,c)})}function A(a,b,c,e,f){return f.then(function(f){if(e===f)return;return d("MAWDexieTable").dexieAll([w(a,e),w(a,f)]).then(function(a){var d=a[0];a=a[1];x(b,c,e,f,d,a)})})}function B(a,b,c,e){return e.then(function(e){if(e==null&&c==null||e===d("WATimeUtils").castToMillisTime(0)||e!=null&&c!=null&&Math.floor(e/1e3)===c/1e3)return;x(a,b,c,e,null,null)})}function C(a,b){if(b)switch(a){case"newestMsg":return c("qex")._("961")===!0;case"newestMsgTs":return c("qex")._("962")===!0}else switch(a){case"newestMsg":return c("qex")._("928")===!0;case"newestMsgTs":return c("qex")._("944")===!0}}function D(a){switch(a){case"newestMsg":case"newestMsgTs":return d("Random").coinflip(c("justknobx")._("2537"))}}function E(a,b){var c=D(b),d=!1;switch(a){case"defer_to_qe":d=C(b,c);break;case"query_by_sortOrderMs":d=!0;break;case"use_cached_fields":d=!1;break}return{isCacheBypassed:d,isLoggingExpected:c}}function F(a,b,c,d){return a.messages.where(["threadJid","sortOrderMs"]).between([b,Number.MIN_SAFE_INTEGER],[b,Number.MAX_SAFE_INTEGER],c,d)}function G(a,b){return F(a,b,!1,!1).last()}function b(a,b,c){c===void 0&&(c="query_by_sortOrderMs");var d="newestMsg";c=E(c,d);var e=c.isCacheBypassed;c=c.isLoggingExpected;var f=w(a,b.newestMsg);a=G(a,b.jid).then(function(a){return a});c&&z(b,d,f,a);return e?a:f}function e(a,b,c){c===void 0&&(c="query_by_sortOrderMs");var e="newestMsg";c=E(c,e);var f=c.isCacheBypassed;c=c.isLoggingExpected;var g=b.newestMsg,h=G(a,b.jid).then(function(a){return a==null?void 0:a.msgId});c&&A(a,b,e,g,h);return f?h:d("MAWDexieTable").dexieResolve(g)}function f(a,b,c){c===void 0&&(c="defer_to_qe");var e="newestMsgTs";c=E(c,e);var f=c.isCacheBypassed;c=c.isLoggingExpected;var g=b.newestMsgTs;a=G(a,b.jid).then(function(a){return(a==null?void 0:a.sortOrderMs)==null?null:d("WATimeUtils").castToMillisTime(a.sortOrderMs)});c&&B(b,e,g,a);return f?a:d("MAWDexieTable").dexieResolve(g)}function H(a,b,c){return F(a,b,!1,!1).reverse().limit(c).toArray()}function I(a,b){return F(a,b,!1,!1).first()}function J(a,b){return I(a,b).then(function(a){return a==null?void 0:a.msgId})}function K(a,b){return a.messages.where("externalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){if(a.length>1){var b=a.map(function(a){var b;return a.type+":"+((b=a.serverTs)!=null?b:0).toString()+":"+((b=a.ts)!=null?b:0).toString()});b=new Set(b).size===1;!b?d("WALogger").ERROR(u(),a.length):d("WALogger").ERROR(t())}return a[0]})}function L(a,b){return a.messages.where("msgId").equals(b).toArray()}function M(a,b){return P(a,b).then(function(a){return a.success?a:a})}function N(a,b){var c=b.map(function(a){a=a.externalId;return a});return a.messages.where("externalId").anyOf(c).toArray().then(function(a){var c=d("MAWDbMsgUtil").convertMsgArrayToMap(a),e=new(d("WAMsgMap").MsgMap)();b.forEach(function(a){var b=c.get(a);b!=null&&e.set(a,b)});return e})}function O(a,b){return a.messages.where("msgId").equals(b).first().then(function(a){return a==null?void 0:a.sortOrderMs})}function P(a,b){var c=b.author,e=b.chat,f=b.externalId;return a.threads.get({jid:e}).then(function(b){return b==null?d("WAResultOrError").makeError("missing_thread_msg"):R(a,f,b.jid,c).then(function(a){return a==null?d("WAResultOrError").makeError("missing_msg"):d("WAResultOrError").makeResult(a)})})}function Q(a,b){var c=b.author,d=b.chat,e=b.externalId;return a.threads.get({jid:d}).then(function(b){if(b==null)return;return a.messages.where("revokedExternalId").equals(e).filter(function(a){return a.author===c&&a.threadJid===b.jid&&a.type==="Revoked"}).first()})}function R(a,b,c,e){return a.messages.where("externalId").equals(b).filter(function(a){return a.author===e&&a.threadJid===c}).toArray().then(function(a){a.length>1&&d("WALogger").ERROR(s(),a.length,b);return a[0]})}function S(a,b,c,e){var f=a.messages.where("revokedExternalId").equals(b).filter(function(a){return a.author===e&&a.threadJid===c&&a.type===d("MAWMsgType").MSG_TYPE.REVOKED}).first();a=d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByExternalId(a,b,c,e).then(function(a){if((a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return a});return d("MAWDexieTable").dexieAll([f,a]).then(function(a){var b=a[0];a=a[1];return b!=null||a!=null})}function T(a,b){var c=new Array(b.length),e=new Set();b.forEach(function(a){c.push(a.externalId),e.add(d("MAWSharedMsgIdUtil").convertWAMsgIdToStringId(a))});return a.messages.where("externalId").anyOf(c).filter(function(a){return e.has(d("MAWSharedMsgIdUtil").convertWAMsgIdToStringId({author:a.author,chat:a.threadJid,externalId:a.externalId}))}).toArray()}function U(a,b,c,e,f){return V(a,[{ack:c,msgId:b,reportingMeta:f,serverTs:e}]).then(function(a){a=a.find(function(a){return a.msgId===b});if(a==null){d("WALogger").LOG(r());return null}return a})}function V(a,b){var c=b.map(function(a){return a.msgId});return d("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(a,c).then(function(e){var f=new Map();b.forEach(function(a){f.set(a.msgId,{ack:a.ack,reportingMeta:a.reportingMeta,serverTs:a.serverTs});var b=e.get(a.msgId);b!=null&&f.set(b,{ack:a.ack,reportingMeta:a.reportingMeta,serverTs:a.serverTs})});var g=Array.from(new Set(c.concat(Array.from(e.values()))));return a.messages.where("msgId").anyOf(g).toArray().then(function(b){if(b.length===0)return b;var c=[],e=[];b.forEach(function(a){var b,g;if(a.author!==d("WAJids").AUTHOR_ME){d("WALogger").ERROR(q());c.push(a);return}if(a.ack>d("MAWAckLevel").ACK.clock){d("WALogger").LOG(p());c.push(a);return}b=(b=f.get(a.msgId))==null?void 0:b.ack;g=(g=f.get(a.msgId))==null?void 0:g.serverTs;if(b==null)return null;var h=babelHelpers["extends"]({},a,{ack:b});g!=null&&(h.serverTs=g);a=(g=f.get(a.msgId))==null?void 0:g.reportingMeta;a!=null&&(h.reportingMeta=a);b===d("MAWAckLevel").ACK.sent&&delete h.resendCount;e.push(h)});return a.messages.bulkPut(e).then(function(){return d("MAWDexieTable").dexieAll(e.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)}))}).then(function(a){e.forEach(function(b,c){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a[c])})});return[].concat(e,c)})})})}function aa(a,b,c,e){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success||e==null||b.value.oldestMsg!==c&&b.value.newestMsg!==c)return;var f=b.value;b=[a.messages.where(["threadJid","sortOrderMs"]).above([f.jid,e]).first(),a.messages.where(["threadJid","sortOrderMs"]).below([f.jid,e]).last()];return d("MAWDexieTable").dexieAll(b).then(function(b){var e=b[0];b=b[1];return d("MAWDbThreadTxns").updateThread(a,babelHelpers["extends"]({},f,{newestMsg:f.newestMsg===c?b==null?void 0:b.msgId:f.newestMsg,newestMsgTs:f.newestMsg===c?(b==null?void 0:b.ts)==null?null:d("WATimeUtils").castUnixTimeToMillisTime(b.ts):f.newestMsgTs,oldestMsg:f.oldestMsg===c?e==null?void 0:e.msgId:f.oldestMsg})).then(function(){})})})}function ba(a,b,e,f,g){if(b===(e==null?void 0:e.msgId)&&f===(g==null?void 0:g.msgId))return d("MAWDexieTable").dexieResolve();d("MAWIndexedDb").afterTransactionEffect(function(){c("promiseDone")(c("MAWUpdateThreadMsgMetadataApi")(a,b,e,f,g))})}function ca(a,b,e,f,g,h,i){g===void 0&&(g=!1);h===void 0&&(h=!1);i===void 0&&(i="before");return f===0?d("MAWDexieTable").dexieResolve({hasMoreAfter:!1,hasMoreBefore:!1,msgs:[]}):d("MAWDexieTable").dexieAll([a.threads.get({jid:b}),e==null?d("MAWDexieTable").dexieResolve(null):a.messages.get({msgId:e})]).then(function(b){var j=b[0],k=b[1],l=j==null?void 0:j.oldestMsg,p=j==null?void 0:j.newestMsg;if(j==null||e!=null&&k==null)return{hasMoreAfter:!1,hasMoreBefore:!1,msgs:[]};var q=h?function(a){return!0}:function(a){return a.messageExpirationTs==null||a.messageExpirationTs>d("WATimeUtils").unixTime()};b=d("MAWDexieTable").dexieResolve([]);f===1&&g&&k!=null&&(b=d("MAWDexieTable").dexieResolve([k].filter(q)));d("WALogger").LOG(o(),k==null?void 0:k.msgId,f,g,h,i);return b.then(function(b){b=b.length>0?d("MAWDexieTable").dexieResolve(b):na(a,j.jid,k,g,f,q,i);var h=c("gkx")("23927");return d("MAWDexieTable").dexieAll([b,G(a,j.jid),I(a,j.jid)]).then(function(a){var b=a[0],c=a[1];a=a[2];ba(j,l,a,p,c);d("WALogger").LOG(n(),b.length);if(b.length===0)return{hasMoreAfter:!1,hasMoreBefore:!1,msgs:[]};var g=b[b.length-1],i=b[0];g=h?g.msgId!==(a==null?void 0:a.msgId):g.msgId!==(a==null?void 0:a.msgId)&&b.length===f;a=h?i.msgId!==(c==null?void 0:c.msgId):!1;i.threadJid!==j.jid&&d("WALogger").ERROR(m(),i.threadJid,j.jid,j.chatId,e);return{hasMoreAfter:a,hasMoreBefore:g,msgs:b}})})})}function da(a){return a.messages.where("altIndex").equals(d("MAWDbMsg").FUTUREPROOF_ALT_INDEX).toArray().then(function(a){var b=[];a.forEach(function(a){if(a.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF){d("WALogger").ERROR(l(),a.msgId,a.type);return}b.push(a)});return b})}function W(a){return a.toString()}function ea(a,b,c,e){var f=b.mediaId;if(f===c){d("WALogger").LOG(k(),b.msgId,c);return d("MAWDexieTable").dexieResolve()}f=f!=null?a.media.get(f):d("MAWDexieTable").dexieResolve();return f.then(function(f){f&&d("WALogger").ERROR(j(),b.type);f=(f=e)!=null?f:void 0;f=babelHelpers["extends"]({},b,{mediaId:c,plaintextHash:f});return a.messages.put(f).then(function(){})})}function fa(a,b){var e=Array.from(b.keys());return a.messages.where("msgId").anyOf(e).toArray().then(function(e){var f=[];e.map(function(a){var e=b.get(a.msgId),g=a.mediaId;if(g!=null&&g!==e){if(e!=null)throw c("err")("mediaId "+W(g)+" in message "+a.msgId+" is different with the "+W(e)+" in bulkUpdateMediaId");d("WALogger").LOG(i(),a.msgId,e);return}g=babelHelpers["extends"]({},a,{mediaId:e,plaintextHash:a.plaintextHash});f.push(g)});return a.messages.bulkPut(f).then(function(){})})}function ga(a,b){return X(a,[b]).then(function(){})}function X(a,b){return a.messages.where("msgId").anyOf(b).toArray().then(function(b){var c=b.map(function(a){return babelHelpers["extends"]({},a,{isExpiredXmaMsg:!0})});return a.messages.bulkPut(c).then(function(){return c})})}function Y(a,b,c,e){if(e!=null&&e<=0)return d("MAWDexieTable").dexieResolve([]);a=a.messages.where("altIndex").equals(d("MAWDbMsg").craftToBeReadAltIndex(b)).filter(c);e!=null&&(a=a.limit(e));return a.toArray()}function ha(a,b,c,d){return Y(a,b,function(a){return a.msgId<=c},d)}function Z(a,b,c,e){return Y(a,b,function(a){return d("MAWDbMsg").getSortOrderWithFallback(a)<=c},e)}function ia(a,b,c){return Z(a,b,c).then(function(b){var c=b.map(function(a){return babelHelpers["extends"]({altIndex:null},a)});return a.messages.bulkPut(c).then(function(){return c})})}function ja(a,b){return a.messages["delete"](b)}function ka(a,b,c){var e=b.map(function(a){return a.rowId});b=c!=null?b.map(function(a){a=d("MAWJidUtils").toProtocolMsgId(a);if(!a)return;return babelHelpers["extends"]({},a,{reason:c})}).filter(Boolean):[];return d("MAWDexieTable").dexieAll([a.deletedMessages.bulkAdd(b),a.messages.bulkDelete(e)]).then(function(a){a[0];a=a[1];d("WALogger").LOG(h(),a)})}function la(a,b){return a.messages.where("msgId").anyOf(b).toArray()}function ma(a){return a.messages.where("altIndex").anyOf([d("MAWDbMsg").SPAM_ALT_INDEX,d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX]).toArray()}function na(a,b,c,e,f,g,h){h===void 0&&(h="before");c=c==null?null:d("MAWDbMsg").getSortOrderWithFallback(c);if(h==="before"){return a.messages.where(["threadJid","sortOrderMs"]).between([b,Number.MIN_SAFE_INTEGER],[b,(h=c)!=null?h:Number.MAX_SAFE_INTEGER],!0,e).reverse().filter(g).limit(f).toArray()}else{return a.messages.where(["threadJid","sortOrderMs"]).between([b,(h=c)!=null?h:Number.MIN_SAFE_INTEGER],[b,Number.MAX_SAFE_INTEGER],e,!0).filter(g).limit(f).toArray().then(function(a){return a.sort(function(a,b){return b.ts-a.ts})})}}function oa(a,b,c,d){var e=c.msgId;if(a==null&&b==null)return{newestMsg:e,oldestMsg:e};if(d==null){var f;return{newestMsg:e,oldestMsg:(f=a==null?void 0:a.msgId)!=null?f:e}}f=[a,b,c].filter(Boolean);return{newestMsg:f.reduce(function(a,b){return $(b,e,d)>=$(a,e,d)?b:a}).msgId,oldestMsg:f.reduce(function(a,b){return $(a,e,d)<$(b,e,d)?a:b}).msgId}}function $(a,b,c){return a.msgId===b?c:d("MAWDbMsg").getSortOrderWithFallback(a)}function pa(a,b){return a.messages.where("msgId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").msgIdsInChatUpperBound(b.chatId)).last().then(function(a){a=a==null?0:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.msgId);return a+1})}g.maybeGetMsg=w;g.getIsThreadEmpty=a;g.getThreadMessagesBySortOrder=F;g.getThreadNewestMessageBySortOrder=G;g.getThreadNewestMessageBySortOrderOrCache=b;g.getThreadNewestMessageId=e;g.getThreadNewestMessageTs=f;g.getThreadNewestNumMessagesBySortOrder=H;g.getThreadOldestMessageBySortOrder=I;g.getThreadOldestMessageId=J;g.maybeGetMsgByProtocolMsgId=K;g.maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING=L;g.maybeGetMsgResultByProtocolMsgId=M;g.getMsgMapByProtocolMsgId=N;g.getSortOrderFromMsgId=O;g.maybeGetRevokedMsgByProtocolMsgId=Q;g.maybeGetMsgByExternalId=R;g.checkIfMsgIsDeletedForMeOrRevoked=S;g.getMsgsByProtocolMsgId=T;g.updateSystemAck=U;g.bulkUpdateSystemAck=V;g.maybeUpdateThreadMsgsForDeleteForMe=aa;g.getMsgsFromOffset=ca;g.getFutureProofMsgs=da;g.updateMediaId=ea;g.bulkUpdateMediaId=fa;g.updateDbMsgXMAExpiration=ga;g.bulkUpdateDbMsgXMAExpired=X;g.getMsgsNeedingRetroactiveReadReceiptsUpTo__DONOTUSE=ha;g.getMsgsNeedingRetroactiveReadReceiptsUpTo=Z;g.clearRetroactiveReadReceiptStatusFromMsgsUpTo=ia;g.deleteDbMsg=ja;g.deleteMessages=ka;g.getMsgsByMsgIds=la;g.getSpamMsgs=ma;g.calculateOldestAndNewestMsg=oa;g.getNextMsgIdNumberForThread=pa}),98);
__d("MAWDbThreadTxns",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","WAArrayZip","WALogger","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["markCutoverThreadAsNotMigratedLocally failed because thread is already unmigrated"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed because thread is already migrated"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed to get the thread"]);j=function(){return a};return a}function a(a,b){return a.threads.get({deduplicationKey:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function k(a,b){return a.threads.get({jid:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function l(a,b){return a.threads.where("jid").anyOf(b).toArray()}function b(a,b){return a.threads.where("jid").startsWith(b+"@").first().then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function c(a,b){return a.threads.where("jid").equals(b)["delete"]().then(function(){})}function e(a,b){return a.participants.where("userJid").equals(b).toArray().then(function(b){b=b.map(function(a){return a.threadJid});return l(a,b)})}function f(a,b){return a.participants.where("userJid").anyOf(b).toArray().then(function(b){var c=new Map(),d=new Set();b.forEach(function(a){var b,e=a.userJid;b=(b=c.get(e))!=null?b:[];b.push(a.threadJid);c.set(e,b);d.add(a.threadJid)});return l(a,Array.from(d)).then(function(a){var b=a.reduce(function(a,b){a.set(b.jid,b);return a},new Map());return new Map(Array.from(c.entries()).map(function(a){var c=a[0];a=a[1];return[c,a.map(function(a){return b.get(a)}).filter(Boolean)]}))})})}function m(a,b,c){return(b==null?void 0:b.lastReadMsgReceiptSent)==null?d("MAWDexieTable").dexieResolve(!1):d("MAWDbMsgTxns").getSortOrderFromMsgId(a,b.lastReadMsgReceiptSent).then(function(a){return c.sortOrderMs==null||a==null?!1:c.sortOrderMs<=a})}function n(a,b){return a.threads.get({jid:b.threadJid}).then(function(c){return m(a,c,b)})}function o(a,b){return a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(c){return d("MAWDexieTable").dexieAll(d("WAArrayZip").zip(b,c).map(function(b){var c=b[0];b=b[1];return m(a,b,c)}))})}function p(a,b,c){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var e=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{archived:!0,cannotReplyReason:c?"viewer_not_subscribed":a.cannotReplyReason,folder:d("MAWFolderTypes").FOLDER_ID.ARCHIVED})});return a.threads.bulkPut(e).then(function(){e.forEach(function(a){c&&d("WALogger").LOG(["[Occamadillo] Leaving a group thread\n          "+a.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a.cannotReplyReason,folder:d("MAWFolderTypes").FOLDER_ID.ARCHIVED,threadJid:a.jid})})})})})}function q(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var c=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{cannotReplyReason:null})});return a.threads.bulkPut(c).then(function(){c.forEach(function(a){a={cannotReplyReason:null,threadJid:a.jid};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(a)})})})})}function r(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var c=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{archived:!1,cannotReplyReason:a.cannotReplyReason==="viewer_not_subscribed"?a.cannotReplyReason:null,folder:d("MAWFolderTypes").FOLDER_ID.INBOX})});return a.threads.bulkPut(c).then(function(){c.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a.cannotReplyReason,folder:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:a.jid})})})})})}function s(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(b){var c=b.filter(Boolean).map(function(a){return babelHelpers["extends"]({},a,{cannotReplyReason:"viewer_not_subscribed"})});return a.threads.bulkPut(c).then(function(){c.forEach(function(a){var b={cannotReplyReason:"viewer_not_subscribed",threadJid:a.jid};d("WALogger").LOG(["[Occamadillo] User is unsubscribed from thread\n          "+a.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(b)})})})})}function t(a,b){return k(a,b).then(function(b){if(!b.success){d("WALogger").WARN(j());return}b=b.value;if(b.isMigratedLocally===!0){d("WALogger").WARN(i());return}b=babelHelpers["extends"]({},b,{isMigratedLocally:!0});return a.threads.put(b).then(function(){})})}function u(a,b){if(b.isMigratedLocally===!1){d("WALogger").WARN(h());return d("MAWDexieTable").dexieResolve(b)}var c=babelHelpers["extends"]({},b,{isMigratedLocally:!1});return a.threads.put(c).then(function(){return c})}function v(a,b){return a.threads.put(b).then(function(){})}function w(a,b,c,e,f,g){c=c===(e==null?void 0:e.msgId);f=f===(g==null?void 0:g.msgId);return c&&f?d("MAWDexieTable").dexieResolve():v(a,babelHelpers["extends"]({},b,{newestMsg:g==null?void 0:g.msgId,newestMsgTs:f?b.newestMsgTs:(g==null?void 0:g.ts)==null?null:d("WATimeUtils").castUnixTimeToMillisTime(g.ts),oldestMsg:e==null?void 0:e.msgId}))}g.getThreadByDeduplicationKey=a;g.getThread=k;g.getThreads=l;g.getThreadPrimaryId=b;g.deleteThreadRow=c;g.getAllThreadsForUser=e;g.getAllThreadsForUsers=f;g.needsRetroactiveReadReceiptInThread=n;g.bulkNeedsRetroactiveReadReceiptInThread=o;g.archiveThreads=p;g.subscribeToThreads=q;g.unarchiveThreads=r;g.unsubscribeFromThreads=s;g.markCutoverThreadAsMigratedLocally=t;g.markCutoverThreadAsNotMigratedLocally=u;g.updateThread=v;g.updateThreadMsgsForUndefinedOldestOrNewestMsgs=w}),98);
__d("MAWDbMediaTxns",["MAWDbMsg","MAWDexieTable","MAWMediaUtils","MAWMsgType","WALogger","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""]);i=function(){return a};return a}function a(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.media.get({mediaId:b})}function j(a,b){return a.media.where("hashedPlaintextHash").equals(b).first()}function b(a,b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return j(a,b)}function e(a,b){return a.media.where("hashedPlaintextHash").anyOf(b).toArray()}function f(a,b){return b==null?d("MAWDexieTable").dexieResolve():k(a,b).then(function(c){c=c==null?void 0:c.mediaId;return c!=null?a.media.get({mediaId:c}):a.media.get({objectId:b})})}function k(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.mediaBackup.get({objectId:b})}function l(a,b){a=a.mediaBackup.where("objectId").anyOf(b).toArray();return a.then(function(a){return new Map(a.map(function(a){return[a.objectId,a]}))})}function m(a,b){return l(a,b).then(function(b){b=Array.from(b.values()).map(function(a){return a.mediaId});return a.media.bulkGet(b)})}function n(a,b){if(b==null)return d("MAWDexieTable").dexieResolve();a=a.mediaBackup.where("msgId").equals(b).toArray();return a}function o(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.filter(d("MAWDbMsg").isMediaMsg);var e=b.reduce(function(a,b){if(b.mediaId==null){d("WALogger").ERROR(i(),b.msgId);return a}return a.set(b.mediaId,b)},new Map());b=Array.from(e.keys());return r(a,b).then(function(a){var b=[];a.forEach(function(a){if(a==null)throw c("err")("Error missing media");var d=e.get(a.mediaId);if(d==null)throw c("err")("Error missing media");b.push([d,a])});return b})}function p(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.filter(d("MAWDbMsg").isMediaMsg).map(function(a){var b=a.mediaId;if(b==null){d("WALogger").ERROR(h(),a.msgId);throw c("err")("mediaId is missing")}else return b});return r(a,b).then(function(a){var b=[];a.forEach(function(a){a!=null&&b.push(a)});return b})}function q(a,b){if(b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME||d("MAWDbMsg").isMediaMsg(b)){var c=b.mediaId;return c==null?b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult()):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing")):a.media.get(c).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}else return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult())}function r(a,b){return a.media.bulkGet(b)}function s(a,b){var c=b.previewMediaIds!=null?r(a,b.previewMediaIds):d("MAWDexieTable").dexieResolve(),e=b.headerMediaId!=null?a.media.get(b.headerMediaId):d("MAWDexieTable").dexieResolve();a=b.faviconMediaId!=null?a.media.get(b.faviconMediaId):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([c,e,a]).then(function(a){var c=a[0],e=a[1];a=a[2];if(b.headerMediaId!=null&&e==null)return d("WAResultOrError").makeError("missing");if(b.faviconMediaId!=null&&a==null)return d("WAResultOrError").makeError("missing");if(c==null)return d("WAResultOrError").makeError("missing");var f=[];for(var c=c,g=Array.isArray(c),h=0,c=g?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=c.length)break;i=c[h++]}else{h=c.next();if(h.done)break;i=h.value}i=i;if(i==null)return d("WAResultOrError").makeError("missing");else f.push(i)}return d("WAResultOrError").makeResult({favicon:a,header:e,previews:f})})}function t(a,b,c){b=babelHelpers["extends"]({},b,c);return a.media.put(b)}g.maybeGetMediaFromMediaId=a;g.maybeGetMediaFromHashedPlaintextHash=j;g.maybeGetMediaFromPlaintextHash=b;g.maybeBulkGetMediaFromHashedPlaintextHash=e;g.maybeGetMediaFromObjectId=f;g.maybeGetMediaBackupRowFromObjectId=k;g.maybeGetMediaBackupRowsFromObjectIds=l;g.maybeGetBulkMediaFromObjectIds=m;g.maybeGetMediaBackupRowFromMsgId=n;g.getMsgMediaPairFromMsgs=o;g.getMediaFromMsgs=p;g.getAndCheckMediaFromMsg=q;g.bulkGetMedias=r;g.getMediaForXMA=s;g.updateMedia=t}),98);
__d("MAWDbXMATxns",["MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWJidUtils","MAWXMAUtils","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.xma.bulkGet(b)}function b(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.xma.get({xmaId:b})}function h(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.xma.where("associatedMessageId").equals(b).first()}function i(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.xma.where("externalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).first()}function c(a,b){return i(a,b).then(function(b){return b==null?d("WAResultOrError").makeError("missing"):d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").getMediaForXMA(a,b),d("MAWDbMsgTxns").maybeGetMsg(a,b.associatedMessageId)]).then(function(a){var c=a[0];a=a[1];if(!c.success)return d("WAResultOrError").makeError("missing");c=c.value;var e=c.favicon,f=c.header;c=c.previews;return d("WAResultOrError").makeResult({associatedMessage:a,favicon:e,header:f,previews:c,xma:b})})})}function e(a,b){return h(a,b).then(function(b){if(b==null)return;return d("MAWDbMsgTxns").maybeGetMsg(a,b.msgId)})}function f(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.filter(d("MAWDbMsg").isXMAMsg).map(function(a){return d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.externalId)}).filter(Boolean);b=b.map(function(b){return i(a,b)});return d("MAWDexieTable").dexieAll(b).then(function(a){return a.filter(Boolean)})}function j(a,b){return a.xma.where("associatedMessageId").anyOf(b).toArray().then(function(a){a=a.filter(function(a){return a.msgId!=null&&d("MAWXMAUtils").isXMAShare(a.targetType)});return a.reduce(function(a,b){return b.associatedMessageId!=null&&b.msgId!=null?a.set(b.associatedMessageId,b.msgId):a},new Map())})}function k(a,b){return a.xma.where("associatedMessageId").equals(b).first()}function l(a,b){return a.xma.where("associatedMessageId").equals(b).first().then(function(b){if(b==null)return;b=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.externalId);if(b==null)return;return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b)})}function m(a,b){return k(a,b).then(function(b){return b==null?d("WAResultOrError").makeResult():d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").getMediaForXMA(a,b),d("MAWDbMsgTxns").maybeGetMsg(a,b.associatedMessageId)]).then(function(a){var c=a[0];a=a[1];if(!c.success)return d("WAResultOrError").makeError("missing");c=c.value;var e=c.favicon,f=c.header;c=c.previews;return d("WAResultOrError").makeResult({associatedMessage:a,favicon:e,header:f,previews:c,xma:b})})})}function n(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){if(!c.success)return;c=c.value;if(b==null)return d("MAWDexieTable").dexieResolve();c={author:b.author,chat:c.jid,externalId:b.externalId};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c)})}g.bulkGetXMAs=a;g.maybeGetXMAFromXMAId=b;g.maybeGetXMAFromAssociatedMsgId=h;g.maybeGetXMAFromProtocolMsgId=i;g.maybeGetXMAPayloadFromProtocolMsgId=c;g.getDbXMAMsgFromAssociatedMsgId=e;g.getXMAFromMsgs=f;g.getXMAMsgIdsFromAssociatedMsgIds=j;g.maybeGetDbXMAMsgByAssociatedMsgId=l;g.maybeGetXMAPayloadFromAssociatedMsgId=m;g.maybeGetAssociatedXMAMsg=n}),98);
__d("MAWUpdateThreadMsgMetadataApi",["MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["updated oldestMsg from id "," to id "," when oldestMsg is undefined"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["updated newestMsg from id "," to id ",", and newestMsgTs from "," to "," when newestMsg is undefined"]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE},"updateThreadMsgMetadataApiTransactor",function(a){return function(b,c,e,f,g){var j=c===(e==null?void 0:e.msgId),k=f===(g==null?void 0:g.msgId);if(j&&k)return d("MAWDexieTable").dexieResolve();k||d("WALogger").ERROR(i(),f,g==null?void 0:g.msgId,b.newestMsgTs,(g==null?void 0:g.ts)==null?null:d("WATimeUtils").castUnixTimeToMillisTime(g.ts));j||d("WALogger").ERROR(h(),c,e==null?void 0:e.msgId);return d("MAWDbThreadTxns").updateThreadMsgsForUndefinedOldestOrNewestMsgs(a,b,c,e,f,g).then(function(){})}});b=a;g["default"]=b}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a!=null&&b!=null){var c=d("WATimeUtils").fromMillisTime(a),e=d("WATimeUtils").fromMillisTime(b);return d("WATimeUtils").castToMillisTime(Math.max(c,e))}return(c=a)!=null?c:b}function i(a,b){return a.threads.get({jid:b})}function j(a,b){return a.threads.where("jid").anyOf(b).toArray().then(function(a){var c=new Map();for(var a=a,d=Array.isArray(a),e=0,a=d?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(d){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;c.set(f.jid,f)}return b.map(function(a){return c.get(a)})})}function a(a,b){var c=b.deduplicationKey,e=b.jid;c=b.deduplicationKey!=null?a.threads.get({deduplicationKey:c}):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([c,i(a,e)]).then(function(c){var d=c[0];c=c[1];if(d!=null)return{created:!1,thread:d};if(c==null)return l(a,b).then(function(a){return{created:!0,thread:a}});else return o(a,b,c).then(function(a){return{created:!1,thread:a}})})}function b(a,b){var c=b.map(function(a){a=a.deduplicationKey;return a}).filter(function(a){return a!=null});c=a.threads.where("deduplicationKey").anyOf(c).toArray();return d("MAWDexieTable").dexieAll([c,j(a,b.map(function(a){a=a.jid;return a}))]).then(function(c){var e=c[0];c=c[1];var f=new Map();for(var e=e,g=Array.isArray(e),h=0,e=g?e:e[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=e.length)break;i=e[h++]}else{h=e.next();if(h.done)break;i=h.value}i=i;i.deduplicationKey!=null&&f.set(i.deduplicationKey,i)}var j={};i=[];h=[];for(g=c.entries(),e=Array.isArray(g),c=0,g=e?g:g[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var k,l;if(e){if(c>=g.length)break;l=g[c++]}else{c=g.next();if(c.done)break;l=c.value}l=l;var n=l[0];l=l[1];k=(k=b[n])==null?void 0:k.deduplicationKey;if(k!=null){var o=f.get(k);if(o!=null){j[k]={created:!1,thread:o};continue}}l==null?i.push(b[n]):h.push({params:b[n],thread:l})}return d("MAWDexieTable").dexieAll([i.length?m(a,i):d("MAWDexieTable").dexieResolve([]),h.length?p(a,h):d("MAWDexieTable").dexieResolve([])]).then(function(a){var c=a[0];a=a[1];for(var c=c,d=Array.isArray(c),e=0,c=d?c:c[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(d){if(e>=c.length)break;f=c[e++]}else{e=c.next();if(e.done)break;f=e.value}f=f;j[f.jid]={created:!0,thread:f}}for(f=a,e=Array.isArray(f),d=0,f=e?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){if(e){if(d>=f.length)break;c=f[d++]}else{d=f.next();if(d.done)break;c=d.value}a=c;j[a.jid]={created:!1,thread:a}}return b.map(function(a){var b=a.deduplicationKey;a=a.jid;if(b!=null){return(b=j[b])!=null?b:j[a]}return j[a]})})})}function k(a){var b=a.authoritativeThreadKey,c=a.clientThreadKey,e=a.createTs,f=a.deduplicationKey,g=a.folder,h=a.jid;a=a.lastActivityTimestamp;e=(a=(a=a)!=null?a:e)!=null?a:d("WATimeUtils").millisTime();b={authoritativeThreadKey:b!=null?b:void 0,deduplicationKey:f,folder:g!=null?g:d("MAWFolderTypes").FOLDER_ID.INBOX,jid:h,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsg:null,newestMsgTs:e,oldestMsg:null,optimisticThreadKey:(a=c)!=null?a:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(e,h)};return b}function l(a,b){var e=b.authoritativeThreadKey,f=b.description,g=b.skipVerifyThread,h=k(b);return a.threads.add(h).then(function(b){b=babelHelpers["extends"]({},h,{chatId:b});g!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(b,b.optimisticThreadKey,e,f,h.newestMsgTs)});return d("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(a,b)})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error creating thread: "+a.message;throw a})}function m(a,b){var e=b.map(k);return a.threads.bulkAdd(e,{allKeys:!0}).then(function(c){c=c.map(function(a,c){return{data:babelHelpers["extends"]({},e[c],{chatId:a}),params:b[c]}});for(var f=c,g=Array.isArray(f),h=0,f=g?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=f.length)break;i=f[h++]}else{h=f.next();if(h.done)break;i=h.value}i=i;i.params.skipVerifyThread!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(i.data,i.data.optimisticThreadKey,i.params.authoritativeThreadKey,i.params.description)})}return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,c.map(function(a){return a.data}))})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk creating threads: "+a.message;throw a})}function n(a,b,c){var d=b.authoritativeThreadKey,e=b.clientThreadKey,f=b.deduplicationKey,g=b.folder;b=b.lastActivityTimestamp;return babelHelpers["extends"]({},a,{authoritativeThreadKey:(d=d)!=null?d:a.authoritativeThreadKey,cannotReplyReason:g!=null||e!=null?null:a.cannotReplyReason,deduplicationKey:g!=null||e!=null?f:a.deduplicationKey,folder:(d=g)!=null?d:a.folder,newestMsgTs:h(c,b),optimisticThreadKey:(f=e)!=null?f:a.optimisticThreadKey})}function o(a,b,e){var f=b.authoritativeThreadKey,g=b.description,h=b.skipVerifyThread;return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,e).then(function(i){var j=n(e,b,i);return a.threads.update(e.chatId,j).then(function(){var a;h!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(j,j.optimisticThreadKey,f,g,i)});d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(a=j==null?void 0:j.folder)!=null?a:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:j.jid})});return j})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error updating thread: "+a.message;throw a})})}function p(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.params,e=b.thread;return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,e).then(function(a){a=n(e,c,a);return{params:c,thread:a}})})).then(function(b){return a.threads.bulkUpdate(b.map(function(a){a=a.thread;return{changes:a,key:a.chatId}})).then(function(){for(var a=b,c=Array.isArray(a),e=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var f;if(c){if(e>=a.length)break;f=a[e++]}else{e=a.next();if(e.done)break;f=e.value}f=f;var g=f.params,h=g.authoritativeThreadKey,i=g.description;g=g.skipVerifyThread;f=f.thread;g!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(f,f.optimisticThreadKey,h,i)});d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(g=f==null?void 0:f.folder)!=null?g:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:f.jid})})}return b.map(function(a){a=a.thread;return a})})})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk updating threads: "+a.message;throw a})}g.getExistingThread=i;g.bulkGetExistingThread=j;g.getOrCreateThread=a;g.bulkGetOrCreateThread=b;g.createThread=l;g.bulkCreateThread=m;g.updateThread=o;g.bulkUpdateThread=p}),98);
__d("MAWLocalizationUtils",["MAWAckLevel","MAWExternalId","MAWLocalizationType","MAWMsgType","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){return{ack:d("MAWAckLevel").ACK.sent,altIndex:(e=e)!=null?e:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:a,threadJid:b,ts:(e=c)!=null?e:d("WATimeUtils").unixTime(),type:d("MAWMsgType").MSG_TYPE.ADMIN}}function b(a){switch(a){case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_NAMED_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_NAMED_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_NAMED_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SELF_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PROMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_DEMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_PROMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_PROMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SELF_DEMOTED:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_HOTLIKE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_THEME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_PHOTO:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNPINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_HOTLIKE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_THEME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PHOTO:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNPINNED_MESSAGE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PARTICIPANT_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_PARTICIPANT_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_CURRENT_USER_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_PARTICIPANT_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_OWN_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_CURRENT_USER_NICKNAME:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ADMIN_ONLY:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ALL_MEMBERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ADMIN_ONLY:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ALL_MEMBERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ADMIN_ONLY:case d("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ALL_MEMBERS:return!0}return!1}function c(a){switch(a){case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:return!0}return!1}function e(a){switch(a){case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_ADDED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_ADDED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_ADDED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_ADDED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_ADDED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_REMOVED_YOU:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_REMOVED_YOU_AND_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_REMOVED_YOU_AND_MORE_THAN_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_REMOVED_ONE_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_REMOVED_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOW_USER_REMOVED_MORE_THAN_TWO_USER:case d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:return!0}return!1}g.buildUnstoredDbAdminMsg=a;g.isAdminMsgNormalized=b;g.isDeviceChangeAdminMsg=c;g.isParticipantChangeAdminMsg=e}),98);
__d("MAWEphemeralMsgUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){return function(b){return!a.has(b.msgId)&&b.ephemeralMsgDisappeared!==!0}}f.filterNonExpiredMsg=a}),66);
__d("MAWThreadSnippetUtils",["MAWEphemeralMsgUtils","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b;if(a.type===d("MAWMsgType").MSG_TYPE.REVOKED)return!0;if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return!0;b=((b=a.msgContent)==null?void 0:b.adminType)!=null?d("MAWLocalizationUtils").isDeviceChangeAdminMsg(a.msgContent.adminType):!1;if(a.type!==d("MAWMsgType").MSG_TYPE.ADMIN)return!1;a=a.msgContent.adminType;return a===d("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG?!0:b}function a(a,b,c){return a.messages.where("[threadJid+sortOrderMs]").between([b.jid,Number.MIN_SAFE_INTEGER],[b.jid,Number.MAX_SAFE_INTEGER],!1,!1).filter(function(a){return(c==null||d("MAWEphemeralMsgUtils").filterNonExpiredMsg(c)(a))&&!h(a)}).reverse().first()}g.isDbMsgDisabledForThreadSnippet=h;g.findMostRecentSnippetMsgFromThread=a}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWLocalizationType","MAWLocalizationUtils","MAWThreadSnippetUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"]);h=function(){return a};return a}function a(a,b,c){var e=a.ts;e=d("WATimeUtils").castUnixTimeToMillisTime(e);c=d("MAWTimeUtils").ensureValidMillisTime(c)||d("WATimeUtils").castToMillisTime(0);e=e>c?e:c;c=d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(a);return babelHelpers["extends"]({},b,{newestMsg:a.msgId,newestMsgTs:e,oldestMsg:a.msgId,snippetMsg:c?void 0:a.msgId,snippetMsgTs:c?void 0:d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(a)),threadOrder:d("MAWDbThread").craftThreadOrder(e,b.jid)})}function b(a,b){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(h());return}b=b.value;var c=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},b.jid,d("WATimeUtils").castMillisTimeToUnixTime(d("WATimeUtils").millisTime()));return d("MAWWriteMsgTxns").writeMsg(a,c,b).then(function(){})})}function c(a,b){return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,[b]).then(function(a){a=a[0];return a})}function e(a){var b=d("MAWDbMsg").craftE2eeAdminMsgAltIndex(a.chatId);b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},a.jid,d("WATimeUtils").castToUnixTime(0),b);return babelHelpers["extends"]({},b,{msgId:d("MAWDbMsg").craftMsgIdV2(a.chatId,1,b),sortOrderMs:0})}g.getUpdatedThreadForAdminMsg=a;g.writeReachabilityErrorAdminMsg=b;g.writeE2EEThreadDescriptionMsg=c;g.buildE2EEThreadDescriptionMsg=e}),98);
__d("MAWAfterWriteMsgUtil",["ArmadilloDataTraceType","I64","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTypesCreators","MAWCalculateBumpTimestampMs","MAWDbMsg","MAWIndexedDb","MAWLocalizationType","MAWMsgType","MAWXMAUtils","WAJids","WALogger","WATimeUtils","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Skipping local thread bump for threadId: ",", msgType: ",""]);i=function(){return a};return a}function a(a){var b=a.dbMsg,e=a.hasMoreAfter,f=a.hasMoreBefore,g=a.isFirstMsg,k=a.isOldestMsgUpdated,l=a.openMessageOtid,m=a.openMessageParticipantCount,n=a.optimisticMsg,o=a.participantCount,p=a.prevOldestMsg,q=a.quotedReplyAttachmentMeta,r=a.snippet,s=a.updatedThread,t=s.authoritativeThreadKey,u=s.chatId,v=s.jid,w=s.newestMsgTs;s=s.oldestMsg;if(b.altIndex===d("MAWDbMsg").SPAM_ALT_INDEX||b.altIndex===d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX)return;d("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(b,v,d("ArmadilloDataTraceType").armadilloMessageSend,l,g,m,o,t)});d("MAWXMAUtils").isXMAStoryReply(b.xmaMessageType)||d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b,n,q)});l=j(a);l&&d("WALogger").LOG(i(),u,b.type);if(!l&&r!=null&&w!=null){g=r.snippetParams;m=r.snippetSenderContactId;o=r.snippetType;t=d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(b.serverTs!=null?d("WATimeUtils").castUnixTimeToMillisTime(b.serverTs):w,(h||(h=d("I64"))).of_string_opt(b.externalId));d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:t,description:"writeMsgAfterTransaction-"+b.type,isMessageAuthorMe:b.author===d("WAJids").AUTHOR_ME,skipServerThreadBump:!0,snippetParams:g,snippetSenderContactId:m,snippetType:o,threadJid:v})})}if(p==null&&c("qex")._("1210")!==!0){d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(v,[b],!0,(n=f)!=null?n:!1,(q=e)!=null?q:!1)})}k&&s!=null&&d("MAWIndexedDb").afterTransaction({tag:"UpdateMinMessage",value:{minMessageId:s,minTimestampMs:d("MAWDbMsg").getCanonicalTsFromMsg(b)*1e3,threadJid:v}})}function j(a){var b=a.dbMsg;a=a.skipLocalThreadBump;a=a===void 0?!1:a;if(d("MAWXMAUtils").isXMAStoryReply(b.xmaMessageType))return!0;if(c("justknobx")._("2017")&&b.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(b.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||b.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE))return!0;return a?!0:!1}g.writeMsgAfterTransaction=a}),98);
__d("MAWThreadSnippetForAdminOrEphemeralMsg",["MAWAdminMsgNormalized","MAWLocalizationUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=a.msgContent.adminType;a=d("MAWLocalizationUtils").isAdminMsgNormalized(c)?d("MAWAdminMsgNormalized").deconstructContactIdsFromAdminContent(c,a.msgContent.adminMsgContent):{contactIds:[],contents:a.msgContent.adminMsgContent};var e=a.contactIds;a=a.contents;return{snippetParams:{contactIDs:[].concat(e.map(function(a){return a==="Facebook User"?"0":a})),strings:[].concat(a)},snippetSenderContactId:b,snippetType:c}}g["default"]=a}),98);
__d("MAWThreadSnippetForBumpExistingMessageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message sender is null"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bump message has no quoted author"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Bumped message can not have AUTHOR_SYSTEM"]);j=function(){return a};return a}function k(a,b,c){return{snippetParams:{contactIDs:(c=c)!=null?c:[],strings:[]},snippetSenderContactId:a,snippetType:b}}var l=function(a){return k(a,d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)};function a(a,b,c){var e;if(d("WAJids").isAuthorSystem(a.author)){d("WALogger").ERROR(j());return l(b)}e=(e=(e=a.quote)==null?void 0:e.content.author)!=null?e:c;if(e==null){d("WALogger").ERROR(i());return l(b)}if(d("WAJids").isAuthorMe(a.author))return d("WAJids").isAuthorMe(e)?k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_OWN_MESSAGE):k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE,[d("WAJids").userIdFromJid(e)]);if(b==null){d("WALogger").ERROR(h());return l(b)}if(d("WAJids").isAuthorMe(e))return k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_CURRENT_USER_MESSAGE,[b]);return e===a.author?k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_OWN_MESSAGE,[b]):k(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE,[b,d("WAJids").userIdFromJid(e)])}g["default"]=a}),98);
__d("MAWThreadSnippetForDocumentFileMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Document file message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForFallbackMessageMsg",["MAWLocalizationType","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){return{snippetParams:{contactIDs:(c=c)!=null?c:[],strings:[]},snippetSenderContactId:a,snippetType:b}}function a(a,b){var c=a.author;a=a.msgContent.subtype;if(d("WAJids").isAuthorMe(c))switch(a){case"liveLocationMessage":case"locationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION);case"contactShareMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE);case"storyMentionMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION);case"pollCreationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POLL_CREATION);case"bumpMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE);default:return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}else switch(a){case"liveLocationMessage":case"locationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION);case"contactShareMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE);case"storyMentionMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION);case"pollCreationMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POLL_CREATION);case"bumpMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE);case"metaAiMessage":return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.META_AI_SEND_MESSAGE);default:return h(b,d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}}g["default"]=a}),98);
__d("MAWThreadSnippetForGifMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForImageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Image message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForPttMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Ptt message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_AUDIO:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_AUDIO,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForRevokedMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Revoked message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNSENT_MESSAGE:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNSENT_MESSAGE,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForStickerMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Sticker message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForTextMsg",["MAWLocalizationType","MAWVault","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Text message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b,c){var e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,f={contactIDs:[],mentionJIDs:a.msgContent.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT_IN_GROUP:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT,f.contactIDs.push(b));if(a.specialTextSize===1||a.specialTextSize===2||a.specialTextSize===3){c=d("MAWVault").unvault(a.msgContent.content);f.strings.push(c==="\ud83d\udc4d"?"(Y)":a.msgContent.content)}else f.strings.push(a.msgContent.content);return{snippetParams:f,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForVideoMsg",["MAWLocalizationType","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Video message can not have AUTHOR_SYSTEM"]);h=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(h()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,c.contactIDs.push(b));return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippetForXMAMsg",["MAWLocalizationType","WAArmadilloXMA.pb","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA story mentions must have a target Jid"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA message does not have xmaMessageType"]);y=function(){return a};return a}function a(a,b){var c,e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET;c={contactIDs:[],mentionJIDs:(c=a.msgContent)==null?void 0:c.mentionedJids,strings:[]};a.xmaMessageType==null&&d("WALogger").ERROR(y());switch(a.xmaMessageType){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(x()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:if(d("WAJids").isAuthorMe(a.author)){var f;if(a.msgContent!=null&&((f=a.msgContent)==null?void 0:f.content)!=null){e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT;c.strings.push((f=a.msgContent)==null?void 0:f.content)}else e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT}else if(d("WAJids").isAuthorSystem(a.author)||b==null)d("WALogger").ERROR(w());else{e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT;c.contactIDs.push(b);if(a.msgContent!=null&&((f=a.msgContent)==null?void 0:f.content)!=null){c.strings.push((f=a.msgContent)==null?void 0:f.content)}}break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(v()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_REEL:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(u()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_REEL;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(t()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(s()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY_HIGHLIGHT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(r()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY_HIGHLIGHT;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:if(d("WAJids").isAuthorMe(a.author)){e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MENTIONED_STORY_IG;f=a.threadJid;var g;f!=null&&(g=d("WAJids").interpretAsUserJid(f));if(g!=null){f=d("WAJids").userIdFromJid(g);c.contactIDs.push(f)}else d("WALogger").ERROR(q())}else d("WAJids").isAuthorSystem(a.author)?d("WALogger").ERROR(p()):e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_RECEIVED_STORY_MENTION_IG;break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_AUDIO_CALLED,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(o()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_AUDIO_CALLED,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_VIDEO_CALLED,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(n()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_VIDEO_CALLED,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_AUDIO_CALL,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(m()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_AUDIO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_VIDEO_CALL,c.contactIDs.push(b)):d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(l()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_VIDEO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_AUDIO_CALL:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(k()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_AUDIO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:d("WAJids").isAuthorMe(a.author)&&b!=null?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_VIDEO_CALL:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(j()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_VIDEO_CALL,c.contactIDs.push(b));break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:d("WAJids").isAuthorMe(a.author)?e=d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_EVENT:d("WAJids").isAuthorSystem(a.author)||b==null?d("WALogger").ERROR(i()):(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_EVENT,c.contactIDs.push(b));break;default:d("WALogger").ERROR(h())}return{snippetParams:c,snippetSenderContactId:b,snippetType:e}}g["default"]=a}),98);
__d("MAWThreadSnippet",["FBLogger","MAWLocalizationType","MAWMsgType","MAWThreadSnippetForAdminOrEphemeralMsg","MAWThreadSnippetForBumpExistingMessageMsg","MAWThreadSnippetForDocumentFileMsg","MAWThreadSnippetForFallbackMessageMsg","MAWThreadSnippetForGifMsg","MAWThreadSnippetForImageMsg","MAWThreadSnippetForPttMsg","MAWThreadSnippetForRevokedMsg","MAWThreadSnippetForStickerMsg","MAWThreadSnippetForTextMsg","MAWThreadSnippetForVideoMsg","MAWThreadSnippetForXMAMsg","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return/^\d+$/.test(a)}function i(a){if(d("WAJids").isAuthorSystem(a))return;a=d("WAJids").isAuthorMe(a)?d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid()):d("WAJids").userIdFromJid(a);if(!h(a)){c("FBLogger")("maw_db").mustfix("[MAWThreadSnippetBuildTxns] Snippet sender contact id is invalid");return}return a}function a(a,b,e){var f=i(a.author);switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return c("MAWThreadSnippetForTextMsg")(a,f,b);case d("MAWMsgType").MSG_TYPE.IMAGE:return c("MAWThreadSnippetForImageMsg")(a,f);case d("MAWMsgType").MSG_TYPE.VIDEO:return c("MAWThreadSnippetForVideoMsg")(a,f);case d("MAWMsgType").MSG_TYPE.PTT:return c("MAWThreadSnippetForPttMsg")(a,f);case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return c("MAWThreadSnippetForAdminOrEphemeralMsg")(a,f);case d("MAWMsgType").MSG_TYPE.GIF:return c("MAWThreadSnippetForGifMsg")(a,f);case d("MAWMsgType").MSG_TYPE.STICKER:return c("MAWThreadSnippetForStickerMsg")(a,f);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return c("MAWThreadSnippetForDocumentFileMsg")(a,f);case d("MAWMsgType").MSG_TYPE.REVOKED:return c("MAWThreadSnippetForRevokedMsg")(a,f);case d("MAWMsgType").MSG_TYPE.XMA:return c("MAWThreadSnippetForXMAMsg")(a,f);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return c("MAWThreadSnippetForBumpExistingMessageMsg")(a,f,e);case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:return c("MAWThreadSnippetForFallbackMessageMsg")(a,f);default:return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:f,snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET}}}g.getSnippetContactId=i;g.buildThreadSnippet=a}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWMessageHasUniqueExternalIdValidator","MAWThreadSnippet","MAWThreadSnippetForAdminOrEphemeralMsg","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"]);h=function(){return a};return a}function i(a,b){var e=[],f=[],g=[],i=new Map(),j=new Map(),k=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return i.set(b.jid,a)})}),l=b.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b).then(function(a){return j.set(b.jid,a)})});return d("MAWDexieTable").dexieAll([k,l]).then(function(){b.forEach(function(a){a==null&&d("WALogger").ERROR(h());var b=d("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(a),k=d("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(b,a,j.get(a.jid)),l=c("MAWThreadSnippetForAdminOrEphemeralMsg")(b,d("MAWThreadSnippet").getSnippetContactId(b.author));a=i.get(a.jid);e.push(b);g.push(k);f.push({dbMsg:b,isFirstMsg:!1,isOldestMsgUpdated:a!=null&&b.msgId!==a,prevOldestMsg:a==null?void 0:a,snippet:l,updatedThread:k})});return{afterTransactionSyncMsgsData:f,e2eeThreadAdminMsgs:e,threadsToUpdate:g}})}function a(a,b){return i(a,b).then(function(b){var c=b.afterTransactionSyncMsgsData,e=b.e2eeThreadAdminMsgs,f=b.threadsToUpdate;d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource(e.map(function(a){return a.externalId}),"MAWWriteBulkWriteIncomingAdminMsgTxns.js::writeE2EEAdminMsgsForIncomingCreatedThreads");return d("MAWDexieTable").dexieAll([a.messages.bulkAdd(e),a.threads.bulkPut(f)]).then(function(){c.forEach(function(a){return d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(a)});return f})})}g.writeE2EEAdminMsgsForIncomingCreatedThreads=a}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS;function a(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function b(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.failed,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(a,b){var c;return{ack:a.ack,author:a.author,externalId:a.externalId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(c=d("MAWDbMsg").getMsgContent(a))==null?void 0:c.content,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function e(a,b,c){return{ack:a.ack,altIndex:void 0,author:a.author,externalId:c.externalId,msgContent:d("MAWDbMsg").getMsgContent(a),originalTs:a.ts,revokedExternalId:c.revokedExternalId,threadJid:b.jid,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)}}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.buildUnstoredCiphertextMsg=a;g.buildUnstoredUnavailableMsg=b;g.buildUnstoredDeleteForMeMsg=c;g.buildUnstoredRevokedMsg=e}),98);
__d("MAWDbEditMsgHistory",["I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return a}function b(a){return(h||(h=d("I64"))).of_float(a)}function c(a){return(h||(h=d("I64"))).to_float(a)}g.unsafeCoerceToEditMsgHistoryId=a;g.convertToEditMsgHistoryId64=b;g.convertToEditMsgHistoryId=c}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWIndexedDb","MAWVault","WALogger","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["No msgId found mapped with externalId: Edit messages with the externalId do not have associated Msg in the IDB."]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n          'No edit history found for the messages despite there being an editCount greater than 0"]);k=function(){return a};return a}function a(a,b){var c=[];if(b.length===0)return d("MAWDexieTable").dexieResolve(c);b=b.filter(function(a){return a.editCount!=null&&a.editCount>0});var e=b.map(function(a){return[a.externalId,a.threadJid]});if(e.length===0)return d("MAWDexieTable").dexieResolve([]);var f=b.reduce(function(a,b){b.msgId!=null&&a.set(b.externalId,b.msgId);return a},new Map());return l(a,e).then(function(a){if(a.length===0){d("WATagsLogger").TAGS(["MAWLoadMsgsTxns"]).ERROR(k());return[]}for(var b=0;b<a.length;b++){var e=a[b],g=f.get(e.originalMsgExternalId);g!=null?c.push(babelHelpers["extends"]({},e,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(e.editMsgHistoryId),originalMsgId:g})):d("WATagsLogger").TAGS(["MAWLoadMsgsTxns"]).ERROR(j())}d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:c});return c})}function l(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b).toArray()}function b(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.editMsgHistory.get({editMsgHistoryId:b})}function c(a,b,c){return a.editMsgHistory.where("originalMsgExternalId").equals(c).filter(function(a){return a.editExternalId===b.externalId&&a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){if(a.length>1){var b=a.map(function(a){return""+a.editTs.toString()});b=new Set(b).size===1;!b?d("WALogger").ERROR(i(),a.length):d("WALogger").ERROR(h())}return a[0]})}function e(a,b){return b==null?d("MAWDexieTable").dexieResolve([]):a.editMsgHistory.where("originalMsgExternalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){var b=[];a.forEach(function(a){if(a==null)return;b.push(a)});return b})}function f(a,b){return a.editMsgHistory.bulkGet(b)}function m(a,b,c){var e=b.map(function(a,b){return babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(c[b])})});return a.messages.where("externalId").anyOf(e.map(function(a){return a.originalMsgExternalId})).toArray().then(function(a){var b=new Map();a.forEach(function(a){a!=null&&b.set(a.externalId,a)});return e.map(function(a){var c=b.get(a.originalMsgExternalId);return c==null?null:babelHelpers["extends"]({},a,{originalMsgId:c.msgId})}).filter(Boolean)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:a});return c})}function n(a,b,c){c===void 0&&(c=!0);return a.editMsgHistory.bulkAdd(b,{allKeys:!0}).then(function(e){return c?m(a,b,e):d("MAWDexieTable").dexieResolve(e)})}function o(a,b,c,d){return d.then(function(d){return p(a,b,c,d)})}function p(a,b,c,e){var f=[];return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===e&&a.author===c&&(a.sendStatus==null||a.sendStatus>=d("MAWAckLevel").ACK.sent)}).toArray().then(function(a){a.forEach(function(a){f.push({messageId:a.editExternalId,originalMessageId:a.originalMsgExternalId,text:d("MAWVault").unvault(a.msgContent.content),timestamp:a.editTs})});return f})}function q(a,b,c,d){return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===d&&a.author===c})["delete"]().then(function(){})}var r=function(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b)["delete"]().then(function(){return d("MAWDexieTable").dexieResolve(b.length)})};function s(a,b,c){return a.editMsgHistory.put(babelHelpers["extends"]({},b,{msgContent:c.msgContent})).then(function(b){return a.editMsgHistory.get({editMsgHistoryId:b})})}g.loadEditMsgHistory=a;g.getEditHistoryByOriginalMsgExternalIdAndThreadJid=l;g.maybeGetEditMsgHistoryFromEditMsgHistoryId=b;g.getEditHistoryMsgByEditedProtocolMsgId=c;g.maybeGetEditMsgHistoryFromProtocolMsgId=e;g.bulkGetEditMsgHistorys=f;g.bulkAddEditMsgHistory=n;g.getEditHistoryAsEchoWithJidPromise=o;g.getEditHistoryAsEcho=p;g.bulkRemoveEditHistory=q;g.deleteExpiredEditMsgHistory=r;g.updateEditMsgHistoryWithNewIncomingMsg=s}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(a,b,c,d,e,f,g){"use strict";var h="revoked",i="deleteForMe",j="deleteThread";b="Revoked";d="DeleteForMe";e="DeleteThread";f={DELETE_FOR_ME:d,DELETE_THREAD:e,REVOKED:b};function a(a){switch(a){case"Revoked":return h;case"DeleteForMe":return i;case"DeleteThread":return j;default:return c("WAAssertUnreachable")(a)}}g.PENDING_REVOKED=h;g.PENDING_DELETE_FOR_ME=i;g.REVOKED=b;g.DELETE_FOR_ME=d;g.PENDING_TYPE=f;g.getPendingSuffix=a}),98);
__d("MAWDeleteThreadUtil",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=[];a.forEach(function(a){if(a.pendingContent.type==="DeleteThread"){a=a.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;a!=null&&b.push(a)}});if(b.length===0)return null;b.sort(function(a,b){return b-a});a=b[0];return{lastMessageTimestamp:a}}function b(a,b){return b!=null&&b.lastMessageTimestamp>=a}f.getLatestDeleteThreadInfo=a;f.isMsgDeletedViaDeleteThread=b}),66);
__d("MAWSharedCOPLogger",["WATagsLogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(c("gkx")("4255")?["COP","WORM"]:["COP"]);g["default"]=a}),98);
__d("WAPersistedQueueApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";function a(){return{ack:k,clear:m,"delete":l,index:i,keys:n,read:h,write:j}}function h(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.toCollection();(b==null?void 0:b.order)==="desc"&&(a=a.reverse());(b==null?void 0:b.filter)!=null&&(a=a.filter(b.filter));(b==null?void 0:b.limit)!=null&&(a=a.limit(b.limit));return a.toArray()},"read")}function i(a,b){return{equals:function(c){return{read:function(e){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.where(b).equals(c.length===1?c[0]:c);(e==null?void 0:e.order)==="desc"&&(a=a.reverse());(e==null?void 0:e.filter)!=null&&(a=a.filter(e.filter));(e==null?void 0:e.limit)!=null&&(a=a.limit(e.limit));return a.toArray()},"index-equal")}}},keys:function(){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.orderBy(b);return a.uniqueKeys()},"index-keys")},read:function(c){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.orderBy(b);(c==null?void 0:c.order)==="desc"&&(a=a.reverse());(c==null?void 0:c.filter)!=null&&(a=a.filter(c.filter));(c==null?void 0:c.limit)!=null&&(a=a.limit(c.limit));return a.toArray()},"index-read")}}}function j(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkAdd(b).then(function(){})},"write")}function k(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkDelete(b)},"ack")}function l(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkDelete(b)},"delete")}function m(a){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.clear().then(function(){})},"clear")}function n(a){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.toCollection();return a.primaryKeys()},"keys")}g.dexieApiForPersistedQueue=a;g.persistedQueueRead=h;g.persistedQueueIndex=i;g.persistedQueueWrite=j;g.persistedQueueAck=k;g.persistedQueueDelete=l;g.persistedQueueClear=m;g.persistedQueueKeys=n}),98);
__d("MAWDbStaleQueue",["MAWCurrentUser","MAWDbVersion","MAWIndexedDbMetadata","MAWODSProxy","MAWSharedCOPLogger","WAGetPlatformFromStanzaId","WAOdsEnums","WAPersistedQueue","WAPersistedQueueApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Dropping: ",", error: ",". Source: ",""]);h=function(){return a};return a}var i=null;function j(){if(i)return i;var a=d("WAPersistedQueue").initPersistedQueue("staleQueue",d("WAPersistedQueueApi").dexieApiForPersistedQueue());i=a;return a}function a(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=a.type==="message"?a.subtype!=null?d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.stanzaId):d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.message.details.externalId):null;c("MAWSharedCOPLogger").EXPECTED_ERROR(h(),a.type,b,e);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.POISON_QUEUE_ENTTITY,key:""+a.type});e=j();var f=d("MAWCurrentUser").getID();f=(f=(yield d("MAWDbVersion").getDexieDbVersion(d("MAWIndexedDbMetadata").dbName(f))))!=null?f:0;if(a.type!=="message")return;return e.addAndCommit([{dbVersion:f,exception:b,stanza:a}])});return k.apply(this,arguments)}e=function(){return j().read({limit:1}).then(function(a){return a.length===0})};f=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a===void 0&&(a=500);a=j().read({limit:a});a=(yield a.then(function(a){return a.flatMap(function(a){return a})}));return a});return function(b){return a.apply(this,arguments)}}();g.mawAddStaleStanza=a;g.isEmpty=e;g.read=f}),98);
__d("MAWIsQuotaExceededError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){return a.name==="QuotaExceededError"||a.inner&&a.inner.name==="QuotaExceededError"};f.isQuotaExceededError=a}),66);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.actionType,c=a.attachmentContext,d=a.authTs,e=a.echoDocument,f=a.echoEncodingLatencyNs,g=a.errorCode,i=a.errorMessage,j=a.messageId,k=a.messageType,l=a.productType,m=a.protoMsg,n=a.sortOrderMs,o=a.threadId,p=a.traceId;a=a.uploadTrackingInstanceKey;c=h(c,l!=null?l:"msgr");return{actionType:b,attachmentBackupContext:c,authTs:d,echoDocument:e,echoEncodingLatencyNs:f,errorCode:g,errorMessage:i,messageId:j,messageType:k,protoMsg:m,sortOrderMs:n,threadId:o,traceId:p,uploadTrackingInstanceKey:a}}function b(a,b,c,d,e,f){return{actionType:f,echoDocument:e,folderType:b,threadId:a,transportKey:c,ts:d}}function c(a,b,c,d,e,f,g,h){return{deliveryObjectId:a,mediaType:b,messageId:c,productType:d,threadId:e,threadJid:f,traceId:h,ts:g}}function h(a,b){if(a==null)return void 0;else{a={attachmentTraceId:d("MAWMainTraceUtils").createTraceId(),mediaType:a.mediaType,zippyObjectId:a.mediaObjectId};a={attachmentInfos:[a],productType:b};return a}}g.createBridgeUploadMessage=a;g.createBridgeDeleteMessagesOfThread=b;g.createBridgeUploadAttachment=c;g.createBridgeUploadAttachmentBackupContext=h}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function i(a){switch(a){case d("MAWFolderTypes").FOLDER_ID.INBOX:return h.INBOX;case d("MAWFolderTypes").FOLDER_ID.PENDING:return h.PENDING;case d("MAWFolderTypes").FOLDER_ID.ARCHIVED:return h.ARCHIVED;default:return h.INBOX}}function a(a){return i(a).toString()}g.FolderType=h;g.getFolderTypeAsText=a}),98);
__d("MAWBridgeEventTransmitter",["MAWBridge","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWUploadThreadTxns","WAJids","WATimeUtils","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"IssuePointQuery",value:{jid:f,messageId:a,startSortKey:c,taskSource:e,threadId:b}}]})}function b(a,b){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:d("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(d("WAJids").threadIdForChatJid(a.jid),d("MAWUploadThreadTxns").getFolderTypeAsText(a.folder),"AdvancedCrypto",(a=b)!=null?a:d("WATimeUtils").castToMillisTime(1),null,2)})}function e(a,b,c,e,f,g){d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(b,c,e,f,g)})}function f(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(a,b,c)}]})}function h(a,b,e){var f=c("qpl")._(521482576,"1069");(e==null?void 0:e.get(a.externalId))!=null?d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(a,e.get(a.externalId),void 0,f,b,"EncryptedBackups")}]}):d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(a,void 0,void 0,f,b,"EncryptedBackups")}]})}function i(a,b,c,e){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a,folder:b,threadJid:e})}]})}function j(a,b,c){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessageRangesV2",value:{minMsgId:a,minTimestampMs:b,threadJid:c}})}g.issuePointQueryOutsideTxn=a;g.deleteMessagesOfThreadAfterTxn=b;g.issueMsgLoadedEventAfterTxn=e;g.startTraceOutsideTxn=f;g.issueNewMsgUiEventOutsideTxn=h;g.updateThreadOutsideTxn=i;g.deleteMessageRangesV2AfterTxn=j}),98);
__d("MAWSharedRestoreUnavailableMessages",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","WAGlobals","WAJids","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h=1e4,i=new Map();function j(a){if(i.has(a.externalId))return;i.set(a.externalId,!0);c("setTimeout")(function(){var b=a.chat;d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(b),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,b)},h)}function a(a){a.forEach(function(a){if(a.type!=="message")return;if(a.subtype!=null){if(a.subtype==="unavailable"||a.subtype==="ciphertext"){var b=d("WAJids").extractUserJid(a.from);j({author:d("WAGlobals").getMyUserJid()===b?"@me":b,chat:a.jid,externalId:a.stanzaId})}}else(a.message.decrypted.type==="IncomingCiphertextMsg"||a.message.decrypted.type==="UnavailableMsg")&&j(a.message.decrypted.id)})}g.restoreUnavailableMessages=a}),98);
__d("MAWSharedCOPHandleBatch",["MAWDbStaleQueue","MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedRestoreUnavailableMessages","WAPREList","WAProtocolQueue","WAWaterFlow","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received more than 1 entry, despite having limit === 1"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed processing "," items"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[ackProtocols] Cannot ack from MAWConsumer: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Runtime error while processing stanzas batch. ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Quota exceeded while processing stanzas batch. ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," stanzas. Config:",""]);m=function(){return a};return a}function n(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=(yield a(b));b.order==="desc"&&(g=g.toReversed());if(g.length===0)return{exhausted:!0,handled:0};f==null?void 0:f.publish({type:"maw-infra-batch"});c("MAWSharedCOPLogger").LOG(m(),g.length,b);var o=d("WAWaterFlow").makeWaterflow("consumer",d("WAPREList").PRE_METRIC.PROTOCOL_QUEUE_CONSUMER,!0).startMetric();d("MAWSharedRestoreUnavailableMessages").restoreUnavailableMessages(g);var p=(yield e(g,o).then(function(a){return[a,null,!1]})["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a)){c("MAWSharedCOPLogger").ERROR(l(),a);o.endFail("quota_exceeded");return[[],null,!0]}c("MAWSharedCOPLogger").ERROR(k(),a);return[[],a instanceof Error?a:c("err")(""+a),!1]})),q=p[0],r=p[1];p=p[2];if(p)return{exhausted:!0,handled:0};r==null?o.endSuccess():o.endFail("fail_process_entity");yield d("WAProtocolQueue").protocolQueue().ack(q)["catch"](function(a){return c("MAWSharedCOPLogger").ERROR(j(),a)});if(q.length>=g.length)return{exhausted:!1,handled:q.length};c("MAWSharedCOPLogger").WARN(i(),g.length-q.length);if(b.limit===1){g.length>1&&c("MAWSharedCOPLogger").ERROR(h());if(g.length===0)return{exhausted:!1,handled:0};p=g[0];r=(g=r==null?void 0:r.toString())!=null?g:"not-processed";yield d("WAProtocolQueue").protocolQueue()["delete"]([p.stanzaQueueId]);yield d("MAWDbStaleQueue").mawAddStaleStanza(p,r);return{exhausted:!1,handled:1}}p=(yield n(a,{limit:Math.ceil(((g=b.limit)!=null?g:1)/2),order:b.order},e,f));return{exhausted:!1,handled:q.length+p.handled}});return o.apply(this,arguments)}g.copHandleBatch=n}),98);
__d("WAPromiseEach",["regeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";a=function(a,c){var d,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:d=[],e=0;case 2:if(!(e<a.length)){f.next=11;break}f.t0=d;f.next=6;return b("regeneratorRuntime").awrap(c(a[e]));case 6:f.t1=f.sent,f.t0.push.call(f.t0,f.t1);case 8:e++;f.next=2;break;case 11:return f.abrupt("return",d);case 12:case"end":return f.stop()}},null,this)};f.promiseEach=a}),66);
__d("MAWSharedCOPHandler",["$InternalEnum","MAWSharedCOPHandleBatch","MAWSharedCOPLogger","WAPromiseEach","WAProtocolQueue","asyncToGeneratorRuntime","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processed "," stanzas. Exhausted: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SafeGuard] Processing get downgraded to in order processing. Verify if it's intentional"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[UserBlocking] Processed "," stanzas from "," chats"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[LoadMoreMsgs] "," requested: ",", processed: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[OnDemand] Fatal: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[UserFacing] Processed "," stanzas. Exhausted: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Background] Processed "," stanzas. Exhausted: ",""]);n=function(){return a};return a}var o=b("$InternalEnum").Mirrored(["PERSIST","PERSIST_FAIL","FOLLOW_UP","PROCESS_RETRIES"]),p=c("justknobx")._("2541"),q=c("justknobx")._("2542"),r=c("justknobx")._("2653");function a(a){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.processEntries;var b=r?"desc":"asc",e=c("justknobx")._("2539");e=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("priority").read,{limit:e,order:b},a,null));b=e.exhausted;a=e.handled;c("MAWSharedCOPLogger").LOG(n(),a,b);return{exhausted:b,handled:a}});return s.apply(this,arguments)}function e(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.activeJid;a=a.processEntries;if(!r)return x({processEntries:a}).then(function(){return{exhausted:!0}});var e={exhausted:!0,handled:0};b!=null&&(e=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("[jid+priority]").equals([b,d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:q,order:"desc"},a,null)));b=e.handled;e.exhausted&&(e=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("priority").equals([d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:q,order:"desc"},a,null)),b+=e.handled);b>0&&c("MAWSharedCOPLogger").LOG(m(),b,e.exhausted);return{exhausted:e.exhausted}});return t.apply(this,arguments)}function f(a){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.activeJid,e=a.count;a=a.processEntries;if(!r)return;a=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("[jid+priority]").equals([b,d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:e,order:"desc"},a,null)["catch"](function(a){c("MAWSharedCOPLogger").ERROR(l(),a)}));c("MAWSharedCOPLogger").LOG(k(),b,e,a==null?void 0:a.handled)});return u.apply(this,arguments)}function v(a){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.activeChat,f=a.processEntries,g=a.pubSub;a=a.recentChats;if(!r)return x({processEntries:f,pubSub:g});var h=0;yield d("WAPromiseEach").promiseEach(a,function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=c("gkx")("4258")&&a!==e?1:p;a=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("[jid+priority]").equals([a,d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read,{limit:b,order:"desc"},f,g));h+=a.handled});return function(b){return a.apply(this,arguments)}}());c("MAWSharedCOPLogger").LOG(j(),h,a.length)});return w.apply(this,arguments)}function x(a){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.processEntries;a=a.pubSub;c("MAWSharedCOPLogger").ERROR(i());a==null?void 0:a.publish({type:"idle-oq-safe-guard"});var e=d("WAProtocolQueue").protocolQueue().index("priority").equals([d("WAProtocolQueue").WAProtocolQueuePriorityHigh]).read;while((f=(yield d("MAWSharedCOPHandleBatch").copHandleBatch(e,{limit:c("justknobx")._("2540"),order:"asc"},b,(f=a)!=null?f:null))).exhausted===!1){var f;c("MAWSharedCOPLogger").LOG(h(),f.handled,f.exhausted)}});return y.apply(this,arguments)}g.ConsumerProcessingStages=o;g.copHandleBackgroundBatch=a;g.copHandleUserFacingBatch=e;g.copHandleMessagesOnDemand=f;g.copHandleRecentMessages=v}),98);
__d("MAWSharedCOPLoop",["$InternalEnum","MAWSharedCOPLogger","Promise","WAResolvable","WAShiftTimer","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Completed: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Started: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Stuck: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Possibly stuck: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["COPLoop fatal: ",""]);m=function(){return a};return a}var n=b("$InternalEnum")({BLOCKING:-1,NON_BLOCKING:0,BASE_TIMEOUT:2}),o=0,p=1,q=2,r=function(){function a(){var a=this;this.$2=0;this.$3=60;this.$4=30;this.$5=c("justknobx")._("2543");this.$6=new(d("WAResolvable").Resolvable)();this.$7=new(d("WAResolvable").Resolvable)();this.$8=new(d("WAResolvable").Resolvable)();this.$9=new(d("WAShiftTimer").ShiftTimer)(function(){try{a.$10()}catch(b){c("MAWSharedCOPLogger").ERROR(m(),b),a.$9.onOrBefore(a.$5)}});this.$11=c("MAWSharedCOPLogger").TAGS(["loop"]);this.$12=[new Map(),new Map(),new Map()]}var e=a.prototype;e.$13=function(){if(!this.$1)return;this.$2++;switch(this.$1.behaviour){case n.BLOCKING:break;case n.NON_BLOCKING:this.$1=null;return;case n.BASE_TIMEOUT:if(this.$2>Number(n.BASE_TIMEOUT)){this.$1=null;return}break}if(!this.$1)return;var a=this.$1;this.$2>this.$4&&a.stuck===!1&&(a.stuck=!0,this.$11.WARN(l(),a.id));this.$2>this.$3&&(this.$11.ERROR(k(),a.id),this.$1=null)};e.$14=function(){var a=this;if(this.$1!=null)return{endReached:!1};for(var b=o;b<=q;b++){var c=this.$12[b].entries().next().value;if(c!=null){var d=function(){var d=c[0],e=c[1];a.$12[b]["delete"](d);a.$1=e;a.$2=0;a.$11.LOG(j(),e.id);e.fn()["finally"](function(){a.$2=0,a.$11.LOG(i(),e.id),a.$1=null,(a.$12[o].size>0||a.$5===0)&&a.$9.forceRunNow()});return{v:{endReached:!1}}}();if(typeof d==="object")return d.v}b===o&&this.$6.resolve();b===p&&this.$7.resolve();b===q&&this.$8.resolve()}return{endReached:!0}};e.$10=function(){this.$13();var a=this.$14();a=a.endReached;a||this.$9.onOrBefore(this.$5)};e.$15=function(a,c,e,f){var g;for(var i=q;i>a;i--){var j=this.$12[i].get(c);j!=null&&(g=j.resolvable,this.$12[i]["delete"](c))}for(j=o;j<a;j++){i=this.$12[j].get(c);if(i!=null)return i.resolvable.promise}g==null&&(g=new(d("WAResolvable").Resolvable)());i={behaviour:f,fn:function(b){function a(){return b.apply(this,arguments)}a.toString=function(){return b.toString()};return a}(function(){g.resolve((h||(h=b("Promise"))).resolve().then(e));return g.promise}),id:c,resolvable:g,stuck:!1};this.$12[a].set(c,i);a===o&&this.$1==null?this.$9.forceRunNow():this.$9.onOrBefore(this.$5);return g.promise};e.awaitUserBlocking=function(a,b,c){this.$6.resolveWasCalled()&&(this.$6=new(d("WAResolvable").Resolvable)());this.$7.resolveWasCalled()&&(this.$7=new(d("WAResolvable").Resolvable)());this.$8.resolveWasCalled()&&(this.$8=new(d("WAResolvable").Resolvable)());return this.$15(o,a,b,c)};e.awaitUserFacing=function(a,b,c){this.$7.resolveWasCalled()&&(this.$7=new(d("WAResolvable").Resolvable)());this.$8.resolveWasCalled()&&(this.$8=new(d("WAResolvable").Resolvable)());return this.$15(p,a,b,c)};e.awaitBackground=function(a,b,c){this.$8.resolveWasCalled()&&(this.$8=new(d("WAResolvable").Resolvable)());return this.$15(q,a,b,c)};e.waitForBackgroundQueueEmpty=function(){return this.$8.promise};e.waitForUserFacingQueueEmpty=function(){return this.$7.promise};e.waitForUserUnblocked=function(){return this.$6.promise};return a}();function a(a){return"p0-"+a}var s=0;function e(a){s++;return a+"-"+s}function f(a){return a}var t="cop-rest",u="cop-user-facing",v="cop-user-blocking";g.COPBehaviour=n;g.COPLoop=r;g.makeChatCopId=a;g.makeCopGUID=e;g.makeCopNonUniqueId=f;g.copBackground=t;g.copUserFacing=u;g.copUserBlocking=v}),98);
__d("MAWSharedStaleQueueReporter",["MAWDbStaleQueue","MAWQplProxy","asyncToGeneratorRuntime","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("MAWDbStaleQueue").isEmpty());if(a)return;a=c("justknobx")._("1498");a=(yield d("MAWDbStaleQueue").read(a));var b=a.map(function(a){return[a.dbVersion,a.exception]});d("MAWQplProxy").startQplUserFlow(c("qpl")._(1056849770,"993"),{"int":{count:a.length},string_array:{dbErrors:Array.from(new Set(b.map(function(a){return a[1]}))),dbVersions:Array.from(new Set(b.map(function(a){return""+a[0]})))}}).endSuccess()});return h.apply(this,arguments)}g["default"]=a}),98);
__d("WAWaitForUser",["WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAResolvable").Resolvable)();function a(){h.resolveWasCalled()&&(h=new(d("WAResolvable").Resolvable)())}function b(){return h.promise}function c(){h.resolve()}function e(){return!h.resolveWasCalled()}g.maybeResetWaitForUserUnblocked=a;g.waitForUserUnblocked=b;g.unblockUser=c;g.isStillWaitingForUserUnblocked=e}),98);
__d("MAWSharedCOP",["FBLogger","MAWSharedCOPHandler","MAWSharedCOPLogger","MAWSharedCOPLoop","MAWSharedStaleQueueReporter","Promise","WAPubSub","WAWaitForUser","asyncToGeneratorRuntime","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["StaleQueue: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["IdleOQ: Offline"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Background FATAL: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["HighPri FATAL: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["HighPri FATAL: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["IdleOQ M2: Online"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["UserFacing FATAL: ",""]);o=function(){return a};return a}var p=function(){function a(a){var e=this;this.$1="offline";this.$2=d("WAPubSub").simplePubSub();this.$4=null;this.$5=new Set();this.$6=function(){e.queue.awaitUserFacing(d("MAWSharedCOPLoop").copUserFacing,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("MAWSharedCOPHandler").copHandleUserFacingBatch({activeJid:e.$4,processEntries:e.$3}));a=a.exhausted;a||e.$6()}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)["catch"](function(a){c("MAWSharedCOPLogger").ERROR(o(),a),e.$6()})};this.queue=new(d("MAWSharedCOPLoop").COPLoop)();this.$3=a}var e=a.prototype;e.handleThreadMetadata=function(a){var b=this;a.forEach(function(a){b.$5.add(a)})};e.onlineProcessing=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;c("MAWSharedCOPLogger").LOG(n());try{yield this.queue.awaitUserBlocking(d("MAWSharedCOPLoop").makeCopNonUniqueId("online"),b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWSharedCOPHandler").copHandleUserFacingBatch({activeJid:void 0,processEntries:a.$3})}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)}catch(a){c("MAWSharedCOPLogger").ERROR(m(),a)}finally{this.$6(),this.$7()}});function e(){return a.apply(this,arguments)}return e}();e.$8=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;this.$2.publish({type:"maw-infra-start"});this.$4!=null&&this.$5.add(this.$4);try{yield this.queue.awaitUserBlocking(d("MAWSharedCOPLoop").copUserBlocking,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWSharedCOPHandler").copHandleRecentMessages({activeChat:a.$4,processEntries:a.$3,pubSub:a.$2,recentChats:Array.from(a.$5)}),a.$2.publish({success:!0,type:"maw-infra-end"})}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)}catch(a){c("MAWSharedCOPLogger").ERROR(l(),a),this.$2.publish({success:!1,type:"maw-infra-end"})}finally{this.$6()}});function e(){return a.apply(this,arguments)}return e}();e.$7=function(){var a=this;this.queue.awaitBackground(d("MAWSharedCOPLoop").copBackground,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var b=(yield d("MAWSharedCOPHandler").copHandleBackgroundBatch({processEntries:a.$3}));b=b.exhausted;b||a.$7()}),d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)["catch"](function(b){c("MAWSharedCOPLogger").ERROR(k(),b),a.$7()})};e.$9=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){c("MAWSharedCOPLogger").LOG(j());yield this.$8();this.$5.clear();this.$6();this.$7();this.queue.awaitBackground(d("MAWSharedCOPLoop").makeCopNonUniqueId("stale-queue-report"),function(){return c("MAWSharedStaleQueueReporter")()},d("MAWSharedCOPLoop").COPBehaviour.NON_BLOCKING)["catch"](function(a){c("MAWSharedCOPLogger").ERROR(i(),a)});return});function e(){return a.apply(this,arguments)}return e}();e.loadMoreMsgs=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){var e=this;this.$4=a;return!d("WAWaitForUser").isStillWaitingForUserUnblocked()?(h||(h=b("Promise"))).resolve():this.queue.awaitUserBlocking(d("MAWSharedCOPLoop").makeCopNonUniqueId("load-more-msgs-"+a),function(){return d("MAWSharedCOPHandler").copHandleMessagesOnDemand({activeJid:a,count:c,processEntries:e.$3})},d("MAWSharedCOPLoop").COPBehaviour.BLOCKING)});function c(b,c){return a.apply(this,arguments)}return c}();e.subscribeToOfflineQueue=function(a,b){var e=this;a.subscribe(function(a){switch(a.type){case"offline-start":e.$1="offline";d("WAWaitForUser").maybeResetWaitForUserUnblocked();break;case"offline-end":e.$1="online";e.$9()["finally"](function(){d("WAWaitForUser").unblockUser()});break;default:a.type;break}});b.subscribe(function(a){switch(a.type){case"flush":if(e.$1!=="online")return;c("promiseDone")(e.onlineProcessing());return}})};e.awaitBackground=function(a,b){var c=this;return d("WAWaitForUser").waitForUserUnblocked().then(function(){return c.queue.awaitBackground(a,b,d("MAWSharedCOPLoop").COPBehaviour.NON_BLOCKING)})};e.subscribe=function(a){return this.$2.subscribe(a)};e.TEST_ONLY_setMode=function(a){this.$1=a};e.TEST_ONLY_getMode=function(){return this.$1};return a}(),q=null;function a(a){q!==null&&c("FBLogger")("messenger_web_devx").mustfix("COP init is called twice");q=new p(a);return q}function e(){if(q===null){c("FBLogger")("messenger_web_devx").mustfix("COP is called before init");throw c("err")("COP is called before init")}return q}g.COP=p;g.makeCOP=a;g.getCOP=e}),98);
__d("MAWMsgCleaner",["MAWLoggerUtils","MAWSharedCOP","MAWSharedCOPLoop","Promise","WAAssertUnreachable","WAShiftTimer","WATagsLogger","WATimeUtils","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""]);k=function(){return a};return a}a="Unsend";e="Ephemeral";f="DeleteForMe";var l="PendingStanza",m="Xma",n="IGDDM";f={DELETE_FOR_ME:f,EPHEMERAL:e,IGDDM:n,PENDING_STANZA:l,UNSEND:a,XMA:m};e=function(){function a(a,e){var f=this;this.$1=new(d("WAShiftTimer").ShiftTimer)(function(){c("gkx")("3547")?c("promiseDone")(d("MAWSharedCOP").getCOP().awaitBackground(d("MAWSharedCOPLoop").makeCopGUID(f.cleanerType),function(){return f.$2()})):c("promiseDone")(f.$2())});this.getNextTs=a.getNextTs;this.removeExpired=a.removeExpired;this.cleanerType=e;this.purgeEnabled=a.purgeEnabled;c("gkx")("3547")?c("promiseDone")(d("MAWSharedCOP").getCOP().awaitBackground(d("MAWSharedCOPLoop").makeCopGUID(e),function(){f.$1.forceRunNow();return(h||(h=b("Promise"))).resolve()})):this.$1.forceRunNow()}var e=a.prototype;e.update=function(a){var b=o(this.cleanerType);d("WATagsLogger").TAGS([b,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerUpdate]).LOG(k(),b,a);this.$1.onOrBefore(d("WATimeUtils").cappedMillisecondsUntil(a))};e.$2=function(){var a=this;if(!this.purgeEnabled())return(h||(h=b("Promise"))).resolve();var c=o(this.cleanerType);d("WATagsLogger").TAGS([c,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerPurge]).LOG(j(),c);return this.removeExpired().then(function(b){b>0&&d("WATagsLogger").TAGS([c,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerPurge]).LOG(i(),c,b);return a.getNextTs()}).then(function(b){b!=null&&a.update(b)})};return a}();function o(a){switch(a){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";default:return c("WAAssertUnreachable")(a)}}n=e;g.CLEANER_TYPE=f;g.MsgCleaner=e;g.MSG_CLEANER_FOR_TESTING_ONLY=n}),98);
__d("MAWPendingStanzaCleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}var j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function b(a){if(j==null){var b="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),j.update(a)}function e(){return j}function f(){j=null}g.startPendingStanzaCleaner=a;g.addNewPendingStanzaCleanerTimestamp=b;g.getPendingStanzaCleaner_FOR_TESTING_ONLY=e;g.resetPendingStanzaCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c,e,f){var g=d("MAWDbPendingStanza").getPendingSuffix(f);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+g).filter(function(a){a=a.pendingContent;return a.type===f&&a.content.author===c&&a.content.threadJid===e}).first()}function a(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function b(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function c(a,b){var c=b.map(function(a){a=a.expirationInSeconds;return d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+a)});b=b.map(function(a,b){var e=a.content,f=a.externalId;a=a.pendingStanzaType;return{deleteTs:c[b],externalIdWithType:f+"_"+d("MAWDbPendingStanza").getPendingSuffix(a),pendingContent:e}});return a.pendingStanzas.bulkAdd(b).then(function(){return c.forEach(d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(function(){})}function e(a,b,c,e,f){f=d("MAWDbPendingStanza").getPendingSuffix(f);var g=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+c);c={deleteTs:g,externalIdWithType:e+"_"+f,pendingContent:b};return a.pendingStanzas.add(c).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(g)})}function f(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+c).toArray().then(function(a){return d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a)})}function i(a){return a.pendingStanzas.toArray()}function j(a,b){b=b.map(function(a){return a.rowId});return a.pendingStanzas.bulkDelete(b)}function k(a){var b;return(a==null?void 0:(b=a.pendingContent)==null?void 0:b.type)===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?a==null?void 0:(b=a.pendingContent)==null?void 0:b.content:null}function l(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);b=b.map(function(a){return a+"_"+c});return a.pendingStanzas.where("externalIdWithType").anyOf(b).toArray().then(function(a){a=a.reduce(function(a,b){var c=a.get(b.externalIdWithType);c==null?a.set(b.externalIdWithType,[b]):c.push(b);return a},new Map());var b=new Map();a.forEach(function(a,c){c=d("WAJids").unsafeCoerceToChatJid(c.split("_")[0]);a=d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a);a!=null&&b.set(c,a)});return b})}g.maybeGetPendingStanzaByExternalId=h;g.maybeGetPendingRevokedStanza=a;g.maybeGetPendingDeletedStanza=b;g.bulkPutPendingStanzas=c;g.putPendingStanza=e;g.maybeGetDeleteThreadFromPendingStanza=f;g.getAllPendingStanzas=i;g.deletePendingStanzas=j;g.getRevokedContent=k;g.bulkGetDeleteThreadPendingStanzas=l}),98);
__d("MAWDbReactionsTxns",["FBLogger","MAWAuthor","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","MAWIndexedDb","WALogger","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Deleted "," reactions"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted reaction with id : ","."]);j=function(){return a};return a}var k=function(a){return a};function a(a,b){return a.reactions.put(k(b))}function b(a,b){return a.reactions["delete"](b.rowId).then(function(){var a=b.author,c=b.reactionId,e=b.reactToMsgId,f=b.threadJid;if(e==null)return;d("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:a,chatJid:f,reactToMsgId:e})});d("WALogger").LOG(j(),c)})}function e(a,b){return a.reactions.where("externalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).first()}function f(a,b){var c=d("MAWAuthor").getAuthorUserJid(b.author);return a.reactions.where("reactToExternalId").equals(b.externalId).filter(function(a){return(a.reactToAuthor===c||a.reactToAuthor===b.author)&&a.threadJid===b.chat}).toArray()}function l(a,b){var d=b.reduce(function(a,b){a.set(b.msgId,b);return a},new Map());return a.reactions.where("reactToMsgId").anyOf(b.map(function(a){return a.msgId})).toArray().then(function(a){var b=a.filter(function(a){var b=a.reactToExternalId;a=a.reactToMsgId;return a!=null&&b===((b=d.get(a))==null?void 0:b.externalId)});b.length<a.length&&c("FBLogger")("messenger_web_devx").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId");return b})}function m(a,b){return l(a,[b])}function n(a,b){var c=b.author,d=b.chat;b=b.externalId;return a.reactions.where("externalId").equals(b).filter(function(a){return a.author===c&&a.threadJid===d}).first()}function o(a,b){var c=b.map(function(a){a=a.externalId;return a});return a.reactions.where("externalId").anyOf(c).toArray().then(function(a){var c=d("MAWDbMsgUtil").convertMsgArrayToMap(a),e=new(d("WAMsgMap").MsgMap)();b.forEach(function(a){var b=c.get(a);b!=null&&e.set(a,b)});return e})}function p(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.author;b=b.externalId;var e=d("MAWAuthor").getAuthorUserJid(c);return a.reactions.where("reactToExternalId").equals(b).filter(function(a){return d("MAWAuthor").getAuthorUserJid(a.reactToAuthor)===e}).toArray()})).then(function(b){b=b.reduce(function(a,b){return a.concat(b)},[]);b.forEach(function(a){var b=a.author,c=a.reactToMsgId;a=a.threadJid;if(c==null)return;d("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:a,reactToMsgId:c})})});d("WALogger").LOG(i(),b.length);return a.reactions.bulkDelete(b.map(function(a){return a.rowId}))})}function q(a,b){return a.reactions.where("reactToMsgId").anyOf(b.map(function(a){return a.msgId}))["delete"]().then(function(a){d("WALogger").LOG(h(),a)})}function r(a,b){return a.reactions.where("reactionId").between(d("MAWDbMsg").msgIdsInChatLowerBound(b.chatId),d("MAWDbMsg").msgIdsInChatUpperBound(b.chatId)).last().then(function(a){a=a==null?0:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.reactionId);return a+1})}g.coerceToReaction=k;g.putReaction=a;g.deleteReaction=b;g.getReaction=e;g.getReactionForEcho=f;g.getReactionsFromMessages=l;g.getReactionsFromMessage=m;g.maybeGetReactionByProtocolMsgId=n;g.getReactionMapByProtocolMsgId=o;g.deleteReactionsByUniqueMsgIdentifiers=p;g.deleteAllReactionsForMessages=q;g.getNextReactionIdNumberForThread=r}),98);
__d("MAWDeleteForMeMsgContentCleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startDeleteForMeMsgContentCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function b(a){if(k==null){var b="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startDeleteForMeMsgContentCleaner=a;g.addNewDeleteForMeMsgContentCleanerTimestamp=b;g.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWEBUploadMessageUtils",["I64","MAWDbMsg","MAWExtractMsFromExternalId","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] externalId is not a valid int64"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Timestamp bits in externalId not valid"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] ExternalId is not present"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["echoOverrideMessageSortOrder called without ID"]);l=function(){return a};return a}function a(a){var b=a.revokedExternalId!=null?a.revokedExternalId:a.externalId;b==null&&d("WALogger").ERROR(l());b=(h||(h=d("I64"))).of_string_opt(b);if(a.serverTs==null){if(a.sortOrderMs!=null)return a.sortOrderMs;b==null&&d("WALogger").WARN(k());var c=b==null?null:d("MAWExtractMsFromExternalId").extractMsFromExternalId(b);return d("MAWDbMsg").getCanonicalTsFromMsg(a)*1e3+((c=c)!=null?c:0)}if(b!=null){c=d("MAWExtractMsFromExternalId").extractMsFromExternalId(b);if(c!=null){b=a.originalTs!=null?a.originalTs:a.serverTs;return Number(b)*1e3+c}else d("WALogger").WARN(j())}else d("WALogger").WARN(i());return d("MAWDbMsg").getSortOrderWithFallback(a)}g.echoOverrideMessageSortOrder=a}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown]);function a(a){return{msgs:a.map(function(a){var b,c=a.messageExpirationTs;b=(b=a.ephemeralSetting)==null?void 0:b.ephemeralExpirationInSec;if(c==null||b==null)return;var e=d("WATimeUtils").cappedMillisecondsUntil(c);if(e<=0){j.LOG(i());return}var f=b*1e3;e>f&&(e=f);j.LOG(h(),a.msgId,c,e,b);return{countdownTs:c,millisecondsUntilCountdownTs:e,msgId:a.msgId,threadJid:a.threadJid,ts:d("MAWDbMsg").getCanonicalTsFromMsg(a)}}).filter(Boolean)}}function b(a,b){return{countdownTs:b,msgId:a}}g.createBridgeMsgsStartCountdown=a;g.createBridgeMsgClearCountdown=b}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","WATagsLogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for UI(",") and backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startEphemeralCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){var b=a.backendFns;a=a.uiFns;d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerStart]).LOG(j());if(k==null){var c;k={backend:new((c=d("MAWMsgCleaner")).MsgCleaner)(b,c.CLEANER_TYPE.EPHEMERAL),ui:new c.MsgCleaner(a,c.CLEANER_TYPE.EPHEMERAL)}}}function b(a,b){if(k==null){var e="Trying to add new ephemeral timestamp before the cleaner is initialized!";d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp]).ERROR(i(),e);throw c("err")(e)}else{e=k;var f=e.backend;e=e.ui;d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp]).DEV(h(),a,b);e.update(a);f.update(b)}}function e(){return k}function f(){k=null}g.startEphemeralCleaner=a;g.addNewEphemeralTimestamp=b;g.getEphemeralCleaner_FOR_TESTING_ONLY=e;g.resetEphemeralCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function i(a,b){h.set(a,b)}function a(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};return(a=h.get(a))!=null?a:b}function c(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};if(!h.has(a)){var c=(yield d("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:a}));i(a,(a=c)!=null?a:b)}});return j.apply(this,arguments)}g.setEphemeralSettingCache=i;g.getEphemeralSettingCache=a;g.requestLSDBCacheForJid=c}),98);
__d("MAWEphemeralUtil",["MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAGlobals","WAJids","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"]);i=function(){return a};return a}function a(a,b,c){var e=d("WAGlobals").getMyDeviceJid();e=b.ephemeralExpirationInSec!==a.ephemeralExpirationInSec&&b.ephemeralLastUpdatedOrSetTimestamp===a.ephemeralLastUpdatedOrSetTimestamp&&e<=c;return e||a.ephemeralLastUpdatedOrSetTimestamp>b.ephemeralLastUpdatedOrSetTimestamp}function b(a,b,c){if(a==null)return!0;a=a.ephemeralSetting;if(a!=null&&a.ephemeralExpirationInSec===b){d("WALogger").DEV(i());return!1}if(a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>c){d("WALogger").DEV(h());return!1}return!0}function e(a){a={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:null}}function f(a,b){var e;switch(b){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw c("err")("Received unexpected screenshot action type")}b={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:e},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:b,unstoredDbReaction:void 0}}function j(a){return d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){throw c("err")("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(a){return a}})}function k(a){a!=null&&a.messageExpirationTs!=null&&a.ephemeralCounterStarted===!0&&d("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(a.msgId,a.messageExpirationTs)})}g.isLocalSettingOutdated=a;g.shouldUpdateForOutgoingUserEphemeralSettingChange=b;g.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=e;g.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=f;g.getUserJidForEphemeralSetting=j;g.maybeClearEphemeralMsgCountdown=k}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","WAGlobals","WAJids","WALogger","WAResultOrError","WATagsLogger","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAndWriteIncomingEphemeralSetting - ephemeral setting in sync"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAndWriteIncomingEphemeralSetting - Sending Sync Response with duration ",", timestamp ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleAndWriteIncomingEphemeralSetting - Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",""]);o=function(){return a};return a}var p=d("WATagsLogger").TAGS([(h=d("MAWLoggerUtils")).Tag.Ephemeral,h.Tag.SettingChange,h.Tag.Incoming]),q=d("WATagsLogger").TAGS([h.Tag.Ephemeral,h.Tag.SettingChange,h.Tag.Outgoing]),r=null,s=90*d("DateConsts").SEC_PER_DAY;function a(a,b,e,f,g,h,i,j,k,q){if(f<0||f>s){j=d("WAJids").interpretAndValidateJid(i.jid).toString();throw c("err")("EphemeralSetting duration is invalid "+f+", jidType: "+j)}k={ephemeralExpirationInSec:f,ephemeralLastUpdatedOrSetTimestamp:g};d("WALogger").LOG(o(),f,g);j=d("WAJids").interpretAsUserJid(i.jid);if(j==null){p.ERROR(n());return d("MAWDexieTable").dexieResolve(r)}f=d("WAJids").isAuthorMe(b)?d("WAGlobals").getMyUserJid():b;b=e!=null?d("WAJids").toDeviceJid(f,e.id):null;e=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(i.jid);var t=e==null?void 0:e.ephemeralExpirationInSec,u=e==null?void 0:e.ephemeralLastUpdatedOrSetTimestamp;if(q){if(e!=null&&b!=null&&!d("MAWEphemeralUtil").isLocalSettingOutdated(k,e,b))if(g!==u){d("WALogger").LOG(m(),t,u);return d("MAWDexieTable").dexieResolve({dbMsg:null,outOfSyncEphemeralSetting:{chatJid:i.jid,correctEphemeralExpirationInSec:e.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:e.ephemeralLastUpdatedOrSetTimestamp}})}else{d("WALogger").WARN(l());return d("MAWDexieTable").dexieResolve(r)}d("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:d("WAJids").userIdFromJid(f),chatJid:i.jid,ephemeralSettingArgs:k,isEphemeralSettingReset:h}});return d("MAWDexieTable").dexieResolve(r)}q={ephemeralSetting:k,ephemeralSyncResponseBackoffInfo:void 0,userJid:j};return a.ephemeralSettings.put(q).then(function(){return r})}function b(a,b,e,f,g){var h=e;if(h<0)throw c("err")("Ephemeral duration should be 0 or more");var i=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return d("MAWDbThreadTxns").getThread(a,b).then(function(b){return!b.success?{success:!1}:a.ephemeralSettings.get({userJid:i}).then(function(b){if(!d("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(b,h,f))return{success:!1};b=b==null?{ephemeralSetting:{ephemeralExpirationInSec:h,ephemeralLastUpdatedOrSetTimestamp:f},userJid:i}:babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:h,ephemeralLastUpdatedOrSetTimestamp:f}});return a.ephemeralSettings.put(b).then(function(){return{success:!0}})})})}function e(a,b,e){var f=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return a.ephemeralSettings.get({userJid:f}).then(function(b){if(b==null||b.ephemeralSetting==null){q.ERROR(k(),f,b,b==null?void 0:b.ephemeralSetting);throw c("err")("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change")}b=babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:b.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e}});return a.ephemeralSettings.put(b).then(function(){})})}function f(a,b){a=d("WAJids").interpretAsUserJid(b);if(a==null)throw c("err")("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");a=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(b);if(a.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").castToUnixTime(0))return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"));return a!=null&&a.ephemeralExpirationInSec>0?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:b,correctEphemeralExpirationInSec:a.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:a.ephemeralLastUpdatedOrSetTimestamp}})):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"))}function t(a,b){return a.ephemeralSettings.get({userJid:b}).then(function(c){if((c==null?void 0:c.ephemeralSyncResponseBackoffInfo)==null){p.LOG(j(),b);return d("WAResultOrError").makeResult()}c.ephemeralSyncResponseBackoffInfo=void 0;p.LOG(i(),b);return a.ephemeralSettings.put(c).then(function(){return d("WAResultOrError").makeResult()})})}g.handleAndWriteIncomingEphemeralSetting=a;g.handleAndWriteOutgoingUserEphemeralSettingChange=b;g.updateContactWhenEphemeralSettingChangeMarkedSent=e;g.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=f;g.maybeResetEphemeralSyncResponseBackoffInfo=t}),98);
__d("MAWDbGroupInfoTxns",["MAWBridgeTypesCreators","MAWIndexedDb","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a,b.jid).then(function(c){var d=b.participantVersion;c.success&&c.value.participantVersion!=null&&b.participantVersion==null&&(d=c.value.participantVersion);c=b.subject.content;c!=null&&c.length===0&&(c=void 0);var e={creationTs:b.creationTs,creator:b.creator,groupJid:b.jid,inviter:b.inviter,memberAddMode:b.memberAddMode,name:c,nameOwner:b.subject.user,nameTs:b.subject.ts,participantVersion:d};return i(a,e).then(function(){return e})})}function h(a,b){return a.groupInfo.get({groupJid:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function i(a,b){return a.groupInfo.put(b).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(b)})})}function b(a,b){return a.groupInfo.bulkPut(b).then(function(){b.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}function c(a,b){return a.groupInfo.bulkGet(b)}function e(a,b){return a.groupInfo["delete"](b)}g.putGroupInfo=a;g.getGroupInfo=h;g.updateGroupInfo=i;g.bulkUpdateGroupInfo=b;g.getGroupInfos=c;g.deleteGroupInfo=e}),98);
__d("WAProtocolMsgId",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.externalId===b.externalId&&a.author===b.author&&a.chat===b.chat}f.equals=a}),66);
__d("MAWThreadSnippetBuildTxns",["$InternalEnum","FBLogger","I64","MAWBridgeTypesCreators","MAWCalculateBumpTimestampMs","MAWDbGroupInfoTxns","MAWDbMsg","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLocalizationType","MAWThreadSnippet","MAWThreadSnippetUtils","WAGlobals","WAJids","WALongInt","WAProtocolMsgId","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i=b("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","MATCH_BUMP_TIMESTAMPMS_TO_SNIPPET"]);function j(a,b,c){return d("MAWDexieTable").dexieAll([d("MAWDbGroupInfoTxns").getGroupInfo(a,d("WAJids").toGroupJid(b.threadJid))]).then(function(a){a=a[0];a=a.success;return d("MAWThreadSnippet").buildThreadSnippet(b,a,c)})}function a(a,b,c,e){return d("MAWDexieTable").dexieAll([d("MAWDbGroupInfoTxns").getGroupInfo(a,d("WAJids").toGroupJid(e))]).then(function(a){a=a[0];a=a.success;return k(b,c,a)})}function k(a,b,e){var f;d("WAJids").isAuthorMe(a)?(c("FBLogger")("maw_db").warn("[MAWThreadSnippetBuildTxns] Reaction snippet author should not be @me"),f=d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid())):f=d("WAJids").userIdFromJid(a);a={contactIDs:[],strings:[]};e=e?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE_IN_GROUP:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE;a.contactIDs.push(f);a.strings.push(b);return{snippetParams:a,snippetSenderContactId:f,snippetType:e}}function e(a,b,e,f){var g=e.newestReaction,h=e.reactionsToClear;if(g!=null&&d("WATimeUtils").castUnixTimeToMillisTime(g.ts)>((e=b.snippetMsgTs)!=null?e:0))return d("MAWDexieTable").dexieResolve({newestReaction:g,reactionsToClear:[],thread:l(b,g,f)});return h!=null&&b.snippetMsg!=null?a.reactions.get({reactionId:b.snippetMsg}).then(function(e){var f=!1;if(e==null)f=!0;else{var g=d("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.reactToExternalId);g!=null&&(f=h.some(function(a){a=d("MAWJidUtils").maybeToProtocolMsgId(a.author,a.threadJid,a.reactToExternalId);return a!=null&&d("WAProtocolMsgId").equals(a,g)}))}if(f){e=c("gkx")("405")?i.MATCH_BUMP_TIMESTAMPMS_TO_SNIPPET:i.DO_NOT_BUMP_THREAD;return m(a,b,e).then(function(a){return{newestReaction:null,reactionsToClear:h,thread:a}})}return d("MAWDexieTable").dexieResolve({newestReaction:null,reactionsToClear:[],thread:b})}):d("MAWDexieTable").dexieResolve({newestReaction:null,reactionsToClear:[],thread:b})}function l(a,b,c){var e=d("WATimeUtils").castUnixTimeToMillisTime(b.ts);c=k(b.author,b.reaction,c);var f=c.snippetParams,g=c.snippetSenderContactId;c=c.snippetType;var i=b.externalId!==void 0?(h||(h=d("I64"))).of_string_opt(b.externalId):void 0;e=b.senderTimestampMs!=null?(h||(h=d("I64"))).of_string(d("WALongInt").longIntToDecimalString(b.senderTimestampMs)):d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(e,i);d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:e,description:"newReaction",isMessageAuthorMe:!1,snippetParams:f,snippetSenderContactId:g,snippetType:c,threadJid:a.jid})});return babelHelpers["extends"]({},a,{snippetMsg:b.reactionId,snippetMsgTs:d("WATimeUtils").castUnixTimeToMillisTime(b.ts)})}function m(a,b,c,e){return d("MAWThreadSnippetUtils").findMostRecentSnippetMsgFromThread(a,b).then(function(f){if(f==null){d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:"0",snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET,threadJid:b.jid})});return babelHelpers["extends"]({},b,{snippetMsg:void 0,snippetMsgTs:void 0})}var g=e==null?void 0:e.get(f.externalId);return j(a,f,g).then(function(a){var e=a.snippetParams,g=a.snippetSenderContactId;a=a.snippetType;var j=d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(f));switch(c){case i.DO_NOT_BUMP_THREAD:d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:e,snippetSenderContactId:g,snippetType:a,threadJid:b.jid})});break;case i.MATCH_BUMP_TIMESTAMPMS_TO_SNIPPET:var k=d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(j,(h||(h=d("I64"))).of_string_opt(f==null?void 0:f.externalId));d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:k,description:"getRefreshThreadSnippetChangeset",isMessageAuthorMe:f.author==="@me",skipBumpTimestampValidation:!0,skipServerThreadBump:!0,snippetParams:e,snippetSenderContactId:g,snippetType:a,threadJid:b.jid})})}return babelHelpers["extends"]({},b,{snippetMsg:f.msgId,snippetMsgTs:j})})})}function f(a,b,c){return m(a,b,i.DO_NOT_BUMP_THREAD,c).then(function(b){return a.threads.put(b).then(function(){})})}g.buildThreadSnippet=j;g.buildReactionThreadSnippet=a;g.getReactionSnippetParams=k;g.getThreadChangesetForReactionChanges=e;g.getThreadChangesetForNewReaction=l;g.refreshThreadSnippet=f}),98);
__d("MAWEphemeralMsgTxns",["MAWBridgeMsgCountdown","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLocalizationType","MAWLoggerUtils","MAWThreadSnippetBuildTxns","MAWThreadSnippetUtils","WAJids","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is not out of sync"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is non-ephemeral"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS([(e=d("MAWLoggerUtils")).Tag.Ephemeral,e.Tag.SettingSync,e.Tag.Incoming]),p=d("WATagsLogger").TAGS([e.Tag.Ephemeral,e.Tag.OnRead,e.Tag.Countdown]);function q(a,b,c){c===void 0&&(c=function(){return!0});return d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,b,!1,!0).filter(c).limit(1).toArray().then(function(a){return{needsUpdate:!0,value:(a=a[0])!=null?a:null}})}function r(a,b,c){return c.size===0?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;var e=b.value;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadOldestMessageId(a,e.jid),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e)]).then(function(b){var f=b[0],g=b[1];if(f==null||g==null)return;b=d("MAWEphemeralMsgUtils").filterNonExpiredMsg(c);var h=c.has(f)?q(a,e.jid,b):d("MAWDexieTable").dexieResolve({needsUpdate:!1});b=c.has(g)?d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,e.jid,!0,!1).filter(b).reverse().limit(1).toArray().then(function(b){b=b[0];return b!=null&&d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(b)?d("MAWThreadSnippetUtils").findMostRecentSnippetMsgFromThread(a,e,c).then(function(a){return{needsUpdate:!0,value:(a=a)!=null?a:null}}):{needsUpdate:!0,value:(b=b)!=null?b:null}}):d("MAWDexieTable").dexieResolve({needsUpdate:!1});return d("MAWDexieTable").dexieAll([h,b]).then(function(b){var c=b[0],h=b[1];if(!c.needsUpdate&&!h.needsUpdate)return;b=h.needsUpdate?(b=(b=h.value)==null?void 0:b.msgId)!=null?b:void 0:g;var i=h.needsUpdate?h.value!=null?d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(h.value)):void 0:e.snippetMsgTs,j=babelHelpers["extends"]({},e,{newestMsg:b,oldestMsg:c.needsUpdate?(c=(c=c.value)==null?void 0:c.msgId)!=null?c:null:f,snippetMsg:b,snippetMsgTs:i});return a.threads.put(j).then(function(){if(h.needsUpdate){var b=h.value;if(b==null)d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:"0",snippetType:d("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET,threadJid:j.jid})});else return d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b).then(function(a){var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:j.jid})})})}})})})})}function a(a,b){if(b==null||b.ephemeralSetting==null||b.ephemeralSetting.ephemeralExpirationInSec===0)return d("MAWDexieTable").dexieResolve(b);var c=d("WATimeUtils").castToUnixTime(b.ts+b.ephemeralSetting.ephemeralExpirationInSec),e=d("WATimeUtils").castToUnixTime(c+d("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);return s(a,[{messageDeleteTs:e,messageExpirationTs:c,msgId:b.msgId,readTsForLogging:b.ts}]).then(function(a){var b=a[0],c=a[1];a=a[2];a.length>0&&(p.LOG(n(),a.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)}));b!=null&&c!=null&&d("MAWEphemeralCleaner").addNewEphemeralTimestamp(b,c);return a[0]})}function s(a,b){var c=b.map(function(a){return a.msgId});return d("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(a,c).then(function(d){var e=new Map();b.forEach(function(a){e.set(a.msgId,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging});var b=d.get(a.msgId);b!=null&&e.set(b,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging})});var f=null,g=null,h=[],i=Array.from(new Set(c.concat(Array.from(d.values()))));return a.messages.where("msgId").anyOf(i).toArray().then(function(b){if(b.length===0)return;b.forEach(function(a){var b=a.messageExpirationTs,c=a.messageDeleteTs,d=e.get(a.msgId),i=d==null?void 0:d.messageExpirationTs;d=d==null?void 0:d.messageDeleteTs;p.LOG(m(),a.msgId,b,c,i,d);if(i==null||d==null)return;if(a.ephemeralCounterStarted===!0)return;f==null?f=i:i<f&&(f=i);g==null?g=d:d<g&&(g=d);b=babelHelpers["extends"]({},a,{ephemeralCounterStarted:!0,messageDeleteTs:d,messageExpirationTs:i});h.push(b)});return a.messages.bulkPut(h)}).then(function(){return[f,g,h]})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();var c=[];b.forEach(function(b,d){c.push(r(a,d,b))});return d("MAWDexieTable").dexieAll(c).then(function(){})}function c(a,b,c,e,f,g){if(b==null||f==null)return d("MAWDexieTable").dexieResolve();o.LOG(l(),c,e.jid,b.type);var m=d("MAWDexieTable").dexieResolve();if(b.ephemeralSetting==null)d("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,c).then(function(){})},user:function(){d("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(b)&&(o.LOG(k()),m=d("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(a,e.jid).then(function(a){return a==null?void 0:(a=a.value)==null?void 0:a.outOfSyncEphemeralSetting}))}});else if(b.messageExpirationTs!=null&&b.messageDeleteTs!=null){var n=b.ephemeralSetting,p=b.messageDeleteTs,q=b.messageExpirationTs;o.LOG(j(),n.ephemeralExpirationInSec,n.ephemeralLastUpdatedOrSetTimestamp);d("MAWEphemeralCleaner").addNewEphemeralTimestamp(q,p);m=d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,c,f,n.ephemeralExpirationInSec,n.ephemeralLastUpdatedOrSetTimestamp,!1,e,g,null,!0).then(function(a){return a==null?void 0:a.outOfSyncEphemeralSetting})}return m.then(function(b){if(b!=null){o.LOG(i(),b.correctEphemeralExpirationInSec,b.correctEphemeralLastUpdatedOrSetTimestamp);return b}else{o.LOG(h());return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,c).then(function(){})}})}g.markEphemeralMessageAsSent=a;g.bulkUpdateEphemeralMessageTimestamps=s;g.updateThreadsOnMessagesExpiredFromUi=b;g.syncEphemeralSettingOnIncomingMsg=c}),98);
__d("isE2EEConversationSearchEnabled",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("518"))!=null?a:!1}g["default"]=a}),98);
__d("isE2EEUniversalSearchEnabled",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("772"))!=null?a:!1}g["default"]=a}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isE2EEUniversalSearchEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("isE2EEConversationSearchEnabled")()||c("isE2EEUniversalSearchEnabled")()}g["default"]=a}),98);
__d("MAWFTSTxns",["MAWDexieTable","isWAFTSContentSearchEnabled","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=c("justknobx")._("1146");function a(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeBacklog.put({externalId:b})}function b(a,b){return!c("isWAFTSContentSearchEnabled")()||!h?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.put({rowId:b})}function e(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeThreadBacklog.put({chatJid:b})}g.maybePutMessageToPurgeBacklog=a;g.maybePutMessageToBacklog=b;g.maybePutThreadToPurgeBacklog=e}),98);
__d("MAWGetMsgQuoteTxn",["MAWDbMsgTxns","MAWDexieTable","MAWMsgType","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a){return a==null||a===d("WAJids").AUTHOR_SYSTEM?null:d("WAJids").authorAsUserJid(a)};function i(a,b,c){var e=b.quote;b=(e==null?void 0:e.content)||{};var f=b.author;b=b.externalId;if(f==null)return d("MAWDexieTable").dexieResolve(null);f=d("WAJids").isAuthorMe(f)?d("WAJids").AUTHOR_ME:h(f);if(e==null||f==null||b==null)return d("MAWDexieTable").dexieResolve(null);f={author:f,chat:c,externalId:b};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f).then(function(b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return{quote:e,quoteExternalId:e.content.externalId};var a=b.author,c=b.externalId,f=b.mediaId,g=b.msgContent,h=b.msgId,i=b.plaintextHash,j=b.specialTextSize,k=b.ts,l=b.type,m=b.xmaMessageType;a={author:a,externalId:c,mediaId:f,msgContent:g,msgId:h,plaintextHash:i,specialTextSize:j,ts:k,type:l,xmaMessageType:m};b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(a=babelHelpers["extends"]({},a,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL}));return{quote:babelHelpers["extends"]({},e,{content:a}),quoteExternalId:b.externalId}})}function a(a,b,c){return i(a,b,c).then(function(a){return babelHelpers["extends"]({},b,{quote:a==null?void 0:a.quote,quoteExternalId:a==null?void 0:a.quoteExternalId})})}g.getMsgQuoteInfo=i;g.enhanceMsgWithQuoteInfo=a}),98);
__d("MAWThreadEvent",["LSContactUtils","MAWBridge","MAWBridgeSendAndReceive","MAWContactRelationshipType","MAWJobDefinitions","MAWUIJob","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";b="placeholderConvertSubscription";function a(a,b,e){d("MAWBridge").getBridge().setHandlers("threadEvent",{placeholderConvertSubscription:function(f){var g=f.chatJid;f=f.msgId;a===g&&c("promiseDone")(d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:f}).then(function(a){if(a==null)return;d("MAWUIJob").UIJobStarters.fireAndForget(d("MAWJobDefinitions").jobSerializers.markThreadAsRead(g,b&&d("MAWContactRelationshipType").getContactRelationshipType(b),b?d("LSContactUtils").isContactBlocked(b):!1,b?d("LSContactUtils").isContactRestricted(b):!1,a,e))}))}})}g.PLACEHOLDER_CONVERT_SUBSCRIPTION=b;g.setThreadEventHandler=a}),98);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDexieTable","MAWIndexedDb","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g,h){var i=d("MAWAuthor").getAuthorUserJid(e);return a.messages.where("quoteExternalId").equals(c).toArray().then(function(c){if(c.length===0)return;var e=c;(h==null||!h)&&(e=c.filter(function(a){var c=a.quote;a=a.threadJid;return d("MAWAuthor").getAuthorUserJid(c==null?void 0:c.content.author)===i&&a===b}));var j=e.map(function(a){var b;b=Object.assign({},(b=a.quote)==null?void 0:b.content,f.content);b=babelHelpers["extends"]({},a.quote,f,{content:b});b.content.msgId==null&&g!=null&&(b.content.msgId=g);return babelHelpers["extends"]({},a,{quote:b})});return a.messages.bulkPut(j).then(function(){return j})})},i=function(a,b,c,e,f){f===void 0&&(f=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);f={content:{mediaId:void 0,msgContent:void 0,type:f}};return h(a,b,c,e,f).then(function(a){if(a==null)return;a.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})};a=function(a,b,c){c===void 0&&(c=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=b.author,f=b.chat,g=b.externalId;return a.threads.get({jid:f}).then(function(b){if(b==null)return;return i(a,b.jid,g,e,c)})};b=function(a,b,c,e){var f=c.author,g=c.externalId,i=c.mediaId,j=c.msgContent,k=c.msgId,l=c.plaintextHash,m=c.ts;c=c.type;if(!d("MAWMsgType").isQuotedMsgType(c))return d("MAWDexieTable").dexieResolve();i={author:f,externalId:g,mediaId:i,msgContent:j,plaintextHash:l,ts:m,type:c};return h(a,b,g,f,{content:i},k,e)};g.disassociateQuotedMsg=i;g.disassociateQuotedMessageByProtocolMsgId=a;g.associateQuotedMessage=b}),98);
__d("MAWBridgeParticipants",["WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.deliveredWatermarkTs,c=a.lastReadActionTs,e=a.lastReadWatermarkTs,f=a.threadJid,g=a.type;a=a.userJid;return{deliveredWatermarkTs:b||d("WATimeUtils").castToUnixTime(0),fbid:d("WAJids").extractUserId(a),isAdmin:g==="superadmin"||g==="admin",isInvited:g==="invitedParticipant",isSuperAdmin:g==="superadmin",lastReadActionTs:(b=c)!=null?b:d("WATimeUtils").castToUnixTime(0),readWatermarkTs:e||d("WATimeUtils").castToUnixTime(0),threadJid:f}}function a(a){return{participants:a.map(function(a){return h(a)})}}g.createBridgeParticipant=h;g.createBridgeParticipants=a}),98);
__d("MAWDbParticipantTxns",["FBLogger","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","WAGlobals","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,d,e){d===void 0&&(d="participant");return h(a,b,[{addressable:e,type:d,userJid:c}]).then(function(a){return a[0]})}function h(a,b,c){return j(a,c.map(function(a){return babelHelpers["extends"]({},a,{threadJid:b})}))}function i(a,b){d("WAJids").switchOnMsgrChatJidType(a.threadJid,{group:function(){},user:function(e){a.userJid!==e&&a.userJid!==d("WAGlobals").getMyUserJid()&&c("FBLogger")("messenger_web_devx").mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",b)}})}function j(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var c=[];b.forEach(function(a){var b=a.addressable,e=a.threadJid,f=a.type;a=a.userJid;c.push({addressable:b,deliveredWatermarkTs:d("WATimeUtils").castToUnixTime(0),id:d("MAWDbParticipant").craftParticipantId(e,a),lastReadWatermarkTs:d("WATimeUtils").castToUnixTime(0),threadJid:e,type:f,userJid:a})});c.forEach(function(a){return i(a,"bulkAddParticipantsInThreads")});return a.participants.bulkPut(c).then(function(){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(c)});return c})}function b(a,b,c){return p(a,b).then(function(e){var f=[],g=new Set(c.map(function(a){return a.userJid}));for(var i=e,j=Array.isArray(i),k=0,i=j?i:i[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var m;if(j){if(k>=i.length)break;m=i[k++]}else{k=i.next();if(k.done)break;m=k.value}m=m;var n=g.has(m.userJid);n||f.push([m.threadJid,m.userJid])}n=[];m=new Set(e.map(function(a){return a.userJid}));for(k=0;k<c.length;k++){j=c[k];i=m.has(j.userJid);i||n.push(j)}f.length>0&&d("MAWODSProxy").odsBumpEntityKey({amount:1,entity:d("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:d("MAWCurrentUser").isEmployee()?"employee":"public"});return d("MAWDexieTable").dexieAll([h(a,b,n),l(a,f)]).then(function(a){var b=a[0];a[1];a=c.reduce(function(a,c){var d=b.find(function(a){return a.userJid===c.userJid}),f=e.find(function(a){return a.userJid===c.userJid});d!=null&&f==null?a.push(d):f!=null&&a.push(f);return a},[]);return a})})}function e(a,b){b.forEach(function(a){return i(a,"bulkUpdateParticipants")});return a.participants.bulkPut(b).then(function(){b.length>0&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(b)});return b})}function f(a,b,c){if(c.length===0)return d("MAWDexieTable").dexieResolve();c=c.map(function(a){return[b,a]});return l(a,c)}function k(a,b,c){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=b.map(function(a){return[a,c]});return l(a,b)}function l(a,b){return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(b){return a.participants.bulkDelete(b.map(function(a){return a.id})).then(function(){return a.threads.where("jid").anyOf(Array.from(new Set(b.map(function(a){return a.threadJid})))).toArray()}).then(function(a){var c=new Map(a.map(function(a){return[a.jid,a.chatId]}));b.forEach(function(a){var b=c.get(a.threadJid);b!=null&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:a.threadJid,userId:d("WAJids").extractUserId(a.userJid)}})})})})}function m(a,b){return a.participants.where("threadJid").equals(b)["delete"]()}function n(a,b,c,d,e){return o(a,[{deliveredWatermarkTs:c,lastReadActionTs:e,lastReadWatermarkTs:d,participantKey:b}]).then(function(a){return a[0]})}function o(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var c=new Map(),e=[];b.forEach(function(a){e.push(a.participantKey),c.set(JSON.stringify(a.participantKey),a)});return a.participants.where(["threadJid","userJid"]).anyOf(e).toArray().then(function(b){var e=[],f=[];b.forEach(function(a){var b=c.get(JSON.stringify([a.threadJid,a.userJid]));if(b==null)return;var d=b.deliveredWatermarkTs,g=b.lastReadActionTs;b=b.lastReadWatermarkTs;var h=a.deliveredWatermarkTs,i=a.lastReadWatermarkTs,j=a.lastReadActionTs,k=d>h,l=b>i,m=j==null||g>j;if(!k&&!l&&!m){f.push(a);return}e.push(babelHelpers["extends"]({},a,{deliveredWatermarkTs:k?d:h,lastReadActionTs:m?g:j,lastReadWatermarkTs:l?b:i}))});e.forEach(function(a){return i(a,"bulkUpdateParticipantTimestamps")});return a.participants.bulkPut(e).then(function(){e.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:d("MAWBridgeTypesCreators").createBridgeReceivedReceipt(a.threadJid,d("WAJids").extractUserId(a.userJid),a.deliveredWatermarkTs,a.lastReadWatermarkTs,a.lastReadActionTs)})});return[].concat(e,f)})})}function p(a,b){return a.participants.where("threadJid").equals(b).toArray()}function q(a,b){return a.participants.where("threadJid").anyOf(b).toArray()}function r(a,b){return p(a,b).then(function(a){return a.filter(function(a){return a.type==="invitedParticipant"})})}function s(a,b,c){return a.participants.where(["threadJid","userJid"]).equals([b,c]).first().then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function t(a,b){return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(a){var c=new Map(a.map(function(a){return[JSON.stringify([a.threadJid,a.userJid]),a]}));return b.map(function(a){return c.get(JSON.stringify(a))})})}g.addParticipant=a;g.bulkAddParticipants=h;g.logIfIllegalParticipant=i;g.bulkAddParticipantsInThreads=j;g.bulkUpsertParticiantsInThread=b;g.bulkUpdateParticipants=e;g.bulkDeleteParticipantsInThread=f;g.bulkDeleteParticipantAcrossThreads=k;g.bulkDeleteParticipants=l;g.deleteAllParticipantsForThread=m;g.updateParticipantTimestamps=n;g.bulkUpdateParticipantTimestamps=o;g.getParticipantsInThread=p;g.getParticipantsInThreads=q;g.getInvitedParticipantsInThread=r;g.getParticipant=s;g.bulkGetParticipants=t}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWDbMsg").getCanonicalTsFromMsg(b),e=b.author;return e!=="@me"&&e!=="@system"?d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[b.threadJid,e],c,c,c):d("MAWDexieTable").dexieResolve()}g.updateParticipantTimestampsForMsg=a}),98);
__d("MAWWriteDeleteMessageTxns",["MAWAckLevel","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWUploadMessagesBackup","MAWXMAUtils","WAResultOrError","WATimeUtils","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b){var c=b.protocolMsgId,e=c.author;b=c.chat;var f=c.externalId;return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b),a.unrenderedMessages.get({externalId:f}),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,f)]).then(function(b){var g=b[0];b=b[1];if(!g.success)return d("WAResultOrError").makeError("missing_thread");return b!=null&&b.threadJid===g.value.jid&&b.author===e?d("WAResultOrError").makeError("duplicate_delete_for_me"):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c).then(function(b){if(b==null){var h={ack:d("MAWAckLevel").ACK.received,author:e,externalId:f,threadJid:g.value.jid,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i);h={deleteTs:k,externalIdWithType:f+"_"+d("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:h,type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return a.pendingStanzas.add(h).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);return d("WAResultOrError").makeResult()})}return d("MAWDexieTable").dexieResolve(j(a,b,e,c.chat,g.value)).then(function(){return d("WAResultOrError").makeResult()})})})}function j(a,b,e,f,g){var i,j=d("MAWDexieTable").dexieResolve();d("MAWXMAUtils").isXMAStoryReply((i=b.quote)==null?void 0:i.content.xmaMessageType)&&(j=k(a,b));var l={ack:b.ack,author:e,externalId:b.externalId,mediaId:b.mediaId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(i=d("MAWDbMsg").getMsgContent(b))==null?void 0:i.content,msgId:b.msgId,quote:b.quote,reportingMeta:b.reportingMeta,serverTs:c("justknobx")._("1753")?void 0:b.serverTs,threadJid:f,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:b.xmaMessageType};i=d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId),j]).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});c("gkx")("23914")&&c("justknobx")._("1071")&&d("MAWUploadMessagesBackup").sendDeleteEchoMessage(b,g.jid);if(d("MAWDbMsg").isMediaMsg(b)){var e=b.mediaId,f=b.plaintextHash;e!=null&&(c("gkx")("2419")&&f!=null?d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,plaintextHash:f,threadJid:b.threadJid}}):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,threadJid:b.threadJid}}))}return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,g)});return d("MAWDexieTable").dexieAll([i,a.unrenderedMessages.add(l),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:e,chatJid:b.threadJid,externalId:b.externalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,b.threadJid,b.externalId,b.author,d("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return d("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(a,g.jid,b.msgId,b.sortOrderMs).then(function(){d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(l.messageDeleteForMeTs);return d("WAResultOrError").makeResult()})})}function k(a,b){return d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b==null?void 0:b.msgId).then(function(b){if(b!=null)return d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId)})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.handleDeleteForMe=a;g.deleteXMAStoryReplyMsg=k}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});f.DbDeletedMsgReasonEnum=a}),66);
__d("MAWUnsendMsgContentCleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startUnsendMsgContentCleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function b(a){if(k==null){var b="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startUnsendMsgContentCleaner=a;g.addNewUnsendMsgContentCleanerTimestamp=b;g.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWUploadMessagesBackup","MAWWriteDeleteMessageTxns","MAWXMAUtils","WATimeUtils","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b,e,f,g){var h=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i),k=b.author,m=b.externalId,n=b.revokedExternalId,o=g!=null?l(a,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f==null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.revokedExternalId,e.jid,b.author):d("MAWDexieTable").dexieResolve(f),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,m)]).then(function(g){var i=g[0];(f==null||i!=null)&&c("FBLogger")("messenger_web_devx").warn("Revoked message missing originalMsg incorrectly");if(i==null){g={deleteTs:h,externalIdWithType:n+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:k,externalId:m,revokedExternalId:n,threadJid:e.jid,ts:b.ts,type:"Revoked"},type:d("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return d("MAWDexieTable").dexieAll([a.pendingStanzas.add(g),o]).then(function(b){b[0];b=b[1];d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(h);b===!0&&d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e)})}return o.then(function(){return j(a,i,e,b.externalId,b.revokedExternalId,b.serverTs,b.ts,!1)})})}function j(a,b,c,e,f,g,i,j){var l=babelHelpers["extends"]({},b,{altIndex:void 0,externalId:e,msgContent:d("MAWDbMsg").getMsgContent(b),originalTs:(e=b.serverTs)!=null?e:b.ts,revokedExternalId:f,serverTs:g,threadJid:c.jid,ts:i,type:"Revoked",unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)});if(j){d("MAWUploadMessagesBackup").sendDeleteEchoMessage(b,c.jid);return d("MAWDexieTable").dexieResolve(l)}return k(a,b,l,c).then(function(){return l})}function k(a,b,e,f,g){var h;g===void 0&&(g=!1);h=d("MAWXMAUtils").isXMAStoryReply((h=b.quote)==null?void 0:h.content.xmaMessageType)?d("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(a,b):d("MAWDexieTable").dexieResolve();var i=d("MAWJidUtils").toProtocolMsgId(b);i=i!=null?a.deletedMessages.add(babelHelpers["extends"]({},i,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([a.messages.put(e),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:e.author,chatJid:e.threadJid,externalId:e.revokedExternalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,e.threadJid,e.revokedExternalId,e.author,d("MAWMsgType").MSG_TYPE.REVOKED),h,i,d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(){g||d("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(e.unsendMsgContentDeleteTs);return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,f)}).then(function(){b!=null&&d("MAWUploadMessagesBackup").sendDeleteEchoMessage(b,b.threadJid);d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e)});if(b!=null&&d("MAWDbMsg").isMediaMsg(b)){var a=b.mediaId,f=b.plaintextHash;a!=null&&(c("gkx")("2419")&&f!=null?d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:b.msgId,plaintextHash:f,threadJid:b.threadJid}}):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:b.msgId,threadJid:b.threadJid}}))}d("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(b)})}function b(a,b,e){if(b.type!==d("MAWMsgType").MSG_TYPE.REVOKED)throw c("err")("Cant mark unrevoked message revoked");var f=d("MAWJidUtils").toProtocolMsgId(b);f=f!=null?a.deletedMessages.add(babelHelpers["extends"]({},f,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:b.author,chatJid:b.threadJid,externalId:b.revokedExternalId}]),d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e),f]).then(function(){d("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(b.unsendMsgContentDeleteTs),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b)})})}function l(a,b){return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?a.messages["delete"](b.rowId).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});return!0}):d("MAWDexieTable").dexieResolve(!1)}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.writeIncomingRevokeMsg=a;g.revokeUnstoredMsg=j;g.markExistingMsgRevoked=k;g.markIncomingMessageRevoked=b}),98);
__d("MAWConstants",[],(function(a,b,c,d,e,f){"use strict";a=5;b="Facebook user";c="Instagram user";d=24;e=3;var g=50;f.MESSAGE_RETRY_COUNT_LIMIT=a;f.FB_UNKNOWN_USER=b;f.INS_UNKNOWN_USER=c;f.MAX_APPDATA_RECIPIENTS=d;f.CURRENT_REGISTRATION_VERSION=e;f.BRIDGE_UPLOAD_BATCH_SIZE=g}),66);
__d("MAWEBBackendQPLUtils",["MAWEBSwitch","MAWQplProxy","Random","WAHashStringToNumber","gkx","hashString","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b=(b=b)!=null?b:c("Random").uint32();d("MAWQplProxy").startQplUserFlow(c("qpl")._(521479468,"1752"),{"int":{numMessagesRestored:0},string:{threadId:a}},b);return b}function b(a,b){d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521479468,"1752"),{string:{threadId:b}},a)}function e(a){return a.dyiBatch.each(function(a){if(a.isThread===!1)return;d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_error",{string:{threadId:a.threadId}},a.qplInstanceKeyForThread)})}function f(a,b){if(b.qplInstanceKeyForThread==null)return;a=a===!1?"dyi_backup_restore_continuing":"dyi_backup_restore_finished";var e=b.qplInstanceKeyForThread;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521479468,"1752"),a,{annotations:{"int":{numMessages:b.numMessages,numMessagesRestored:b.numMessagesRestored},string:{threadId:b.threadId}},instanceKey:(a=e)!=null?a:void 0})}function h(a,b){if(a==null)return;d("MAWQplProxy").sendQPLErrorThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_thread_halted",{debugInfo:"DYI attempting to re-restore previous batch - halting DYI for thread "+b,instanceKey:a})}function i(a,b){if(a==null)return;d("MAWQplProxy").sendQPLErrorThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_batch_not_in_progress",{debugInfo:"DYI for thread with jid "+b+" is not currently in progress",instanceKey:a})}function j(a,b){if(a==null)return;d("MAWQplProxy").sendQPLErrorThroughBridge(c("qpl")._(521479468,"1752"),"dyi_backup_restore_stopping_dyi",{debugInfo:"Error occurred on restore - stopping DYI for thread with chat jid "+b,instanceKey:a})}function k(a,b){if(a==null)return;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521478596,"1329"),"dyi_get_thread_list",{annotations:{"int":{threadsToRestore:b}},instanceKey:a})}function l(a){return c("hashString")(a)}function m(a,b){if(c("gkx")("23946")!==!0)return;var e=l(b);d("MAWQplProxy").startQplUserFlow(c("qpl")._(521485625,"1876"),{bool:{eb_switch:c("MAWEBSwitch").isEnabled(),is_retroactive_backups_upload:a},string:{trace_id:b}},e)}function n(a,b,e){if(c("gkx")("23946")!==!0||a==null)return;a=l(a);d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521485625,"1876"),b,{annotations:e,instanceKey:a})}function o(a,b,e){if(c("gkx")("23946")!==!0||a==null)return;a=l(a);d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521485625,"1876"),b,e,a)}function p(a,b,e){if(a==null)return;a=d("WAHashStringToNumber").hashStringToNumber(a);d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(521485815,"2166"),b,{annotations:e,instanceKey:a})}function q(a,b,e){if(a==null)return;a=d("WAHashStringToNumber").hashStringToNumber(a);d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521485815,"2166"),b,e,a)}g.startDYIBackupRestoreQplUserFlow=a;g.endSuccessDYIBackupRestoreQplUserFlow=b;g.cleanupDYIBackupRestoreQplUserFlow=e;g.addPointDYIBackupRestoreQplUserFlow=f;g.markErrorDyiBackupRestoreThreadHalt=h;g.markErrorDyiBackupRestoreBatchNotInProgress=i;g.markErrorDyiBackupRestoreStoppingDyi=j;g.logDyiE2EGetThreadList=k;g.getQplInstanceKey=l;g.startEBBackupUploadQplUserFlow=m;g.addPointEBBackupUpload=n;g.endFailEBBackupUpload=o;g.logMediaRestoreFromMIQPLPoint=p;g.logMediaRestoreFromMIQPLEndFailure=q}),98);
__d("MAWEncryptedBackupCacheManager",[],(function(a,b,c,d,e,f){"use strict";var g=new Map(),h=new Map(),i=new Map();function a(a,b){h.set(a,{cache:b,status:"restoring"})}function b(a){a.forEach(function(a){var b=h.get(a);b!=null&&h.set(a,{cache:b.cache,status:"done"})})}function c(a){a=h.get(a);if(a!=null)return a.status;else return"none"}function d(a){return(a=h.get(a))==null?void 0:a.cache}function e(a){return h["delete"](a)}function j(a,b){var c=g.get(a)||new Set();c.add(b);g.set(a,c)}function k(a,b){a=g.get(a);return a!=null?a==null?void 0:a.has(b):!1}function l(a,b){a=g.get(a);a!=null&&a["delete"](b)}function m(a){return h.has(a)}function n(a){return i.has(a)}function o(a){return i.get(a)}function p(a){n(a)&&i["delete"](a)}function q(a,b){i.set(a,b)}f.restoredCache=h;f.addMsgEntryToRestoredCache=a;f.setRestoredCacheStatusAsDone=b;f.getRestoredCacheStatus=c;f.getRestoredCache=d;f.removeFromRestoredCache=e;f.addMsgEntryToReuploadCache=j;f.checkForMsgEntryInReuploadCache=k;f.removeMsgEntryFromReuploadCache=l;f.peekRestoreCache=m;f.peekPendingStanzaCache=n;f.getPendingStanzaCacheValue=o;f.removePendingStanzaCacheValue=p;f.addPendingStanzaToPendingStanzaCache=q}),66);
__d("MAWUploadMessagesBackup",["$InternalEnum","EchoBackupCompareUtils","EchoMessage","LSDataTraceCheckPoint","LSDataTraceType","LSEBPayloadSerializerError","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeEventTransmitter","MAWBridgeTrace","MAWBridgeUpload","MAWConstants","MAWDbMsg","MAWDbMsgTxns","MAWDbMsgUtil","MAWDbPendingStanza","MAWDbThreadTxns","MAWDbXMA","MAWDexieTable","MAWEBBackendQPLUtils","MAWEBSwitch","MAWEBUploadMessageUtils","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWHMACKey","MAWHandlePendingStanzasInRestoreV2","MAWIndexedDb","MAWJobManager","MAWMsgType","MAWQplProxy","MAWTraceUtils","MAWTransactionMode","Promise","WAGlobals","WAJids","WALogger","WAMediaUtils","WAProtocolMsgId","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","cr:5916","gkx","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot proceed with encodeAndSendEchoMessage: Encrypted Backups are not enabled"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot proceed with encodeAndSendEchoMessage: Encrypted Backups are not enabled"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Duplicated upload stopped by cache, extId: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid is null for pendingStanza"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanzaMessageType: "," not supported"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unhandled error in uploadMessagesBackup job: ",""]);u=function(){return a};return a}var v=c("requireDeferred")("EchoSerializationFailureFalcoEvent").__setRef("MAWUploadMessagesBackup"),w=c("requireDeferred")("EchoSerializationSuccessFalcoEvent").__setRef("MAWUploadMessagesBackup"),x=d("MAWJobManager").getPersistedJobsApi().definePersistedJob().finalStep("echoSerialization",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.messageIds,c=a.oldTraceIdMap,e=a.pendingStanzaIds,f=a.reactionIds,g=a.uploadTrackingInstanceMap;a=a.xmaIds;try{a=d("MAWDbXMA").convertNumbersToXMAIds(a);e=(e=e)!=null?e:[];yield z(b,e,f,a,c,g)}catch(a){d("WALogger").ERROR(u(),a)}});return function(b){return a.apply(this,arguments)}}()).end();function a(a){return a==null?[]:a.filter(Boolean).map(function(a){if(a!=null)return d("MAWDbMsg").toMsgId(a)}).filter(Boolean)}var y=b("$InternalEnum").Mirrored(["FATAL","WARN"]);function z(a,b,c,d,e,f){a=E(a,b,c,d).then(function(a){return Q(a,void 0,!1,e,f)});return a.then(function(){})}function A(a,b){return a.messages.bulkGet(b).then(function(a){return a.filter(Boolean)})}function B(a,b){return a.pendingStanzas.bulkGet(b).then(function(a){return a.filter(Boolean).map(function(a){var b=a.pendingContent.type;if(b==null||b!==d("MAWDbPendingStanza").PENDING_TYPE.REVOKED&&b!==d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME){d("WALogger").WARN(t(),b);return}b=a.pendingContent.content.externalId;if(b==null){d("WALogger").WARN(s());return}b=a.pendingContent.content.threadJid;if(b==null){d("WALogger").WARN(r());return}d("MAWHandlePendingStanzasInRestoreV2").issuePointQueryForPendingStanza(a)})}).then(function(a){return[]})}function C(a,b){return a.reactions.bulkGet(b).then(function(b){b=b.filter(Boolean).map(function(b){return d("MAWDbThreadTxns").getThread(a,b.threadJid).then(function(e){var f=e.success?e.value:null;if(f!=null&&f.chatId!=null){e=b.reactToAuthor;e=e===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:e;return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.reactToExternalId,f.jid,e).then(function(a){if(a==null&&!d("MAWEncryptedBackupCacheManager").peekRestoreCache(b.reactToExternalId)){var e=d("WAJids").threadIdForChatJid(f.jid);d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(f.jid,b.reactToExternalId);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.reactToExternalId,e,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,f.jid)}return a})}})});return d("MAWDexieTable").dexieAll(b).then(function(a){return a.filter(Boolean)})})}function D(a,b){b=b.filter(Boolean);return a.xma.bulkGet(b).then(function(b){b=b.map(function(a){return a==null?void 0:a.associatedMessageId}).filter(Boolean);return a.messages.where("msgId").anyOf(b).toArray()})}var E=d("MAWIndexedDb").makeMsgrTransactor({messages:(j=d("MAWTransactionMode")).READONLY,pendingStanzas:j.READONLY,reactions:j.READONLY,threads:j.READONLY,xma:j.READONLY},"uploadMsgBackupGetMsgs",function(a){return function(b,c,d,e){return S(a,b,c,d,e)}});function F(a,b,c){b.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").addPoint(a.uploadTrackingInstanceKey,"fire_ui_event")}),G({tag:"UploadMessageByBatch",value:{checkPoint:a,messages:b,qpl:c}})}function G(a){a=[a];d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:a})}function H(a,b,e){var f=[],g=[];if(a!=null){var h=c("gkx")("23946"),j=c("qpl")._(521485625,"1876");b.forEach(function(b){var c=b.checkPoint;b=b.pointName;h&&b!=null&&f.push({action:{name:b,type:"point"},annotations:null,event:j,instanceKey:d("MAWEBBackendQPLUtils").getQplInstanceKey(a),timestamp:d("MAWQplProxy").performanceAbsoluteNow()});g.push(d("MAWBridgeTrace").createBridgeTraceRecordCheckpointData((i||(i=d("LSIntEnum"))).ofNumber(c),(b=e)!=null?b:a,void 0,!1,-1,void 0))})}return{checkPointArray:g,qplArray:f}}function I(a,b,c,e,f,g,h){var i=b.xOfflineThreadingId;if(i==null)return!1;var j=d("WAStanzaUtils").toStanzaId(i);if(d("MAWEncryptedBackupCacheManager").getRestoredCacheStatus(j)==="done"){var k=d("EchoBackupCompareUtils").buildEchoDocCacheValue(b);k=d("EchoBackupCompareUtils").echoEquals(k,d("MAWEncryptedBackupCacheManager").getRestoredCache(j));d("MAWEncryptedBackupCacheManager").removeFromRestoredCache(j);if(k){d("WALogger").LOG(q(),j);return!1}}if(c!=null&&e!=null){k=window.performance.now();var l=d("EchoMessage").encodeEchoMessage(b),m=window.performance.now();h=h==null?void 0:h.get(j);if(h==null&&b.mediaData!=null){j=b.mediaData.xAttachmentType;h={mediaObjectId:d("WAMediaUtils").stringToDeliveryObjectId(b.mediaData.attachmentObjectId),mediaType:j}}a.push(d("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,attachmentContext:h,authTs:c.serverTs,echoDocument:l,echoEncodingLatencyNs:(m-k)*1e6,errorCode:null,errorMessage:null,messageId:i,messageType:c.type,productType:"msgr",protoMsg:f,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(c),threadId:b.threadId,traceId:e,uploadTrackingInstanceKey:N(g,c.externalId)}));O("point",g,c.externalId,"construct_echo_success");K(c.externalId,e);return!0}return!1}function J(a,b){a!=null&&void v.load().then(function(c){return c.log(function(){return{message_id:a,trace_id:b}})})}function K(a,b){a!=null&&void w.load().then(function(c){return c.log(function(){return{message_id:a,trace_id:b}})})}function L(a,b,c){if(a==null||b==null)return c;else{b=N(b,a.externalId);if(b!=null)return b.toString();else return c}}function M(a,e,f,g){var h=new Map();a.forEach(function(a){return h.set(a.dbMsg.externalId,a)});return R(a).then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=[],j=[],k=[];a.forEach(function(a){var l,m=h.get(a.externalId)||{dbMsg:null,traceId:null},n=m.dbMsg;m=m.traceId;l=n!=null?(l=e==null?void 0:e.find(function(a){var b=d("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(n);return b==null?!1:d("WAProtocolMsgId").equals(a.msgId,b)}))!=null?l:void 0:void 0;var o=a.echoMessage,q=[],r=L(n,f,m);if(a.maybeErrorDetail!=null){a=a.maybeErrorDetail;if(n!=null&&m!=null)if(a.uploadErrorType===y.WARN||a.errorCode===c("LSEBPayloadSerializerError").MEDIA_INFO_INVALID){var s;s=a.uploadErrorType===y.WARN?"possible error when constructing echo message: "+((s=a.errorMsg)!=null?s:""):"media info invalid thrown from constructEchoMessage, error msg: "+((s=a.errorMsg)!=null?s:"");d("WALogger").WARN(p(),s);O("success",f,n.externalId,"construct_echo_success_media/xma_warn/error",{string:{errorMsg:s}});J(n.externalId,m)}else{b.push(d("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:n.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:a.errorCode,errorMessage:a.errorMsg,messageId:(s=o==null?void 0:o.xOfflineThreadingId)!=null?s:"0",messageType:n.type,protoMsg:l,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(n),threadId:(s=o==null?void 0:o.threadId)!=null?s:"0",traceId:m,uploadTrackingInstanceKey:N(f,n.externalId)}));O("fail",f,n.externalId,"construct_echo_failed",{string:{errorMsg:(s=a.errorMsg)!=null?s:"null error msg, msg type: "+n.type}});K(n.externalId,m)}return}if((o==null?void 0:o.xOfflineThreadingId)==null){if(n!=null&&m!=null){b.push(d("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:n.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:c("LSEBPayloadSerializerError").OTID_NOT_FOUND_IN_ACT_MESSAGES,errorMessage:null,messageId:"0",messageType:n.type,protoMsg:l,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(n),threadId:(a=o==null?void 0:o.threadId)!=null?a:"0",traceId:m,uploadTrackingInstanceKey:N(f,n.externalId)}));O("fail",f,n.externalId,"construct_echo_failed",{string:{errorMsg:"oitd not found"}});K(n.externalId,m)}}else{s=I(b,o,n,m,l,f,g);if(!s){n!=null&&O("success",f,n.externalId,"construct_echo_success_duplicate_message",{string:{errorMsg:"not unique from cache"}});return}}q.push({checkPoint:c("LSDataTraceCheckPoint").LABYRINTH_WEB_UPLOAD_ISSUE_MESSAGE_UPLOAD_UI_EVENT,pointName:"issue_message_upload_ui_event"});a=H(m,q,r);o=a.checkPointArray;l=a.qplArray;j.push.apply(j,l);k.push.apply(k,o);d("MAWTraceUtils").startNewTrace((i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_UPLOAD),d("MAWTraceUtils").CONTEXT_BACKUP_UPLOAD,r);(b.length>=d("MAWConstants").BRIDGE_UPLOAD_BATCH_SIZE||k.length>=d("MAWConstants").BRIDGE_UPLOAD_BATCH_SIZE)&&(F(k.slice(),b.slice(),j.slice()),k.length=0,b.length=0,j.length=0)});(b.length>0||k.length>0)&&F(k,b,j);return a});return function(b){return a.apply(this,arguments)}}())}function N(a,b){return a.get(b)}function O(a,b,c,e,f){b=N(b,c);if(b!=null)switch(a){case"success":d("MAWEBUploadTrackingUtils").endSuccess(b,e,f);break;case"fail":d("MAWEBUploadTrackingUtils").endFail(b,e,f);break;case"point":d("MAWEBUploadTrackingUtils").addPoint(b,e,f);break}}function P(a){var b=new Set(),c=[];a.forEach(function(a){var e=a.externalId+"|"+d("WAJids").threadIdForChatJid(a.threadJid)+"|"+a.author;d("MAWEncryptedBackupCacheManager").getRestoredCacheStatus(a.externalId)!=="restoring"&&!b.has(e)&&(b.add(e),c.push(a))});return c}function Q(a,e,f,g,i,j){if(!c("MAWEBSwitch").isEnabled()){d("WALogger").LOG(o());i.forEach(function(a,b){d("MAWEBUploadTrackingUtils").endSuccess(a,"upload_tracking_cancelled_eb_turned_off_upload",{string:{externalId:b,from:"uploadUniqueMessage"}})});return(h||(h=b("Promise"))).resolve()}a=P(a).filter(function(a){return d("MAWEBUploadTrackingUtils").isUploadSupported(a)}).map(function(a){var b;b=(b=f)!=null?b:!1;b={bool:{isMedia:d("MAWMsgType").isMAWSupportedMediaType(a.type),isRetroactiveBackupsUpload:b},string:{msgType:a.type}};O("point",i,a.externalId,"construct_echo_start",b);b=((b=N(i,a.externalId))!=null?b:d("MAWTraceUtils").createTraceId()).toString();d("MAWEBBackendQPLUtils").startEBBackupUploadQplUserFlow(f,b);f!=null&&f&&d("MAWEBBackendQPLUtils").addPointEBBackupUpload(b,"retroactive_backup_upload_started");return{lastRetryTs:d("WATimeUtils").millisTime(),msg:a,retriedTimes:0,traceId:b}});return T(a.map(function(a){var b=a.msg.quoteExternalId;if(b!=null)return{dbMsg:a.msg,quotedMsg:e==null?void 0:e.get(b),traceId:a.traceId};else return{dbMsg:a.msg,traceId:a.traceId}}),g,j,i).then(function(){return(h||(h=b("Promise"))).resolve()})}function e(a,e,f,g){if(!c("MAWEBSwitch").isEnabled()){d("WALogger").LOG(n());e.forEach(function(a,b){d("MAWEBUploadTrackingUtils").endSuccess(a,"upload_tracking_cancelled_eb_turned_off_upload",{string:{externalId:b,from:"uploadMessageFromUploadQueue"}})});return(h||(h=b("Promise"))).resolve()}return T(a.filter(function(a){var b=d("MAWEBUploadTrackingUtils").isUploadSupported(a);b||O("success",e,a.externalId,"upload_not_supported",{string:{msgType:a.type}});return b}).map(function(a){var b;b=((b=N(e,a.externalId))!=null?b:d("MAWTraceUtils").createTraceId()).toString();O("point",e,a.externalId,"construct_echo_start");return{dbMsg:a,traceId:b}}),void 0,f,e,g).then(function(){return(h||(h=b("Promise"))).resolve()})}var R=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:j.READONLY,media:j.READONLY,mediaBackup:j.READONLY,messages:j.READONLY,reactions:j.READONLY,threads:j.READONLY,xma:j.READONLY},"constructEchoMessage",function(a){return function(){for(var c=arguments.length,d=new Array(c),e=0;e<c;e++)d[e]=arguments[e];return b("cr:5916").constructEchoMessage.apply(b("cr:5916"),[a].concat(d))}});function S(a,b,e,f,g){b=A(a,b);c("gkx")("2251")?B(a,e):d("MAWDexieTable").dexieResolve();e=C(a,f);f=D(a,g);return d("MAWDexieTable").dexieAll([b,e,f]).then(function(a){return a.flat()})}function T(a,e,f,g,j){var n=new Map();a.forEach(function(a){var b=a.dbMsg;a=a.traceId;d("MAWEBBackendQPLUtils").addPointEBBackupUpload(a,"echo_message_upload_begin",{string:{message_type:b.type}});var f=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521475102,"868"),{bool:{eb_switch:c("MAWEBSwitch").isEnabled()},"int":{sort_order:b.sortOrderMs,timestamp:Date.now()},string:{hashed_msgid:U(b.externalId),message_id:b.externalId,message_type:b.type.toString(),org_trace_id:e==null?void 0:e.get(b.externalId),trace_id:a}});n.set(b.externalId,{constructEchoFlow:f,traceId:a})});a=M(a,f,g,j)["catch"](function(a){a="[labyrinth_web] Error while encode and upload message to backup: "+String(a);d("WALogger").ERROR(m(),a);for(var e of n.values())d("MAWEBBackendQPLUtils").endFailEBBackupUpload(e.traceId,"echo_message_upload_failure",{string:{error_message:a}}),d("MAWTraceUtils").recordFailureAndFlushForTraceId(e.traceId,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_FAILURE),[],a),e.constructEchoFlow.endFail("serialisation_failure");return(h||(h=b("Promise"))).resolve()});return a.then(function(a){a==null?void 0:a.forEach(function(a){var b;b=(b=a.echoMessage)==null?void 0:b.messageId;if(b!=null&&n.has(d("WAStanzaUtils").toStanzaId(b))){var e;b=n.get(d("WAStanzaUtils").toStanzaId(b))||{constructEchoFlow:null,traceId:null};var f=b.constructEchoFlow;b=b.traceId;e=a==null?void 0:(e=a.maybeErrorDetail)==null?void 0:e.uploadErrorType;a=a==null?void 0:(a=a.maybeErrorDetail)==null?void 0:a.errorMsg;if(e!=null)switch(e){case y.WARN:a!=null&&d("WALogger").WARN(l(),a);f==null?void 0:f.endSuccess({bool:{is_skipped:!0}});b!=null&&(d("MAWEBBackendQPLUtils").addPointEBBackupUpload(b,"echo_message_upload_invalid_request"),d("MAWTraceUtils").recordInvalidUploadRequestAndFlushTrace(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_INVALID_REQUEST),[]));break;case y.FATAL:a=(e=a)!=null?e:"[labyrinth_web] unknown error in the upload message flow";d("WALogger").ERROR(k(),a);b!=null&&(d("MAWEBBackendQPLUtils").endFailEBBackupUpload(b,"echo_message_upload_failure",{string:{error_message:a}}),d("MAWTraceUtils").recordFailureAndFlushForTraceId(b,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_FAILURE),[],a));f==null?void 0:f.endFail("serialisation_failure");break}else f==null?void 0:f.endSuccess()}});return(h||(h=b("Promise"))).resolve()})}function U(a){if(a==null)return"";var b=d("WAGlobals").getHMACKey();return d("MAWHMACKey").hmacTweetNaCl(a,b)}function f(a,b){var e=d("MAWTraceUtils").startNewTrace((i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceType").ENCRYPTED_BACKUPS_UPLOAD),d("MAWTraceUtils").CONTEXT_BACKUP_UPLOAD);d("MAWTraceUtils").recordCheckpointForTrace(e,i.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_BEGIN),[d("MAWTraceUtils").getTagForMsgType(a.type)],!1);d("MAWIndexedDb").afterTransaction({tag:"UploadMessage",value:d("MAWBridgeUpload").createBridgeUploadMessage({actionType:2,authTs:a.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:null,errorMessage:null,messageId:a.externalId,messageType:a.type,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(a),threadId:d("WAJids").threadIdForChatJid(b),traceId:e,uploadTrackingInstanceKey:null})})}g.uploadMessagesBackup=x;g.convertStringMsgIdtoMsgId=a;g.UploadErrorType=y;g.deduplicateMessageArray=P;g.uploadUniqueMessage=Q;g.uploadMessageFromUploadQueue=e;g.getMessagesBackupForUpload=S;g.sendDeleteEchoMessage=f}),98);
__d("MAWReStoreDb",["MAWIndexedDb","MAWReStoreDbSetup","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){if(c("gkx")("3577"))return d("MAWReStoreDbSetup").getDB();h==null&&(d("MAWIndexedDb").willSetupDB()?h=d("MAWIndexedDb").getDB().then(function(){return d("MAWReStoreDbSetup").getDB()}):h=d("MAWReStoreDbSetup").getDB());return h}g.getDB=a}),98);
__d("MAWReStoreTiming",["FBLogger","MAWErrorObject","MAWIndexedDb","MAWLLAMigrationUtils","MAWQplProxy","MAWReStoreDb","MAWRestoreDbState","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";var h=["MWPTransactor"];function i(a){a=d("MAWLLAMigrationUtils").getTransactorQPLParam(a);a=a.length===2?a:[null,void 0];var b=a[0];a=a[1];return b!=null?d("MAWQplProxy").startQplUserFlow(b,a,void 0,d("MAWLLAMigrationUtils").QPL_TRANSACTION_TIMEOUT_MS):null}var j=c("FBLogger")("messenger_web_devx");function k(a){if(a)return j.catching(a);else return j}function l(a,c){return b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var b=(yield d("MAWReStoreDb").getDB()),e=i(a),f;try{e==null?void 0:e.addPoint("transactor_execution_start");for(var g=arguments.length,j=new Array(g),l=0;l<g;l++)j[l]=arguments[l];f=(yield c.apply(void 0,[b].concat(j)));e==null?void 0:e.addPoint("transactor_execution_end");e==null?void 0:e.endSuccess()}catch(b){var m;e==null?void 0:e.endFail("transaction_fail");var n=d("MAWErrorObject").getErrorObject(b);throw k(n).mustfixThrow("[%s] Error performing %s transaction",h.join("|"),(m=a)!=null?m:"")}return f})}function a(a,b,e,f){return function(){for(var g=arguments.length,h=new Array(g),i=0;i<g;i++)h[i]=arguments[i];return!c("qex")._("1016")?d("MAWIndexedDb").makeMsgrTransactor(e,a,f).apply(void 0,h):d("MAWRestoreDbState").isUsingShim().then(function(c){return c?l(a,b).apply(void 0,h):d("MAWIndexedDb").makeMsgrTransactor(e,a,f).apply(void 0,h)})}}g.makeShimTransactor=a}),98);
__d("MAWHandlePendingStanzasInRestoreV2",["I64","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDexieTable","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWIndexedDb","MAWReStoreTiming","MAWTransactionMode","MAWUploadMessagesBackup","MAWWriteRevokeMessageTxns","Promise","ReQL","WAJids","WALogger","cr:553","cr:7702","cr:8066","nullthrows","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanza type "," is not supported"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid is null for pendingStanza"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanzaTs is null for pendingStanza"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Could not find thread for chatId "," for pendingStanza"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Delete For Me pending stanza does not need to be applied."]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread is null"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanza type "," is not supported"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Pending Stanza not found in the cache. This shouldn't happen."]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);v=function(){return a};return a}var w=(a=(e=(a=b("cr:553"))==null?void 0:a.structuredClone)!=null?e:(f=b("cr:7702"))==null?void 0:f.structuredClone)!=null?a:(e=b("cr:8066"))==null?void 0:e.structuredClone;f=function(a,c,d){a=a.restoredMsgsData;if(a){var e=a.newlyAddedMsgs;e=e.concat(a.existingMsgs);return x(e,c,d)}return(i||(i=b("Promise"))).resolve()};var x=function(a,e,f){f==null?void 0:f.addPoint("apply_pending_stanza_start");var g=0,h=0,j=0,k=0,l=new Map();return F().then(function(a){a==null?void 0:a.map(function(a){var b=a.pendingContent.content.externalId;if(b==null){d("WALogger").WARN(v());return}l.set(a.externalIdWithType,a)}),k=l.size}).then(function(){var b=new Set();return B(a).then(function(f){return d("MAWDexieTable").dexieAll(a.map(function(a){var c=a.externalId;if(e)if(d("MAWEncryptedBackupCacheManager").peekPendingStanzaCache(c)){var i=d("MAWEncryptedBackupCacheManager").getPendingStanzaCacheValue(c);if(i==null){d("WALogger").ERROR(u());return}return A(i,a,f,e).then(function(a){a!=null&&b.add(i);d("MAWEncryptedBackupCacheManager").removePendingStanzaCacheValue(c);l["delete"](i.externalIdWithType);a=i.pendingContent.type;a===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED&&g++;h++})}else l.clear();else{var k=c+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,m=l.get(k);if(m!=null)return A(m,a,f,e).then(function(a){a!=null&&(b.add(m),g++,j++),l["delete"](m.externalIdWithType)})}})).then(function(){if(!e){var a=y(l);g+=a[1];h+=a[0]+a[1];c("promiseDone")(z(Array.from(b)))}})})}).then(function(a){f==null?void 0:f.addPoint("apply_pending_stanza_end",{"int":{initialRestorePendingStanzaCount:j,pendingStanzasToBeUploadedCount:k,pointRestorePendingStanzaCount:h,revokedCount:g}});return(i||(i=b("Promise"))).resolve()})},y=function(a){var b=0,c=0;a.forEach(function(a){var e=a.pendingContent.type;e===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?c++:e===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME&&b++;E(a)});a.clear();return[b,c]},z=d("MAWIndexedDb").makeMsgrTransactor({pendingStanzas:d("MAWTransactionMode").READWRITE},"deletePendingStanzasFromIndexedDB",function(a){return function(b){return d("MAWDbPendingStanzaTxns").deletePendingStanzas(a,b)}}),A=function(a,e,f,g){var h=a.pendingContent.type;if(h===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)return D(a,e,f,g).then(function(a){if(a!=null){var b=d("MAWEBUploadTrackingUtils").genInstanceKeyOnly();d("MAWEBUploadTrackingUtils").startUploadTracking(a.externalId,a.type,"pendingstanza",b);c("promiseDone")(d("MAWUploadMessagesBackup").uploadUniqueMessage([a],void 0,!1,void 0,new Map([[a.externalId,b]])))}});else if(h===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)return C(a);else{d("WALogger").WARN(t(),h);return(i||(i=b("Promise"))).resolve()}},B=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY},"getThreadsForMessages",function(a){return function(b){var c=[];b.forEach(function(a){c.push(a.threadJid)});return a.threads.where("jid").anyOf(c).toArray().then(function(a){var b=new Map();a.forEach(function(a){if(a==null){d("WALogger").WARN(s());return d("MAWDexieTable").dexieResolve()}b.set(a.jid,a)});return b})}}),C=d("MAWIndexedDb").makeMsgrTransactor({pendingStanzas:d("MAWTransactionMode").READWRITE},"deleteForMeMsg",function(a){return function(b){d("WALogger").LOG(r());return d("MAWDexieTable").dexieAll([a.pendingStanzas["delete"](b.rowId)]).then(function(){return d("MAWDexieTable").dexieResolve(b)})}}),D=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY,deletedMessages:d("MAWTransactionMode").READWRITE,ftsPurgeBacklog:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,pendingStanzas:d("MAWTransactionMode").READWRITE,reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE,xma:d("MAWTransactionMode").READONLY},"revokeMessage",function(a){return function(b,c,e,f){e=e.get(c.threadJid);if(e==null){d("WALogger").ERROR(q(),c.threadJid);return d("MAWDexieTable").dexieResolve()}var g=b.pendingContent.content.externalId;if(g==null){d("WALogger").ERROR(p());return d("MAWDexieTable").dexieResolve()}var h=b.pendingContent.content.revokedExternalId;if(h==null){d("WALogger").ERROR(o());return d("MAWDexieTable").dexieResolve()}var i=b.pendingContent.content.ts;if(i==null){d("WALogger").ERROR(n());return d("MAWDexieTable").dexieResolve()}return d("MAWWriteRevokeMessageTxns").revokeUnstoredMsg(a,c,e,g,h,c.serverTs,c.ts,f).then(function(c){a.pendingStanzas["delete"](b.rowId);return d("MAWDexieTable").dexieResolve(c)})}});function E(a){var b=a.pendingContent.content.threadJid;if(b==null){d("WALogger").WARN(m());return}var e=d("WAJids").threadIdForChatJid(b),f=a.pendingContent.type;if(f===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED){var g=a.pendingContent.content.revokedExternalId;if(g==null){d("WALogger").WARN(l());return}g=g}else if(f===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME){var h=a.pendingContent.content.externalId;if(h==null){d("WALogger").WARN(k());return}g=h}else{d("WALogger").WARN(j(),f);return}d("MAWEncryptedBackupCacheManager").addPendingStanzaToPendingStanzaCache(g,a);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(g,e,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,b)}var F=d("MAWReStoreTiming").makeShimTransactor("getAllPendingStanzas",function(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.e2ee_pendingStanzas).map(function(a){a=c("nullthrows")(w)(a);return babelHelpers["extends"]({},a,{rowId:(h||(h=d("I64"))).to_float(a.rowId)})}))},{pendingStanzas:d("MAWTransactionMode").READONLY},function(a){return function(){return d("MAWDbPendingStanzaTxns").getAllPendingStanzas(a)}});g.applyPendingStanzas=f;g.issuePointQueryForPendingStanza=E}),98);
__d("MAWWriteMsgTxns",["I64","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBridgeTypesCreators","MAWBuildIncomingMsgs","MAWCalculateBumpTimestampMs","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEBUploadMessageUtils","MAWEphemeralMsgTxns","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWLocalizationUtils","MAWMessageHasUniqueExternalIdValidator","MAWMsgType","MAWThreadEvent","MAWThreadSnippetBuildTxns","MAWThreadSnippetUtils","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","WAJids","WALogger","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""]);j=function(){return a};return a}function k(a,b,e,f){var g=e.ts;g=[d("WATimeUtils").castUnixTimeToMillisTime(g),e.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN];var h=g[0],i=g[1];return d("MAWGetOrCreateThreadTxns").getExistingThread(a,b.jid).then(function(b){if(b==null)throw c("err")("at this point there's always a thread - checking for updates");var g=d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid),j=d("MAWDbMsgTxns").getThreadNewestMessageBySortOrderOrCache(a,b,"defer_to_qe");return d("MAWDexieTable").dexieAll([g,j]).then(function(c){var g,j,k=c[0];c=c[1];var l=c==null?1:d("MAWDbMsg").getInChatMsgIdFromMsgId(c.msgId)+1;g=d("WATimeUtils").castToMillisTime((g=c==null?void 0:c.sortOrderMs)!=null?g:0);var m=h>g&&!i?h:g;g=(g=d("MAWTimeUtils").ensureValidMillisTime(b.lastReadMsgTs))!=null?g:0;j=d("WATimeUtils").castToMillisTime((j=c==null?void 0:c.sortOrderMs)!=null?j:0);g=g<j;var n=e.author===d("WAJids").AUTHOR_ME||e.type===d("MAWMsgType").MSG_TYPE.ADMIN&&d("MAWLocalizationUtils").isParticipantChangeAdminMsg(e.msgContent.adminType)&&!g,o=babelHelpers["extends"]({},e,{msgId:d("MAWDbMsg").craftMsgIdV2(b.chatId,l,e)}),p=d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(e);g=p>((j=b.snippetMsgTs)!=null?j:0);var q=!d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(o)&&g;l=d("MAWDbMsgTxns").calculateOldestAndNewestMsg(k,c,o,f);var r=l.newestMsg,s=l.oldestMsg;j=q?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,o):d("MAWDexieTable").dexieResolve(null);return j.then(function(a){return{isOldestMsgUpdated:k!=null&&s!==k.msgId,msgId:o.msgId,prevOldestMsg:k,updatedSnippet:a,updatedThread:babelHelpers["extends"]({},b,{lastReadMsg:n?o.msgId:b.lastReadMsg,lastReadMsgTs:n?m:b.lastReadMsgTs,newestMsg:r,newestMsgTs:m,oldestMsg:s,snippetMsg:q?o.msgId:b.snippetMsg,snippetMsgTs:q?d("WATimeUtils").castToMillisTime(p):b.snippetMsgTs,threadOrder:d("MAWDbThread").craftThreadOrder(m,b.jid)})}})})})}function l(a,b,c,e,f,g,h,i){e===void 0&&(e={});e=e;var l=e.isFirstMsg,m=l===void 0?!1:l;l=e.isOutgoing;var n=l===void 0?!1:l,o=e.openMessageOtid,p=e.openMessageParticipantCount,q=e.optimisticMsg,r=e.participantCount,s=e.quotedReplyAttachmentMeta;l=e.skipLocalThreadBump;var t=l===void 0?!1:l;l=e.sortOrderMs;return k(a,c,b,l).then(function(c){var e=c.isOldestMsgUpdated,k=c.msgId,l=c.prevOldestMsg,u=c.updatedSnippet,v=c.updatedThread,w=babelHelpers["extends"]({},b,{msgId:k,sortOrderMs:d("MAWEBUploadMessageUtils").echoOverrideMessageSortOrder(b)});if(h!=null&&h){d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource([w.externalId],"MAWWriteMsgTxns::writeMsg isPointRestoreForEB");return a.messages.add(w).then(function(a){return babelHelpers["extends"]({},w,{rowId:a})})}d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource([w.externalId],"MAWWriteMsgTxns::writeMsg");return d("MAWDexieTable").dexieAll([a.messages.add(w).then(function(a){return babelHelpers["extends"]({},w,{rowId:a})}),a.threads.put(v),d("MAWFTSTxns").maybePutMessageToBacklog(a,w.externalId)]).then(function(a){var b=a[0];a[1];n&&d("WALogger").LOG(j(),b.sortOrderMs);d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:b,hasMoreAfter:g,hasMoreBefore:f,isFirstMsg:m,isOldestMsgUpdated:e,msgsLeftToRestoreForEB:i,openMessageOtid:o,openMessageParticipantCount:p,optimisticMsg:q,participantCount:r,prevOldestMsg:(l==null?void 0:l.msgId)==null?void 0:l.msgId,quotedReplyAttachmentMeta:s,skipLocalThreadBump:t,snippet:u,updatedThread:v});return b})})}function m(a,b,e){return d("MAWGetOrCreateThreadTxns").getExistingThread(a,e.jid).then(function(e){if(e==null)throw c("err")("at this point there's always a thread - checking for updates");return d("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(a,e).then(function(c){var f=babelHelpers["extends"]({},b,{msgId:d("MAWDbMsg").craftUnrenderedMsgId(e.chatId,c)});return d("MAWDexieTable").dexieAll([a.unrenderedMessages.add(f),a.threads.put(e)]).then(function(a){var b=a[0];a[1];return babelHelpers["extends"]({},f,{rowId:b})})})})}function a(a,b,c){return d("MAWDexieTable").dexieAll([n(a,b,c),d("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(a,[[b.externalId,c.jid]]).then(function(a){return{editMsgHistories:a,originalEditMsgHistory:a.find(function(a){return a.editExternalId===b.externalId})}})]).then(function(a){var b=a[0];a=a[1];var c=a.editMsgHistories;a=a.originalEditMsgHistory;return babelHelpers["extends"]({},b,{editMsgHistories:c,existingEditMsgHistory:(b=a)!=null?b:null})})}function n(a,b,c){c=[b.externalId,c.jid,b.author];var e=c[0],f=c[1];c=c[2];return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,e,c,f),d("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(a,e,c,f),d("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(a,f).then(function(a){return d("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(b.ts,a)})]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3];a=a[4];return{existingMsg:(b=b)!=null?b:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:e,pendingDeleteForMeStanza:(b=d)!=null?b:null,pendingRevokedStanza:(a=c)!=null?a:null}})}function b(a,b,c){return d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,b.externalId,b.author,c.jid).then(function(e){if(e!=null)return o(a,b,c,e);e=b.author;d("WALogger").DEV(i(),b.type,e,c.jid);var f=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{threadJid:c.jid}));c.folder===d("MAWFolderTypes").FOLDER_ID.OTHER&&(f.altIndex=f.altIndex===d("MAWDbMsg").FUTUREPROOF_ALT_INDEX?d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:d("MAWDbMsg").SPAM_ALT_INDEX);return d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,f,c.jid).then(function(b){b!=null&&(f=babelHelpers["extends"]({},f,{quote:b==null?void 0:b.quote,quoteExternalId:b==null?void 0:b.quoteExternalId}));return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c.jid,f),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,f),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,f)]).then(function(b){var e=b[0],g=b[1],i=b[2];b=f.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&f.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&f.author!==d("WAJids").AUTHOR_ME;return l(a,f,c,{quotedReplyAttachmentMeta:g,skipLocalThreadBump:b}).then(function(b){f.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&f.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&f.author!==d("WAJids").AUTHOR_ME&&d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b).then(function(a){var b=a.snippetParams,e=a.snippetSenderContactId;a=a.snippetType;var g=f.externalId!==void 0?(h||(h=d("I64"))).of_string_opt(f.externalId):void 0;g=d("MAWCalculateBumpTimestampMs").calculateBumpTimestampMs(d("WATimeUtils").castUnixTimeToMillisTime(f.ts),g);d("MAWIndexedDb").afterTransaction({tag:"ThreadBumpedV2",value:d("MAWBridgeTypesCreators").createBridgeBumpedThreadV2({bumpTimestampMs:g,description:"writeNewIncomingMsg-"+f.type,isMessageAuthorMe:!1,snippetParams:b,snippetSenderContactId:e,snippetType:a,threadJid:c.jid})})});return d("MAWDexieTable").dexieAll([d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,f),d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,b)]).then(function(a){a=a[1];e!=null&&e.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,void 0,i)})});return a||b})})})})})}function e(a,b,c,e,f){var g=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{msgId:c.msgId,rowId:c.rowId,serverTs:c.serverTs,sortOrderMs:c.sortOrderMs,threadJid:e.jid,ts:c.ts}));return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,e.jid,g),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,g),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,g),d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,g,e.jid),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e)]).then(function(h){var i=h[0],j=h[1],k=h[2],l=h[3],m=h[4];g=babelHelpers["extends"]({},g,{quote:l==null?void 0:l.quote,quoteExternalId:l==null?void 0:l.quoteExternalId});return((h=c.editCount)!=null?h:0)>0&&f!=null&&b.type===d("MAWMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(a,f,b).then(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:[babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(a.editMsgHistoryId),originalMsgId:c.msgId})]});return c}):a.messages.put(g).then(function(){return d("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(a,g)}).then(function(b){if(b){g.altIndex=d("MAWDbMsg").craftToBeReadAltIndex(e.chatId);return a.messages.put(g)}}).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(g,void 0,k)});d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(g,void 0,j)});d("MAWIndexedDb").afterTransactionThreadEvent({chatJid:e.jid,msgId:g.msgId},d("MAWThreadEvent").PLACEHOLDER_CONVERT_SUBSCRIPTION);i!=null&&i.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,void 0,k)})});if(g.msgId===m){var b=g;b.rowId;b=babelHelpers.objectWithoutPropertiesLoose(b,["rowId"]);return d("MAWDexieTable").dexieAll([d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,g),d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,b)]).then(function(a){a=a[0];var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:e.jid})});return g})}return g})})}function f(a,b,c,e){var f=d("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(b,c);return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:f.author,chatJid:f.threadJid,externalId:f.externalId}]),m(a,f,c),a.pendingStanzas["delete"](e.rowId),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(a){a[0];a=a[1];d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(f.messageDeleteForMeTs);return babelHelpers["extends"]({},f,{msgId:a.msgId,rowId:a.rowId})})}function o(a,b,e,f){var g=d("MAWDbPendingStanzaTxns").getRevokedContent(f);if(g==null)throw c("err")("missing revoked content");b=d("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(b,e,g);return d("MAWDexieTable").dexieAll([l(a,b,e),a.pendingStanzas["delete"](f.rowId)]).then(function(b){var c=b[0];return d("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(a,c,e).then(function(){return c})})}g.writeMsg=l;g.writeUnrenderedMsg=m;g.prepareTextMsgWriteData=a;g.prepareMsgWriteData=n;g.writeNewIncomingMsg=b;g.writeCiphertextUpdate=e;g.handleDeleteForMeMessage=f;g.handleOutOfOrderRevokedMessage=o}),98);
__d("MAWBridgeXMA",["MAWBridgeUIEventDataValidation","MAWDbMedia","WALogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWBridge - createBridgeXMA received unexpected media type - ",""]);h=function(){return a};return a}function i(a){if(a==null)return void 0;switch(a){case"Image":case"Sticker":return"image/png";case"Gif":return"image/gif";case"Video":return"video/mp4";case"Ptt":return"audio/wav"}}function a(a,b,e){var f=b.contentRef,g=b.ctas,j=b.defaultCTA,k=b.defaultPreviewMediaId,l=b.faviconMediaId,m=b.headerMediaId,n=b.headerTitle,o=b.maxSubtitleNumOfLines,p=b.maxTitleNumOfLines,q=b.msgId,r=b.offlineAttachmentId,s=b.overlayIconGlyph,t=b.overlayTitle,u=b.subtitleText,v=b.targetId,w=b.targetType,x=b.targetUsername,y=b.threadJid,z=b.titleText,A=b.xmaId;b=b.xmaLayoutType;a!=null&&a.mediaType!==d("MAWDbMedia").IMAGE&&d("WALogger").WARN(h(),a.mediaType);v!=null&&d("MAWBridgeUIEventDataValidation").stringToI64Opt(v);return{contentRef:f,ctas:g,defaultCTA:j,defaultPreviewMediaId:k,duration:null,faviconMediaId:l,filesize:a==null?void 0:a.size,hasMedia:c("gkx")("821")?e:void 0,headerMediaId:m,headerTitle:n,maxSubtitleNumOfLines:o,maxTitleNumOfLines:p,mediaType:a==null?void 0:a.mediaType,msgId:q,offlineAttachmentId:r,overlayIconGlyph:s,overlayTitle:t,playableUrlMimeType:i(a==null?void 0:a.mediaType),previewHeight:a==null?void 0:(f=a.validatedImageInfo)==null?void 0:f.jpegThumbnailHeight,previewHeightLarge:a==null?void 0:(g=a.validatedImageInfo)==null?void 0:g.height,previewUrlMimeType:i(a==null?void 0:a.mediaType),previewWidth:a==null?void 0:(j=a.validatedImageInfo)==null?void 0:j.jpegThumbnailWidth,previewWidthLarge:a==null?void 0:(k=a.validatedImageInfo)==null?void 0:k.width,subtitleText:u,targetId:v,targetType:w,targetUsername:x,threadJid:y,titleText:z,ts:a==null?void 0:a.ts,xmaId:A,xmaLayoutType:b}}function b(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}function e(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}g.createBridgeXMA=a;g.createBridgeXMAShareExpired=b;g.createBridgeXMAShareTombstoned=e}),98);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWThreadSnippetForTextMsg","MAWUnsafeCoerce","WAGlobals","WAJids","WAMsgMap","WAMsgType","err"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){var f=[];for(var g=0;g<a.length;g++){var h=a[g],i=d("MAWJidUtils").maybeToProtocolMsgId(h.author,h.threadJid,h.originalMsgExternalId);if(i!=null){i=(i=e.get(i))==null?void 0:i.msgId;i!=null?f.push(babelHelpers["extends"]({},h,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(b[g]),originalMsgId:i})):c("FBLogger")("messenger_web_devx").warn("[edit messagehistory] Failed to get the original msgId for a msg that has been edited.")}}d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:f})}function a(a,b){var c=new Set(),e=[];b.forEach(function(a){var b=a.chatJid;a=a.msg;c.add(b);e.push(a.originalMsgExternalId)});return d("MAWDexieTable").dexieAll([a.messages.where("externalId").anyOf(e).toArray(),a.messages.where("quoteExternalId").anyOf(e).toArray(),a.editMsgHistory.where("originalMsgExternalId").anyOf(e).toArray(),a.threads.where("jid").anyOf(Array.from(c)).toArray()]).then(function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return{editMsgHistory:d,originalMsgs:b,quoteMessages:c,threads:a}})}function i(a,b,e){var f=new Map();b.values().forEach(function(a){var b;b=(b=a.threadJid)!=null?b:d("WAJids").unsafeCoerceToChatJid("");if(f.has(b)){var c;(c=f.get(b))==null?void 0:c.push(a)}else f.set(b,[a])});b=e.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageId(a,b,"defer_to_qe").then(function(a){return{editedMsgsInThread:f.get(b.jid),newestMsgId:a,thread:b}})});return d("MAWDexieTable").dexieAll(b).then(function(a){a.forEach(function(a){var b=a.editedMsgsInThread,e=a.newestMsgId;a=a.thread;if(a==null||b==null)return;b=b.filter(function(a){return a.msgId===e})[0];if(b!=null){var f=b.author;if(f==="@system")throw c("err")("[edit message] author should not be @system.");f=d("WAJids").userIdFromJid(f==="@me"?d("WAGlobals").getMyUserJid():f);b=c("MAWThreadSnippetForTextMsg")(b,f,d("WAJids").interpretAsGroupJid(a.jid)!=null);var g=b.snippetParams;b=b.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:g,snippetSenderContactId:f,snippetType:b,threadJid:a.jid})})}})})}function b(a,b,e){var f=e.editMsgHistory,g=e.originalMsgs,j=e.quoteMessages,l=e.threads,m=g.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());e=f.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());g=k(b,{messageHistoriesToEdit:e,messagesToEdit:m});var n=g[0],o=g[1],p=g[2];return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,n,!1).then(function(b){h(n,b,m);var e=new(d("WAMsgMap").MsgMap)();o.entries().forEach(function(a){var b=a[0];a=a[1];var f=m.get(b);if(f==null){c("FBLogger")("messenger_web_devx").warn("Cannot find the original msg for the edit action.");return}if(f.type!==d("WAMsgType").MSG_TYPE.TEXT&&f.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",f.type);f=babelHelpers["extends"]({},f,{editCount:((f=f.editCount)!=null?f:0)+((f=p.get(b))!=null?f:0),msgContent:a.editMsgContent,type:d("WAMsgType").MSG_TYPE.TEXT});e.set(b,f)});return i(a,e,l).then(function(){var b=j.map(function(a){var b=a.quote,f=a.quoteExternalId,g=a.threadJid;if(b==null){c("FBLogger")("messenger_web_devx").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",a.externalId);return}g=d("MAWJidUtils").maybeToProtocolMsgId(b.content.author,g,f);if(g==null)return;f=e.get(g);if(f==null)return;return babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},f.msgContent)})})})}).filter(Boolean);return a.messages.bulkPut(e.values().concat(b)).then(function(){e.values().forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})})}).then(function(){b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})})})}function j(a,b){var e;switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=a.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:(e=a.originalMsgExternalId)!=null?e:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};case d("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:{content:""},originalMsgExternalId:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};default:a.type;throw c("err")("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function k(a,b){var e=b.messageHistoriesToEdit,f=b.messagesToEdit,g=[],h=new(d("WAMsgMap").MsgMap)(),i=new(d("WAMsgMap").MsgMap)();a.forEach(function(a){var b=a.chatJid;a=a.msg;var k=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.originalMsgExternalId);if(k==null)throw c("err")("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.originalMsgExternalId);var l=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.externalId);if(l==null)throw c("err")("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.externalId);if(e.get(l)==null){g.push(j(a,b));l=(l=i.get(k))!=null?l:0;var m=f.get(k);i.set(k,l+1);if(e.get(k)==null&&l===0&&m!=null){if(m.type!==d("WAMsgType").MSG_TYPE.TEXT&&m.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",m.type);g.push(j(m,b))}}l=h.get(k);m=l==null?void 0:l.serverTs;b=a==null?void 0:a.serverTs;(m==null||b==null||m<b)&&h.set(k,a)});return[g,h,i]}g.prepareDataForMessageEdit=a;g.bulkEditMsgs=b;g.getMessageHistory=j}),98);
__d("MAWDbReaction",["MAWAckLevel","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a.reactToAuthor!=="@me"||a.reaction==null)return null;var b=a.author==="@me"||a.author==="@system"?null:a.author;return b==null?null:babelHelpers["extends"]({},a,{author:b,reaction:a.reaction,reactToAuthor:a.reactToAuthor})}function b(a,b,c){var e=d("WAGlobals").getMyUserJid();return a.find(function(a){return a.threadJid===b&&d("WAJids").authorToUserId(a.author,e)===d("WAJids").authorToUserId(c,e)})}function c(a){return a}function e(a,b,c,e,f,g,h,i,j,k,l,m,n){m===void 0&&(m=d("MAWAckLevel").ACK.clock);m={ack:m,author:k,externalId:b,groupingKey:g,reaction:f,reactionId:c,reactToAuthor:h,reactToExternalId:e,reactToMsgId:i,senderTimestampMs:n,threadJid:a,ts:j};return l!=null?babelHelpers["extends"]({},m,{rowId:l}):m}g.castToIncomingDbReaction=a;g.findMatchingReaction=b;g.reactionIdToMsgId=c;g.formatReactionForDb=e}),98);
__d("MAWDbReactionUtils",["MAWBridgeTypesCreators","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,c=a.reaction,e=a.reactToMsgId,f=a.threadJid;a=a.ts;if(e==null)return;d("MAWIndexedDb").afterTransaction(c==null?{tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:f,reactToMsgId:e})}:{tag:"UpsertReaction",value:d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:f,reaction:c||"",reactToMsgId:e,ts:a})})}g.dispatchReaction=a}),98);
__d("WAArrayGroupBy",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=new Map();for(var d=0;d<a.length;d++){var e=b(a[d]),f=c.get(e);f==null?c.set(e,[a[d]]):f.push(a[d])}return Array.from(c.entries())}f.groupBy=a}),66);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["MAWBridgeBuildThreadSnippet","MAWBridgeTypesCreators","MAWBridgeUIEventDataValidation","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","MAWTransactor","Promise","WAArrayGroupBy","WAJids","WAMsgMap","asyncToGeneratorRuntime","cr:3061","err","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return a.reduce(function(a,b){var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.reactToExternalId);if(c==null)return a;a.set(c,d("MAWDbReactionsTxns").coerceToReaction(b));return a},new(d("WAMsgMap").MsgMap)()).values()}function a(a,e,f){if(e.length===0)return d("MAWDexieTable").dexieResolve();e=i(e);var g=e.map(function(a){var b=f.get(a.threadJid);if(b==null)throw c("err")("Should not have got here - expect thread to exist for flow");c("qex")._("1215")!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a});e=d("WAArrayGroupBy").groupBy(g,function(a){a=a.threadJid;return a});e=e.map(function(b){var c=b[0];b=b[1];c=f.get(c);if(c==null||b.length===0)return null;var e=null;for(var g=b.length-1;g>=0;g--){e=d("MAWDbReaction").castToIncomingDbReaction(b[g]);if(e!=null)break}g=b.filter(function(a){return a.reaction==null});b=d("WAJids").interpretAsGroupJid(c.jid)!=null;return d("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(a,c,{newestReaction:e,reactionsToClear:g},b)}).filter(Boolean);return d("MAWDexieTable").dexieAll(e).then(function(e){return d("MAWDexieTable").dexieAll([a.threads.bulkPut(e.map(function(a){a=a.thread;return a})),a.reactions.bulkPut(g)]).then(function(){if(c("qex")._("1215")===!0&&b("cr:3061")!=null)return d("MAWTransactor").runInLSDB(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield (h||(h=b("Promise"))).all(e.map(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){var e=c.newestReaction;c=c.thread;var f=(yield b("cr:3061").getOrCreateOptimisticThreadKey(a,c.jid));f=(yield a.threads.get(f));if(f!=null&&e!=null&&c.snippetMsg!=null&&e.author!=null){var g=d("WAJids").interpretAsGroupJid(c.jid)!=null;e=d("MAWThreadSnippetBuildTxns").getReactionSnippetParams(e.author,e.reaction,g);g=e.snippetParams;var h=e.snippetSenderContactId;e=e.snippetType;g=d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:g,snippetSenderContactId:h,snippetType:e,threadJid:c.jid});h=(yield d("MAWBridgeBuildThreadSnippet").buildBridgeThreadSnippet(g,f.snippet));yield a.threads.put(babelHelpers["extends"]({},f,{snippet:h,snippetSenderContactId:g.snippetSenderContactId!=null?d("MAWBridgeUIEventDataValidation").stringToI64Opt(g.snippetSenderContactId):void 0}))}});return function(a){return c.apply(this,arguments)}}()))});return function(b){return a.apply(this,arguments)}}())}).then(function(){})})}g.bulkPutReactionsWithThreadUpdates=a}),98);
__d("MAWBulkWriteReactionsTxns",["LSMEBTaskCreationSource","MAWAuthor","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWEncryptedBackupCacheManager","MAWIndexedDb","WAArrayGroupBy","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=[];b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;a=a.reactToExternalId;e.push(b);f.push(a)});return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.messages.where("externalId").anyOf(f).toArray(),a.reactions.where("reactToExternalId").anyOf(f).toArray()]).then(function(e){var f=e[0],g=e[1];e=e[2];var h=new Map(f.map(function(a){return[a.jid,a]})),i=new Map(d("WAArrayGroupBy").groupBy(g,function(a){return a.externalId})),j=new Map(d("WAArrayGroupBy").groupBy(e,function(a){return a.reactToExternalId})),k=[];g=f.map(function(b){return d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,b).then(function(a){return[b.jid,a]})});return d("MAWDexieTable").dexieAll(g).then(function(a){var e=new Map(a);b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;var f=a.author,g=a.externalId,l=a.groupingKey,m=a.reaction,n=a.reactToAuthor,o=a.reactToExternalId,p=a.senderTimestampMs,q=a.ts,r=h.get(b);if(r==null)return"missing_thread";b=e.get(r.jid);if(b==null)throw c("err")("nextInChatReactionId should not be null");e.set(r.jid,b+1);var s=j.get(a.reactToExternalId)||[];s=d("MAWDbReaction").findMatchingReaction(s,r.jid,f);var t=d("MAWAuthor").getAuthorUserJid(n),u=i.get(a.reactToExternalId);if(u==null&&!d("MAWEncryptedBackupCacheManager").peekRestoreCache(a.reactToExternalId)){var v=d("WAJids").threadIdForChatJid(r.jid);d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(r.jid,a.reactToExternalId);d("MAWIndexedDb").afterTransaction({tag:"IssuePointQuery",value:{jid:r.jid,messageId:a.reactToExternalId,startSortKey:void 0,taskSource:c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT,threadId:v}})}a=u==null?void 0:u.find(function(a){return a.threadJid===r.jid&&t===d("MAWAuthor").getAuthorUserJid(a.author)});u=d("MAWDbReaction").formatReactionForDb(r.jid,g,d("MAWDbMsg").craftReactionId(r.chatId,b),o,m,l,n,a==null?void 0:a.msgId,q,(v=f)!=null?v:d("WAJids").AUTHOR_ME,s==null?void 0:s.rowId,void 0,p);k.push(u)});return{chatJidToDbThread:h,unstoredDbReactionsForInsertion:k}})})}function b(a,b){var c=b.chatJidToDbThread;b=b.unstoredDbReactionsForInsertion;return d("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(a,b,c)}g.prepareReactionsData=a;g.bulkWriteReactions=b}),98);
__d("MAWHIMLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["HandleIncomingMessage"]);g["default"]=a}),98);
__d("MAWDbRavenActionTxns",["MAWBridgeTypesCreators","MAWDbMsg","MAWIndexedDb","MAWMsg","MAWRavenUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){return a.messages.where("externalId").equals(b.ravenActionToMsgExternalId).filter(function(a){return a.threadJid===e.jid}).first().then(function(f){var g=f==null?void 0:f.msgId;if(g==null)throw c("err")("Cannot Write Raven Action without ID of Raven Message");return h(a,f).then(function(c){var d=babelHelpers["extends"]({msgId:g,threadJid:e.jid},b);return a.unrenderedMessages.add(d).then(function(a){return babelHelpers["extends"]({rowId:a},d)})}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"RavenActionUpdate",value:d("MAWBridgeTypesCreators").createBridgeRavenAction(a)});return})})}function h(a,b){if((b==null?void 0:b.type)!=="Raven")throw c("err")("Cannot Modify Message because Message is not Raven Message");var e=[d("MAWMsg").MAWRavenMsgEphemeralMediaState.cast(Number(b.ravenEphemeralMediaState)),d("MAWMsg").MAWRavenMsgEphemeralType.cast(Number(b.ravenEphemeralType))],f=e[0];e=e[1];if(f==null||e==null)throw c("err")("ravenEphemeralMediaStateEnum or ravenEphemeralTypeEnum is null");f=d("MAWRavenUtils").getNextRavenMessageEphemeralState(f,e);return a.messages.put(babelHelpers["extends"]({},b,{ravenEphemeralMediaState:f}))}function b(a,b,c){c=d("MAWDbMsg").isRavenActionMsgType(c)&&(b==null?void 0:b.externalId)!=null?[b.externalId]:[];return a.messages.where("externalId").anyOf(c).filter(function(a){return a.author===(b==null?void 0:b.author)&&a.threadJid===(b==null?void 0:b.chat)}).first()}g.writeRavenActionMsg=a;g.modifyRavenMsgWithActionMsg=h;g.maybeGetRavenMsgQueryByProtocolMsgId=b}),98);
__d("MAWEphemeralUtils",["MAWLocalizationType","WAArmadilloApplication.pb","WAGlobals","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";var h=60,i=60*h,j=24*i;function a(a,b,c,e){var f=[],g=b===j,k=a===d("WAGlobals").getMyUserJid();if(e)e=d("MAWLocalizationType").LOCALIZATION_TYPE.EPHEMERAL_SETTINGS_AUTO_RESET;else if(!k||a==null)b===0?e=d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_OFF:b<h?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_SECONDS,f.push(b.toString())):b<i?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_MINUTES,f.push((b/h).toString())):b<j||g?(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_HOURS,f.push((b/i).toString())):(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_EPHEMERAL_SETTING_CHANGE_DAYS,f.push((b/j).toString()));else{a=d("WAJids").extractUserId(a).toString();b===0?k?e=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_OFF:(e=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF,f.push(a)):b<h?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_SECONDS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS,f.push(a)),f.push(b.toString())):b<i?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES,f.push(a)),f.push((b/h).toString())):b<j||g?(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_HOURS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS,f.push(a)),f.push((b/i).toString())):(k?e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_DAYS:(e=c?d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS,f.push(a)),f.push((b/j).toString()))}return{ephemeralSettingChangeContent:f,ephemeralSettingChangeType:e}}function b(a,b,e){var f,g=[];b=d("WAJids").extractUserId(b).toString();switch(a){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e?f=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT:(f=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT,g.push(b));break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e?f=d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_RECORD_SCREEN:(f=d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN,g.push(b));break;default:throw c("err")("Received unexpected screenshot action type")}return{ephemeralScreenshotActionContent:g,ephemeralScreenshotActionType:f}}g.getEphemeralSettingChangeData=a;g.getEphemeralScreenshotActionData=b}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWExternalId","MAWIndexedDb","MAWMsgType","MAWThreadSnippetBuildTxns","MAWWriteMsgTxns","WAGlobals","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i,j){if(e<0)throw c("err")("Received unexpected ephemeral time setting");e=d("MAWEphemeralUtils").getEphemeralSettingChangeData(b,e,h,i);h=e.ephemeralSettingChangeContent;i=e.ephemeralSettingChangeType;var k={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:(e=b)!=null?e:d("WAJids").AUTHOR_SYSTEM,msgContent:{adminMsgContent:h,adminType:i,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};e=j!=null&&b!=null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,j,g.jid,b):d("MAWDexieTable").dexieResolve();return e.then(function(b){if(b==null){var c,e=babelHelpers["extends"]({},k,{externalId:(c=j)!=null?c:d("MAWExternalId").generateExternalId(),threadJid:g.jid,ts:f});return d("MAWWriteMsgTxns").writeMsg(a,e,g).then(function(a){return babelHelpers["extends"]({},e,{msgId:a.msgId,rowId:a.rowId})})}else if(b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var h=babelHelpers["extends"]({},b,k);return a.messages.put(h).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(h)});return d("MAWDbMsgTxns").getThreadNewestMessageId(a,g).then(function(b){return h.msgId===b?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,h).then(function(a){var b=a.snippetParams,c=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:c,snippetType:a,threadJid:g.jid})});return h}):h})})}else return null})}function b(a,b,c,e,f,g,h){var i=b===d("WAGlobals").getMyUserJid(),j=d("MAWEphemeralUtils").getEphemeralScreenshotActionData(f,b,i),k=j.ephemeralScreenshotActionContent;j=j.ephemeralScreenshotActionType;if(h==null){var l={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:i?d("WAJids").AUTHOR_ME:b,externalId:g,msgContent:{adminMsgContent:k,adminType:j,screenshotActionType:f,version:1},threadJid:c.jid,ts:e,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return d("MAWWriteMsgTxns").writeMsg(a,l,c).then(function(a){return babelHelpers["extends"]({},l,{msgId:a.msgId,rowId:a.rowId})})}else if(h.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var m=babelHelpers["extends"]({},h,{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:i?d("WAJids").AUTHOR_ME:b,msgContent:{adminMsgContent:k,adminType:j,screenshotActionType:f,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return a.messages.put(m).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(h.threadJid,[h])});d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(m)});return d("MAWDbMsgTxns").getThreadNewestMessageId(a,c).then(function(b){return m.msgId===b?d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,m).then(function(a){var b=a.snippetParams,e=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:b,snippetSenderContactId:e,snippetType:a,threadJid:c.jid})});return m}):m})})}else return d("MAWDexieTable").dexieResolve(null)}g.writeEphemeralSettingAdminMsg=a;g.writeEphemeralScreenshotActionMsg=b}),98);
__d("MAWCastToMsgrServerMediaType",["MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"]);i=function(){return a};return a}function a(a,b){b===void 0&&(b=!1);if(b&&a==="image")return"xma";switch(a){case"image":case"video":case"gif":case"sticker":case"document":return a;case"ptt":return"audio";case"xma-image":return"xma";default:d("WALogger").ERROR(i(),a);return null}}function b(a,b){b===void 0&&(b=!1);if(b&&a===d("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(a){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"document";case"Ptt":return"audio";default:d("WALogger").ERROR(h(),a);return null}}g.castToMsgrServerMediaType=a;g.castClientMediaTypeToServerMediaType=b}),98);
__d("MAWDexieCastToPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;function a(a){return(g||(g=b("Promise"))).resolve(a)}function c(a){return a}f.dexieCastToPromise=a;f.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=c}),66);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieCastToPromise","MAWIndexedDb","MAWMediaUtils","MAWRavenUtils","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b){return{ephemeralMediaState:b,ephemeralMediaViewMode:d("MAWRavenUtils").getEphemeralMediaViewMode(a)}};function a(a,b,e,f){c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(b.msgIds).toArray().then(function(g){var j=a.threadJid;g=d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(g,j);j=a.ravenEphemeralType!=null&&a.ravenEphemeralMediaState!=null?d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:j,filteredMsgIds:g,hasMediaForUI:e,media:b,ravenSettings:h(a.ravenEphemeralType,a.ravenEphemeralMediaState),sortOrderMs:a.sortOrderMs}):d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:j,filteredMsgIds:g,hasMediaForUI:e,media:b,sortOrderMs:a.sortOrderMs});c("gkx")("2616")===!0?i(f,j):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:j})})))}function i(a,b){if(!j(b))return d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b});c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:a})})))}function j(a){switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:case d("MAWDbMedia").MEDIA_TYPE.VIDEO:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}g.handleNewMediaAfterTxn=a;g.handleNewMediaAfterTxnWithBridgeMedia=i}),98);
__d("MAWMediaBackupTxns",["MAWDbMediaTxns","MAWDexieTable","Promise","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ObjectId already shared by different msgId"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""]);o=function(){return a};return a}var p=1;function q(a,b,e,f,g,h){h===void 0&&(h=0);return f==null?d("MAWDexieTable").dexieResolve():d("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(a,f).then(function(i){if(i==null){var j={mediaId:b,msgId:e,objectId:f};g!=null&&(j=babelHelpers["extends"]({},j,{fbid:g}));return a.mediaBackup.add(j).then(function(a){return babelHelpers["extends"]({},j,{mediaBackupId:a})})["catch"](function(i){if(i.name==="ConstraintError"){if(h<p){d("WALogger").WARN(o(),i);return q(a,b,e,f,g,h+1)}throw c("err")("Failed to add mediaBackup entry. Original error: %s, %s",i.name,i.message)}d("WALogger").ERROR(n(),i);throw i})}else if(i.mediaId!==b||i.msgId!==e){d("WALogger").ERROR(m());return i}else{if(i.fbid==null&&g!=null){var k=babelHelpers["extends"]({},i,{fbid:g});return a.mediaBackup.put(k).then(function(a){return k})}else d("WALogger").WARN(l());return i}})}function a(a,c){if(c==null)return d("MAWDexieTable").dexieResolve();var e=[];c.forEach(function(a){a=a.objectId;a!=null&&e.push(a)});return d("MAWDbMediaTxns").maybeGetMediaBackupRowsFromObjectIds(a,e).then(function(e){var f=new Map(),g=[];c.forEach(function(a){var b=a.objectId;if(b!=null){var c=e.get(b);if(c==null){var h={mediaId:a.mediaId,msgId:a.msgId,objectId:b},l=a.fbid;h=babelHelpers["extends"]({},h,{fbid:l});f.get(b)!=null&&((l=f.get(b))==null?void 0:l.msgId)!==a.msgId&&d("WALogger").ERROR(k());f.set(b,h)}else{c.mediaId!==a.mediaId&&d("WALogger").ERROR(j());l=a.fbid;if(c.fbid==null&&l!=null){b=babelHelpers["extends"]({},c,{fbid:l});g.push(b)}else d("WALogger").WARN(i())}}});return(h||(h=b("Promise"))).all([a.mediaBackup.bulkAdd([].concat(Array.from(f.values()))),a.mediaBackup.bulkPut(g)]).then(function(){})}).then(function(){})}g.linkMediaBackup=q;g.bulkLinkMediaBackup=a}),98);
__d("MAWSupportedDocumentTypes",[],(function(a,b,c,d,e,f){"use strict";var g=["apk","pyc","7z","z","gz","xz","rar","zip","zipx","ace","arc","zpaq","quad","balz","cab","arj","lzh","uue","bz","bz2","bzip2","jar","iso","tar","ade","adp","air","app","application","bas","bat","chm","cmd","com","command","cpl","crt","dll","dmg","dpkg","exe","hlp","hta","inf","ins","isp","jnlp","js","jse","lib","lnk","lua","mde","msc","msi","msp","mst","ocx","pcd","pif","pkg","ps1","reg","scr","sct","sh","shb","shs","sys","term","url","vb","vbe","vbs","vxd","webarchive","wsc","wsf","wsh","xbap"];function a(a){if(a==null)return!1;a=a.includes(".")?a.split(".").pop():null;return a!=null&&!g.includes(a)}f.isAllowedType=a}),66);
__d("MAWMediaManagementTxns",["FBLogger","MAWBridgeTypesCreators","MAWBridgeUpload","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWSupportedDocumentTypes","MAWWriteMsgTxns","WAErrorMessage","WAJids","WALogger","WAMediaUtils","WASortedLists","WATagsLogger","WATimeUtils","err","gkx","isInstamadilloEB","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaBackup entry already exists for objectId ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. Error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry. Error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing mandatory args for incoming media msg"]);r=function(){return a};return a}var s=d("WATagsLogger").TAGS(["MAWMediaManagementTxns"]),t=c("gkx")("23924");function a(a,b,c,e){var f=c==null||b.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(t||!d("MAWSupportedDocumentTypes").isAllowedType((c=c.validatedDocumentFileInfo)==null?void 0:c.filename));return d("MAWWriteMsgTxns").prepareMsgWriteData(a,b,e).then(function(a){return babelHelpers["extends"]({},a,{shouldDropDocument:f})})}function b(a,b,e,f){f===void 0&&(f=!1);var g={validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo},h=d("MAWMediaUtils").genHMACPlaintextHash(b.plaintextHash),i=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry),j=i.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(i.objectId):null;return d("MAWDexieTable").dexieAll([u(a,e,b.plaintextHash,b.mediaType,b.size,b.mediaEntry,g,j,void 0,f),d("MAWDbChunkTxns").hasMediaChunk(a,h)]).then(function(b){var c=b[0];b=b[1];e.type!==d("MAWMsgType").MSG_TYPE.REVOKED&&!f&&d("MAWMediaAfterTxns").handleNewMediaAfterTxn(e,c,b,a);return c}).then(function(a){var b=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(i.serverMediaType,f),g=i.mediaKeyTimestamp;if(d("MAWMsgType").isMAWSupportedMediaType(e.type)&&!c("isInstamadilloEB")()){var h=e.threadJid;j!=null&&b!=null&&h!=null&&g!=null&&(b!=="document"||d("MAWConfig").getConfig().enableDocumentBackupAndRestore())?d("MAWIndexedDb").afterTransaction({tag:"UploadAttachment",value:d("MAWBridgeUpload").createBridgeUploadAttachment(j,b,e.externalId,d("MAWConfig").getConfig().productTypeForEBAttachments,d("WAJids").threadIdForChatJid(h),h,g)}):d("WALogger").WARN(r())}return a})}function u(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return v(a,b,c,e,f,g,h,i,j,k).then(function(c){var e=k?d("MAWDexieTable").dexieResolve():d("MAWDbMsgTxns").updateMediaId(a,b,c.mediaId,c.plaintextHash);return e.then(function(){return d("MAWMediaBackupTxns").linkMediaBackup(a,c.mediaId,b.msgId,i,j).then(function(){return c})})})}function v(a,b,e,f,g,h,i,j,k,l,r){l===void 0&&(l=!1);r===void 0&&(r=0);return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,e).then(function(t){var u=new Map(t==null?void 0:t.mediaEntries),w=z(h,j,k);w!=null&&u.set(b.msgId,w);if(t){r>0&&s.LOG(q(),e);t.msgIds||c("FBLogger")("messenger_web_devx").mustfix("Media missing msgIds: media type=%s",t.mediaType);t.mediaType||c("FBLogger")("messenger_web_devx").mustfix("Media missing mediaType: type=%s ; msg type=%s",f,b.type);var x=babelHelpers["extends"]({},t,i,{mediaEntries:u,mediaType:(w=t.mediaType)!=null?w:f,msgIds:d("WASortedLists").addToSet(t.msgIds||d("WASortedLists").emptySet(),b.msgId)});return a.media.put(x).then(function(){return x})}else{var y=d("MAWMediaUtils").genHMACPlaintextHash(e),A=babelHelpers["extends"]({fbid:(w=k)!=null?w:void 0,hashedPlaintextHash:y,mediaEntries:u,mediaType:f,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(t=j)!=null?t:void 0,plaintextHash:e,size:g,ts:d("WATimeUtils").unixTime()},i);return a.media.add(A).then(function(a){return babelHelpers["extends"]({},A,{mediaId:a})})["catch"](function(c){var q=d("WAErrorMessage").maybeGetMessageFromError(c);if(r>0){s.WARN(p(),e,y,q);s.ERROR(o(),q);throw c}else{s.WARN(n(),e,y,q);s.ERROR(m(),q);return v(a,b,e,f,g,h,i,j,k,l,r+1)}})}})}var w=function(a,b,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){if(b==null)throw c("err")("Do not have the media message in db when attachHashToMediaMsg");else return u(a,b,e,h,i,void 0,j,f,g,k)})},x=function(a,b,c){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var d=babelHelpers["extends"]({},b);c.validatedAudioInfo!=null&&(d.validatedAudioInfo=babelHelpers["extends"]({},b.validatedAudioInfo,c.validatedAudioInfo));c.validatedVideoInfo!=null&&(d.validatedVideoInfo=babelHelpers["extends"]({},b.validatedVideoInfo,c.validatedVideoInfo));c.validatedImageInfo!=null&&(d.validatedImageInfo=babelHelpers["extends"]({},b.validatedImageInfo,c.validatedImageInfo));c.validatedDocumentFileInfo!=null&&(d.validatedDocumentFileInfo=babelHelpers["extends"]({},b.validatedDocumentFileInfo,c.validatedDocumentFileInfo));return a.media.update(d.mediaId,d).then(function(){})}else s.WARN(l())})},y=function(a,b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var f=e?b.mediaEntries.set(c,e):b.mediaEntries;b=babelHelpers["extends"]({},b,{mediaEntries:f});return a.media.update(b.mediaId,b)}else{s.ERROR(k());return d("MAWDexieTable").dexieResolve()}})};function e(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDexieTable").dexieAll([w(a,b,e,f,g,h,j.size,i,k),d("MAWDbChunkTxns").getOrCreateMediaChunk(a,e,c,j.type)]).then(function(a){a=a[0];return a})}function z(a,b,c){var e;a=a;a!=null&&b!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(e,b));a!=null&&c!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(e,c));return a}function f(a,b,c){var e=new Map();a.mediaEntries.forEach(function(a,f){var g=d("WAMediaUtils").decodeMediaEntryData(a);g=g.objectId===b?d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(g,c):a;e.set(f,g)});return e}function A(a,b,c){var e=new Map();b.forEach(function(a){var b;b=(b=e.get(a.hashedPlaintextHash))!=null?b:[];b.push(a);e.set(a.hashedPlaintextHash,b)});return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,[].concat(Array.from(e.keys()))).then(function(f){var g=new Map(f.map(function(a){return[a.hashedPlaintextHash,a]})),h=new Map();b.forEach(function(a){var b=g.get(a.hashedPlaintextHash);if(a==null)return;var c=z(a==null?void 0:a.entry,a==null?void 0:a.objectId,a==null?void 0:a.fbId);if(b){var e=c?b.mediaEntries.set(a.msgId,c):b.mediaEntries;e=babelHelpers["extends"]({},b,{mediaEntries:e,msgIds:d("WASortedLists").addToSet(b.msgIds,a.msgId)});g.set(a.hashedPlaintextHash,e)}else I(h,a,c)});var i=new Map(),j=new Map();f=Array.from(h.values()).filter(function(a){return B(a,i,j)});return d("MAWDexieTable").dexieAll([a.media.bulkAdd(f),a.media.bulkPut(Array.from(g.values()))]).then(function(){return C(a,[].concat(Array.from(e.keys())),e,c)})})}function B(a,b,c){if(a.objectId!=null){var d=b.get(a.objectId);if(d!=null&&d!==a.hashedPlaintextHash){s.ERROR(j(),a.objectId,d,a.hashedPlaintextHash);return!1}}if(a.fbid!=null){d=c.get(a.fbid);if(d!=null&&d!==a.hashedPlaintextHash){s.ERROR(i(),a.fbid,d,a.hashedPlaintextHash);return!1}}a.objectId!=null&&b.set(a.objectId,a.hashedPlaintextHash);a.fbid!=null&&c.set(a.fbid,a.hashedPlaintextHash);return!0}function C(a,b,c,e){return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,b).then(function(b){return d("MAWDexieTable").dexieAll([F(a,b,c),d("MAWMediaBackupTxns").bulkLinkMediaBackup(a,G(b,c))]).then(function(){D(b,c,e,a);return b})})}function D(a,b,e,f){a.forEach(function(a){var g=b.get(a.hashedPlaintextHash);g!=null&&!E(g)&&c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(a.msgIds).toArray().then(function(b){b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e),hasMediaForUI:!1,media:a});c("gkx")("2616")===!0?d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(f,b):d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:b})})))})}function E(a){return a.reduce(function(a,b){return a||b.isXMAShare},!1)}function F(a,b,c){b=b.reduce(function(a,b){var d;(d=c.get(b.hashedPlaintextHash))==null?void 0:d.filter(function(a){return a!=null&&!a.isXMAShare}).forEach(function(c){return a.set(c.msgId,b.mediaId)});return a},new Map());return d("MAWDbMsgTxns").bulkUpdateMediaId(a,b)}function G(a,b){var c=new Map();a.forEach(function(a){var d;d=(d=b.get(a.hashedPlaintextHash))!=null?d:[];d.forEach(function(b){c.has(b.objectId)?s.ERROR(h(),b.objectId):b.objectId!=null&&c.set(b.objectId,{fbid:b.fbId,mediaId:a.mediaId,msgId:b.msgId,objectId:b.objectId})})});return Array.from(c.values())}function H(a,b){var c;a=a?new Map([[b.msgId,a]]):new Map();return babelHelpers["extends"]({fbid:(c=b.fbId)!=null?c:void 0,hashedPlaintextHash:b.hashedPlaintextHash,mediaEntries:a,mediaType:b.mediaType,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(c=b.objectId)!=null?c:void 0,plaintextHash:b.plaintextHash,size:b.size,ts:d("WATimeUtils").unixTime()},b.mediaInfo)}function I(a,b,c){var d=a.get(b.hashedPlaintextHash);d==null?a.set(b.hashedPlaintextHash,H(c,b)):(c!=null&&d.mediaEntries.set(b.msgId,c),d.msgIds.push(b.msgId))}g.prepareMediaWriteData=a;g.handleUnstoredDbMedia=b;g.linkMedia=u;g.createOrUpdateMediaRow=v;g.attachHashToMediaMsg=w;g.updateMediaEntryWithValidatedMediaInfo=x;g.updateMediaWithEncodedMediaEntryData=y;g.attachHashAndSaveMedia=e;g.updateBackupFbidInMediaEntries=f;g.bulkLinkMedia=A;g.linkMessageAndMediaBackupForMediaList=C}),98);
__d("MAWMsgActionType",[],(function(a,b,c,d,e,f){"use strict";a={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};f.MSG_ACTION=a}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"]);h=function(){return a};return a}function a(a,b,c){return i([{deliveryReceipts:b==="delivered"?c:[],msgId:a,readReceipts:b==="read"?c:[],senderReceipts:b==="sender"?c:[]}]).then(function(a){return a[0]||{type:"missing"}})}function i(a){var b=a.map(function(a){return a.msgId}),c=new Map();a.forEach(function(a){c.set(a.msgId,a)});a=b.map(function(a){var b=c.get(a);if(b==null){d("WALogger").ERROR(h());return null}var e=new Set(),f=new Map(),g=b.deliveryReceipts,i=b.readReceipts;b=b.senderReceipts;[{receiptType:"delivered",receivers:g},{receiptType:"read",receivers:i},{receiptType:"sender",receivers:b}].forEach(function(a){var b=a.receiptType;a=a.receivers;a.forEach(function(a){var c=a.device;a=a.ts;c=d("WAJids").extractUserJid(c);var g=!1;if(b!=="sender"){var h=f.get(c);a=j(h,b,a);f.set(c,a);g=k(h,a)}g&&e.add(c)})});return{affectedUserJids:e,receipt:{msgId:a,statusTsPerUser:f}}}).filter(Boolean);return d("MAWDexieTable").dexieResolve(a.map(function(a){return{affectedUserJids:a.affectedUserJids,receipt:a.receipt}}))}function j(a,b,c){var d;d=(d=a==null?void 0:a.deliveredTs)!=null?d:c;a=a==null?void 0:a.readTs;b==="read"&&a==null&&(a=c);return{deliveredTs:d,readTs:a}}function k(a,b){return((b==null?void 0:b.deliveredTs)||0)>((a==null?void 0:a.deliveredTs)||0)||((b==null?void 0:b.readTs)||0)>((a==null?void 0:a.readTs)||0)}function b(a,b){return a.receipts.bulkDelete(b)}g.writeReceiptsForDevices=a;g.bulkWriteReceiptsForDevices=i;g.bulkDeleteAllReceiptsForMessages=b}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a===d("MAWFolderTypes").FOLDER_ID.PENDING||a===d("MAWFolderTypes").FOLDER_ID.OTHER;return a}function b(a,b){return(a===null||a===d("MAWFolderTypes").FOLDER_ID.INBOX)&&(b===d("WADbContact").REVERSED_ONE_WAY_CONTACT||b===d("WADbContact").NON_CONTACT)}g.isMessageRequestOrSpamThread=a;g.isInboxRequest=b}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWBridgeThread","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMessageRequestUtils","MAWTimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e,f){f===void 0&&(f=!1);var g=new Map();g.set(b,{msgId:d,sortOrderMs:e});return h(a,g,f).then(function(a){a=a.get(b);if(a==null)throw c("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return a})}function h(a,b,c){c===void 0&&(c=!1);return j(a,b).then(function(e){var f=e.threadJidToReadReceiptInfo,g=e.updatedThreads;return a.threads.bulkPut(g).then(function(){g.forEach(function(a){var e;e=(e=b.get(a.jid))==null?void 0:e.sortOrderMs;e!=null&&!c&&d("MAWIndexedDb").afterTransaction({tag:"ThreadTimestampsUpdated",value:d("MAWBridgeThread").createBridgeThreadTimestampsUpdated(a.jid,e,e,!1)});f.set(a.jid,{isReadReceiptExpectedToBeSent:(a=(e=f.get(a.jid))==null?void 0:e.isReadReceiptExpectedToBeSent)!=null?a:!1,type:"success"})});return f})})}function i(a,b,c){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){if(a==null)return null;a=d("MAWTimeUtils").ensureValidMillisTime(b.newestMsgTs);return babelHelpers["extends"]({},b,{lastReadMsg:c.msgId,newestMsgTs:a})})}function j(a,b){var e=new Map(),f=Array.from(b.keys()),g=[];return a.threads.where("jid").anyOf(f).toArray().then(function(h){var j=new Map();h.forEach(function(a){return j.set(a.jid,a)});f.forEach(function(a){j.has(a)||j.set(a,null)});h=Array.from(j).map(function(d){var f=d[0];d=d[1];if(d==null){e.set(f,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}f=k(d.folder);e.set(d.jid,{isReadReceiptExpectedToBeSent:f,type:"success"});f=b.get(d.jid);if(f==null)throw c("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return i(a,d,f).then(function(a){a!=null&&g.push(a)})});return d("MAWDexieTable").dexieAll(h).then(function(){return{threadJidToReadReceiptInfo:e,updatedThreads:g}})})}function k(a){return!d("MAWMessageRequestUtils").isMessageRequestOrSpamThread(a)}g.markThreadAsReadUpToMsgSortOrderMs=a;g.bulkMarkThreadAsReadUpToMsgSortOrderMs=h;g.isReadReceiptExpectedToBeSentFor=k}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""]);h=function(){return a};return a}function a(a,b,c){var e=d("WAMsg").craftWAMsgIdString({author:c.author,chat:b,externalId:c.externalId});return a.pendingReceipts.get(e).then(function(b){if(b==null)return;d("WALogger").LOG(h(),c.externalId,c.author);if(b.author===d("WAJids").AUTHOR_ME){var f=d("MAWDexieTable").dexieResolve();b.deliveryReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"delivered",b.deliveryReceipts)}));b.readReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"read",b.readReceipts)}));return f.then(function(b){var f=[];b!=null&&b.type!=="missing"&&b.receipt.statusTsPerUser.forEach(function(b,e){var g=b.deliveredTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0),h=b.readTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0);b=(b=b.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);f.push(d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[c.threadJid,e],g,h,b))});return d("MAWDexieTable").dexieAll(f).then(function(){a.pendingReceipts["delete"](e)})})}else return d("MAWDexieTable").dexieAll([d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(a,c.threadJid,c.msgId,d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(c)))]).then(function(){return a.pendingReceipts["delete"](e)})})}g.processPendingReceipts=a}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWThreadSnippetForTextMsg","MAWUnsafeCoerce","MAWWriteMsgTxns","WAGlobals","WAJids","WAMsgType","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=b.args,f=b.externalId,g=e.editMsgContent;e=e.originalProtocolMsgId;var i=e.chat,j=e.externalId;return d("MAWDexieTable").dexieAll([a.threads.get({jid:i}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(e){var k=e[0],l=e[1];if(k==null)return d("WAResultOrError").makeError("missing_thread");if(l==null)return d("WAResultOrError").makeError("missing_msg");if(l.type!==d("WAMsgType").MSG_TYPE.TEXT)throw c("err")("Only text or cipher text can be edited. Original msg type: %s",l.type);return d("MAWDexieTable").dexieAll([a.messages.where("quoteExternalId").equals(j).filter(function(a){return((a=a.quote)==null?void 0:a.content.type)!==d("WAMsgType").NOTE_REPLY}).toArray(),a.editMsgHistory.where("originalMsgExternalId").equals(j).toArray(),d("MAWDbMsgTxns").getThreadNewestMessageId(a,k)]).then(function(e){var m=e[0],n=e[1],o=e[2];e=n.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===f});if((e==null?void 0:e.sendStatus)!=null&&e.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("already_sent");e=[];e.push(h(b,i,j));n=n.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===j});n==null&&(l.editCount==null||l.editCount===0)&&e.push(h(l,i,j));return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,e,!1).then(function(){var b,e=babelHelpers["extends"]({},l,{ack:d("MAWAckLevel").ACK.clock,editCount:((b=l.editCount)!=null?b:0)+1,msgContent:g});if(o!=null&&o===e.msgId){b=d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid());var h=c("MAWThreadSnippetForTextMsg")(e,b,d("WAJids").interpretAsGroupJid(k.jid)!=null),n=h.snippetParams;h=h.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:n,snippetSenderContactId:b,snippetType:h,threadJid:k.jid})})}var p=[],q=d("WAGlobals").getMyUserJid();n=m.find(function(a){var b;return(((b=a.quote)==null?void 0:b.content.author)===d("WAJids").AUTHOR_ME||((b=a.quote)==null?void 0:b.content.author)===q)&&a.threadJid===i});if(n!=null){b=n.quote;h=n.quoteExternalId;if(b==null)c("FBLogger")("messenger_web_devx").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",h);else{h=babelHelpers["extends"]({},n,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},e.msgContent)})})});p.push(h)}}return a.messages.bulkPut([e].concat(p)).then(function(){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,l)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e,void 0,a)})}).then(function(){p.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult({originalMsgExternalId:j,originalMsgId:l.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:i,externalId:f}})})})})})}function h(a,b,c){var e;return{author:d("WAJids").AUTHOR_ME,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=(e=a.args)==null?void 0:e.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:c,sendStatus:d("MAWAckLevel").ACK.clock,specialTextSize:a.specialTextSize,threadJid:b}}function b(a,b,c,e){if(b.type!==d("WAMsgType").MSG_TYPE.TEXT||!e||e.length===0)return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,c);var f=e.sort(function(a,b){return b.editTs-a.editTs})[0].msgContent;e=e.length;return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,babelHelpers["extends"]({},b,{editCount:e,msgContent:f}),c).then(function(c){return(c.type===d("WAMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,[d("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers["extends"]({},c,{msgContent:b.msgContent}),c.threadJid)]):d("MAWDexieTable").dexieResolve()).then(function(){return c})})}g.writeEdit=a;g.writeNewIncomingMsgAndEditHistory=b}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.groupInvites.put(b).then(function(){return b})}function b(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]])["delete"]()}function h(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).equals([b,c]).first()}function c(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]]).toArray()}function e(a,b){return b.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE?b.invitedParticipantUserJid==null?d("MAWDexieTable").dexieResolve():h(a,b.threadJid,b.invitedParticipantUserJid):d("MAWDexieTable").dexieResolve()}g.putGroupInvite=a;g.deleteGroupInvitesByThreadAndInvitedParticipant=b;g.maybeGetGroupInvite=h;g.getGroupInvitesByThreadAndInvitedParticipant=c;g.getAndCheckGroupInviteFromMsg=e}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=!1;return d("MAWDbParticipantTxns").getInvitedParticipantsInThread(a,b).then(function(e){if(e.length===0){c=!0;var f=d("WAGlobals").getMyUserJid();return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,f).then(function(){return c})}else{var g=[];e.forEach(function(c){g.push(d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,c.userJid))});return d("MAWDexieTable").dexieAll(g).then(function(){return c})}})}g.deleteGroupInvitesByThread=a}),98);
__d("MAWLoadMessageRequestCapabilitiesTxns",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){for(var b=0;b<a.length;b++){var c=a[b],e=d("WAJids").interpretAsUserJid(c.jid);if(e==null)continue;d("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:d("WAJids").extractUserId(e),threadJid:c.jid}})}return d("MAWDexieTable").dexieResolve()}g.loadMessageRequestDataForThreads=a}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadMessageRequestCapabilitiesTxns","WAGlobals","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"]);h=function(){return a};return a}function a(a,b){var c=b.authoritativeThreadKey,e=b.createTs,f=b.folder,g=b.lastActivityTimestamp,h=b.lastReadWatermarkTimestamp,i=b.offlineThreadingId,j=b.userJid;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:c,clientThreadKey:i,createTs:e,description:"getOrSetupOneToOneThread",folder:f,jid:j,lastActivityTimestamp:g,lastReadWatermarkTimestamp:h}).then(function(b){var c=b.created;b=b.thread;return m(a,j,c,b)})}function b(a,b){return d("MAWGetOrCreateThreadTxns").bulkGetOrCreateThread(a,b.map(function(a){var b=a.authoritativeThreadKey,c=a.createTs,d=a.folder,e=a.lastActivityTimestamp,f=a.lastReadWatermarkTimestamp,g=a.offlineThreadingId;a=a.userJid;return{authoritativeThreadKey:b,clientThreadKey:g,createTs:c,description:"getOrSetupOneToOneThread",folder:d,jid:a,lastActivityTimestamp:e,lastReadWatermarkTimestamp:f}})).then(function(c){return d("MAWDexieTable").dexieAll(c.map(function(c,d){var e=c.created;c=c.thread;return m(a,b[d].userJid,e,c)}))})}function e(a,b,c,e){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return null;var f=b.value;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:d("WATimeUtils").castUnixTimeToMillisTime(f.creationTs),description:"getOrRepairGroupThread",folder:c,jid:f.groupJid,skipVerifyThread:e}).then(function(a){var b=a.created;a=a.thread;return{created:b,groupInfo:f,thread:a}})})}function i(a,b){var c=[],e=[];b.forEach(function(a){d("MAWDbMsg").isMediaMsg(a)&&a.mediaId!=null&&(c.push(a.mediaId),e.push(a.msgId))});return a.media.bulkGet(c).then(function(b){var c=[],f=[];b.forEach(function(a,b){if(a!=null){var g=e[b];a.msgIds=d("WASortedLists").filter(a.msgIds,function(a){return a!==g});a.mediaEntries["delete"](g);a.msgIds.length===0&&a.mediaEntries.size===0&&(a.plaintextHash!=null&&c.push(a.hashedPlaintextHash),f.push(a.mediaId))}});b=a.media.bulkDelete(f);var g=a.chunk.where("hashedPlaintextHash").anyOf(c)["delete"]();return d("MAWDexieTable").dexieAll([b,g]).then(function(){d("WALogger").LOG(h(),f.length,c.length)})})}function j(a,b){return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b).then(function(c){return a.messages.where("threadJid").equals(b.jid).toArray().then(function(d){return k(a,b,c,d,!0)})})}function f(a,b,c,e){var f=c==null?void 0:c.lastMessageTimestamp;if(c==null)return j(a,b);var g=a.messages.where("threadJid").equals(b.jid).toArray(),h=d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b);return d("MAWDexieTable").dexieAll([g,h]).then(function(g){var h=g[0];g=g[1];var i=[],j=new Set();f!=null&&h.forEach(function(a){a.ts<=f+1&&(j.add(a.msgId),i.push(a))});if((c==null?void 0:c.messages.length)!==0){var l=new Set();c.messages.forEach(function(a){l.add((a=a.key)==null?void 0:a.id)});h.forEach(function(a){l.has(a.externalId)&&!j.has(a.msgId)&&(j.add(a.msgId),i.push(a))})}if(i.length!==h.length)for(var m=h,n=Array.isArray(m),o=0,m=n?m:m[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var p;if(n){if(o>=m.length)break;p=m[o++]}else{o=m.next();if(o.done)break;p=o.value}p=p;if(!j.has(p.msgId)&&p.type!==d("WAMsgType").ADMIN)return k(a,b,g,i,!1,e)}return k(a,b,g,h,!0,e)})}function k(a,b,c,e,f,g){var h=d("WAJids").interpretAsGroupJid(b.jid),j=f?d("MAWDbThreadTxns").deleteThreadRow(a,b.jid):d("MAWDexieTable").dexieResolve(),k=f?d("MAWDbParticipantTxns").deleteAllParticipantsForThread(a,b.jid):d("MAWDexieTable").dexieResolve(),l=d("MAWDexieTable").dexieResolve(!1),m=d("MAWDexieTable").dexieResolve();h!=null&&f&&(l=d("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(a,h),m=d("MAWDbGroupInfoTxns").deleteGroupInfo(a,h));return d("MAWDexieTable").dexieAll([i(a,e),d("MAWDbReactionsTxns").deleteAllReactionsForMessages(a,e),d("MAWDbMsgTxns").deleteMessages(a,e,g),j,k,m,l]).then(function(a){a[0];a[1];a[2];a[3];a[4];a[5];a=a[6];f?(d("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(b,c),h!=null&&a&&d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:d("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(b.jid)}),d("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:b.jid})):d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.jid,e)});return{deletedMessages:e.map(function(a){return d("MAWDbMsg").getWAMsgId(a)})}})}function l(a,b){var c=b.offlineThreadingId,e=b.userJid;return d("MAWGetOrCreateThreadTxns").createThread(a,{clientThreadKey:c,description:"setupOneToOneThread",jid:e}).then(function(b){return m(a,e,!0,b)})}function m(a,b,e,f){var g=[d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads([f])];b=[{type:"participant",userJid:b}];var h=d("WAGlobals").getMyUserJid();h!==f.jid&&b.push({type:"participant",userJid:h});if(c("gkx")("23923")){g.push(d("MAWDbParticipantTxns").bulkUpsertParticiantsInThread(a,f.jid,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(g).then(function(){return{created:e,thread:f}})}e?g.push(d("MAWDbParticipantTxns").bulkAddParticipants(a,f.jid,b).then(function(){})):g.push(d("MAWDbParticipantTxns").getParticipantsInThread(a,f.jid).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})}));return d("MAWDexieTable").dexieAll(g).then(function(){return{created:e,thread:f}})}g.getOrSetupOneToOneThread=a;g.bukGetOrSetupOneToOneThread=b;g.getGroupThread=e;g.deleteAllThreadData=j;g.metaSyncChatDeleteThread=f;g.setupOneToOneThread=l}),98);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","WAGlobals","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){return!c.success?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP:d("MAWDbGroupInviteTxns").maybeGetGroupInvite(a,b.threadJid,b.inviteeJid).then(function(c){return c&&!d("WATimeUtils").isInFuture(c.inviteExpirationTs)?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:d("MAWDbGroupInviteTxns").putGroupInvite(a,b)})})}function b(a,b,c,e){var f=b.caption,g=b.groupJid,h=b.inviteCode;b=b.inviteExpiration;var i=d("WAJids").interpretAsUserJid(c);if(g==null||b==null||h==null||i==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args"}));c=[d("WATimeUtils").castLongIntToUnixTime(b),d("WAJids").toGroupJid(g),d("WAGroupInviteUtils").toInviteCode(h)];var j=c[0];b=c[1];var k=c[2],l={folder:e,groupJid:b,inviteCode:k,inviteExpireTs:j,inviterJid:i,type:"group_invite"};return d("MAWThreadManagementTxns").getGroupThread(a,b,e,!0).then(function(b){return b==null?d("WAResultOrError").makeError(l):d("MAWDbParticipantTxns").getParticipant(a,b.thread.jid,i)}).then(function(b){if(!b.success)return d("WAResultOrError").makeError(l);var c=d("WAGlobals").getMyUserJid(),e=d("MAWDbParticipant").craftParticipantId(b.value.threadJid,c);return d("MAWDbGroupInviteTxns").putGroupInvite(a,{caption:f==null?void 0:f.text,inviteCode:k,invitedParticipantId:e,inviteeJid:c,inviteExpirationTs:j,inviterJid:i,threadJid:b.value.threadJid}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(a)});return d("WAResultOrError").makeResult()})})}g.writeGroupInvite=a;g.writeIncomingGroupInviteMsg=b}),98);
__d("MAWExpiredXMACleaner",["MAWMsgCleaner","WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["startExpiredXMACleaner invoked"]);j=function(){return a};return a}var k=null;function a(a){d("WALogger").LOG(j()),k==null&&(k=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.XMA))}function b(a){if(k==null){var b="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("err")(b)}else d("WALogger").DEV(h(),a),k.update(a)}function e(){return k}function f(){k=null}g.startExpiredXMACleaner=a;g.addNewExpiredXMACleanerTimestamp=b;g.getExpiredXMACleaner_FOR_TESTING_ONLY=e;g.resetExpiredXMACleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=!1;a!=null&&b.defaultPreviewMediaId===a.mediaId&&(c=(yield l(a)));return d("MAWBridgeXMA").createBridgeXMA(a,b,c)});return h.apply(this,arguments)}function c(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=(yield j(a,b,c));d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})});return i.apply(this,arguments)}function j(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=!1;a!=null&&(e=(yield d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbChunkTxns").hasMediaChunk(c,a.hashedPlaintextHash))));return d("MAWBridgeXMA").createBridgeXMA(a,b,e)});return k.apply(this,arguments)}var l=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(a){return function(b){return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash)}});g.checkMediaChunkTransactionAndCreatedBridgeXma=a;g.checkMediaChunkAndHandleXmaAfterTransaction=c;g.checkMediaChunkAndCreatedBridgeXma=j}),98);
__d("MAWXMAManagementTxns",["MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=b.unstoredDbXMA,i=b.unstoredFavicon,j=b.unstoredHeaderMedia,k=b.unstoredPreviews;f===void 0&&(f=!1);var l=new Map(),m=function(b){return b!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b,c,!0).then(function(a){return[b.plaintextHash,a]}):d("MAWDexieTable").dexieResolve([void 0,void 0])};f||(l.set(i==null?void 0:i.plaintextHash,m(i)).set(j==null?void 0:j.plaintextHash,m(j)),k==null?void 0:k.forEach(function(a){l.set(a==null?void 0:a.plaintextHash,m(a))}));b=Array.from(l.values());return d("MAWDexieTable").dexieAll(b).then(function(b){var l,m=new Map(b),n=((l=k)!=null?l:[]).map(function(a){return m.get(a.plaintextHash)}).filter(Boolean);return h(a,f?d("MAWXMAUtils").buildUnstoredTombstonedXMA(g):g,(l=m.get(i==null?void 0:i.plaintextHash))==null?void 0:l.mediaId,(l=m.get(j==null?void 0:j.plaintextHash))==null?void 0:l.mediaId,n.map(function(a){return a.mediaId}),c,e).then(function(a){return{dbMedias:b.map(function(a){a[0];a=a[1];return a}).filter(Boolean),dbXMA:a,firstPreview:n[0]}})})}function h(a,b,d,e,f,g,h){h=babelHelpers["extends"]({},b,{associatedMessageId:(b=h)!=null?b:void 0,defaultPreviewMediaId:f[0],faviconMediaId:d,headerMediaId:e,msgId:g.msgId,previewMediaIds:f});return a.xma.add(h).then(function(b){return a.xma.get(b)}).then(function(a){if(a==null)throw c("err")("Failed to write XMA to db");return a})}function b(a,b,c,e,f,g,h,i,j,k){var l=d("MAWXMAUtils").isXMAExpired(!1,j.targetExpiringAtSec);h=babelHelpers["extends"]({},j,{associatedMessageId:(j=h)!=null?j:void 0,author:i.author,externalId:i.externalId,isTombstoned:l,msgId:g,offlineAttachmentId:k,targetType:f,threadJid:i.chat});var m=l?h:babelHelpers["extends"]({},h,{defaultPreviewMediaId:(j=b)!=null?j:void 0,faviconMediaId:(g=e)!=null?g:void 0,headerMediaId:(k=c)!=null?k:void 0,previewMediaIds:b!=null?[b]:[]});return a.xma.add(m).then(function(a){return babelHelpers["extends"]({},m,{xmaId:a})})}g.handleUnstoredXMAContent=a;g.saveXMA=b}),98);
__d("MAWWriteXMAMessageTxns",["MAWBridgeMsg","MAWBridgeXMA","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","WAJids","WATimeUtils","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";f=6*d("WATimeUtils").HOUR_SECONDS;var h=new Set([d("MAWMsgType").MSG_TYPE.TEXT,d("MAWMsgType").MSG_TYPE.GIF,d("MAWMsgType").MSG_TYPE.STICKER]);function a(a,b,c,e){var f=c.unstoredAssociatedMedia,g=c.unstoredAssociatedMsg,h=c.unstoredDbXMA;return d("MAWDbXMATxns").maybeGetAssociatedXMAMsg(a,g,e.jid).then(function(c){var i=b;if(c!=null&&c.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var j=c.serverTs,k=c.sortOrderMs;c=c.ts;i=babelHelpers["extends"]({},b,{serverTs:j,sortOrderMs:k!=null?k-1:k,ts:c})}j=[h.targetExpiringAtSec,h.targetType];k=j[0];c=j[1];d("MAWXMAUtils").isXMAStoryReaction(c)&&(g==null?void 0:g.msgContent)!=null&&(i=babelHelpers["extends"]({},b,{msgContent:g.msgContent}));j=d("MAWXMAUtils").isXMAExpired(h.isTombstoned,k);i.isExpiredXmaMsg=j;k=!d("MAWXMAUtils").isXMAStoryReaction(c)&&g!=null?d("MAWWriteMsgTxns").prepareMsgWriteData(a,g,e):d("MAWDexieTable").dexieResolve(null);return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").prepareMsgWriteData(a,i,e),k]).then(function(a){var b=a[0];a=a[1];return{associatedData:a,associatedMedia:f,associatedMsg:g,xmaData:b,xmaMsg:i}})})}function b(a,b,e,f){var g=e.unstoredDbXMA,h=[g.targetExpiringAtSec,g.targetType],i=h[0];h=h[1];if(b==null||b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null});b.isExpiredXmaMsg!==!0&&i!=null&&d("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(i);d("MAWXMAUtils").isXMAStoryReaction(h)&&d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b)});return d("MAWXMAManagementTxns").handleUnstoredXMAContent(a,babelHelpers["extends"]({},e,{unstoredDbXMA:g}),b,f,b.isExpiredXmaMsg===!0).then(function(e){var f=e.dbMedias,g=e.dbXMA;e=e.firstPreview;g!=null&&!d("MAWXMAUtils").isXMAStoryReply(g.targetType)&&(b.isExpiredXmaMsg!==!0&&(c("gkx")("821")?c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,g,a)):d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(e,g,!1)})));return{dbMedias:f,dbXMA:g}})}function e(a,b,e,f,g,i,j){if(!h.has(g.type))throw c("err")("flow check, this message type is not supported for XMA replies");var k=b.author;if(k==="@system")throw c("err")("wrong author of story reply");var l=d("WAJids").interpretAsUserJid(f);if(l==null)throw c("err")("this is a flow check, participant jid can not be null");k={author:k===d("WAJids").AUTHOR_ME?l:d("WAJids").AUTHOR_ME,externalId:e.externalId,mediaId:i?void 0:e==null?void 0:e.defaultPreviewMediaId,msgId:c("gkx")("458")?e.msgId:void 0,sourceId:(l=(k=e.defaultCTA)==null?void 0:k.nativeUrl)!=null?l:(i=e.defaultCTA)==null?void 0:i.actionUrl,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.targetType};var m=babelHelpers["extends"]({},g,{mediaId:(l=j==null?void 0:j.mediaId)!=null?l:g.mediaId,quote:{content:k,remoteJid:f}});return a.messages.put(m).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(m)})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=f;g.XMA_REPLY_MSG_SUPPORTED_TYPES=h;g.prepareXMAWriteData=a;g.handleIncomingXMA=b;g.handleXMAReplyMsg=e}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbRavenActionTxns","MAWDexieTable","MAWEBSwitch","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWPendingReceiptProcessingTxns","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteMsgTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","WAJids","WAResultOrError","err","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"]);i=function(){return a};return a}var j=c("requireDeferred")("ArmadilloReceiveWriteDbSuccessFalcoEvent").__setRef("MAWHandleIncomingMsgApi"),k=c("requireDeferred")("EncryptedBackupTaskSkippedFalcoEvent").__setRef("MAWHandleIncomingMsgApi"),l=d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult(void 0));function a(a,b){b.receiveFlow.addPoint("him_write_message_start");return m(a,b).then(function(a){var c;b.receiveFlow.addPoint("him_write_message_end",{bool:{outOfSync:(a==null?void 0:(c=a.value)==null?void 0:c.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(c=a==null?void 0:(c=a.value)==null?void 0:c.msgType)!=null?c:"unknown"}});return a})["catch"](function(a){var c;a.message="[handleIncomingMsg] ["+((c=b.type)!=null?c:"")+"/"+b.action+"] "+a.message;throw a})}function m(a,b){if(b.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)return l;var e=function(c,e,f){return d("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(a,c,e,b.thread,b.device,f)};switch(b.type){case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.REACTION:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({reactToExternalId:b.msg.reactToExternalId}));case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("WAJids").isAuthorMe(b.id.author)?l:d("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(a,b.msg,b.thread.jid,b.folder);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return o(a)});var f=b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,b.existingEditMsgHistory):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza):d("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(a,b.msg,b.thread,b.editMsgHistories);return f.then(function(c){var f=b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.media,c):d("MAWDexieTable").dexieResolve();return f.then(function(f){return d("MAWDexieTable").dexieAll([p(a,b.id,c,c.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a,f==null?null:[f])})})});case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(a,b.msg,b.thread,b.originalMsg,b.previousRevokeMsg).then(function(c){return d("MAWDexieTable").dexieAll([p(a,b.id,c),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a)})});case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.device,b.msg.ephemeralExpirationInSec,b.msg.ephemeralLastUpdatedOrSetTimestamp,b.msg.isEphemeralSettingReset,b.thread,b.ts,b.id.externalId,!0).then(function(c){return p(a,b.id,c==null?void 0:c.dbMsg).then(function(){return o(c==null?void 0:c.dbMsg,c==null?void 0:c.outOfSyncEphemeralSetting)})});case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.thread,b.ts,b.screenshotActionType,b.id.externalId,b.existingMsg).then(function(c){return d("MAWDexieTable").dexieAll([p(a,b.id,c),e(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(c,a)})});case d("MAWMsgType").MSG_TYPE.XMA:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return o(a)});f=b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?n(a,b).then(function(c){return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.associatedMsg,b.thread).then(function(e){if(b.associatedMedia!=null)return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.associatedMedia,e).then(function(d){return q(a,c,e,b.xma,b.msg,b.associatedMsg,b.thread.jid,d)});else return q(a,c,e,b.xma,b.msg,b.associatedMsg,b.thread.jid)})}):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?n(a,b):n(a,b).then(function(c){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,c,b.xma,null).then(function(a){return babelHelpers["extends"]({},a,{dbMsg:c})})});return f.then(function(c){var f=c.dbAssociatedMsg,g=c.dbMedias,h=c.dbMsg;return d("MAWDexieTable").dexieAll([p(a,b.id,h,!0,f),e(h,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return o(h,a,g)})});default:throw c("err")("We do not support handleIncomingMsgInternal with type: "+((f=b.type)!=null?f:""))}}function n(a,b){return b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,null):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza):d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread)}function o(a,b,c){return d("WAResultOrError").makeResult({msgType:a==null?void 0:a.type,outOfSyncEphemeralSetting:(a=b)!=null?a:void 0,plaintextHashs:c==null?void 0:c.map(function(a){return a.plaintextHash})})}function p(a,b,e,f,g){var h=b.author,l=b.chat,m=b.externalId;f===void 0&&(f=!1);if(e==null)return d("MAWDexieTable").dexieResolve();void j.load().then(function(a){return a.log(function(){return{encrypted_backup_enable:c("MAWEBSwitch").isEnabled(),message_id:m}})});(!f||!c("MAWEBSwitch").isEnabled())&&void k.load().then(function(a){return a.log(function(){return{message_id:m,skipped_reason:"Msg type: "+e.type+", EB enabled: "+c("MAWEBSwitch").isEnabled().toString()}})});if(e==null)return d("MAWDexieTable").dexieResolve();b=d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,l,e);f=h===d("WAJids").AUTHOR_ME&&g!=null&&g.type!==d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,l,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([b,f]).then(function(){c("MAWHIMLogger").LOG(i())})}function q(a,b,e,f,g,i,j,k){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,b,f,e.msgId).then(function(f){var l=f.dbMedias;f=f.dbXMA;e==null&&c("MAWHIMLogger").ERROR(h(),i.externalId);return(e!=null&&f!=null&&d("MAWXMAUtils").isXMAStoryReply(f.targetType)?d("MAWWriteXMAMessageTxns").handleXMAReplyMsg(a,g,f,j,e,g.isExpiredXmaMsg===!0,k):d("MAWDexieTable").dexieResolve()).then(function(){return k!=null?{dbAssociatedMsg:e,dbMedias:l!=null?[].concat(l,[k]):[k],dbMsg:b}:{dbAssociatedMsg:e,dbMedias:l,dbMsg:b}})})}g.handleIncomingMsg=a;g.processReceipts=p}),98);
__d("MAWLinkReactionsToMsgsTxns",["LSQueryBulkUtils","MAWDbMsgTxns","MAWDbReactionUtils","MAWDexieCastToPromise","MAWRestoreDbState","MAWTransactor","WAMsgMap","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c,d={author:b.reactToAuthor,chat:b.threadJid,externalId:b.reactToExternalId};c=(c=a.get(d))!=null?c:[];c.push(b);return a.set(d,c)},new(d("WAMsgMap").MsgMap)())}function i(a){a.forEach(function(a){d("MAWDbReactionUtils").dispatchReaction(a)})}function j(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield d("MAWTransactor").runInLSDB(function(a){return d("LSQueryBulkUtils").bulkGetByIndex(a.e2ee_reactions.index("reactToExternalId"),b)}));return a});return k.apply(this,arguments)}function l(a,b){return a.reactions.where("reactToExternalId").anyOf(b).toArray()}function m(a,b){var e=d("MAWRestoreDbState").isUsingShim_UNSAFE()&&c("qex")._("1016")?function(){return d("MAWDexieCastToPromise").promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING(j(a,b))}:function(){return l(a,b)};return e().then(function(a){return h(a.filter(function(a){return a.reactToMsgId==null}))})}function a(a,b){return m(a,b).then(function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b.keys()).then(function(a){return a.flatMap(function(a){var c={author:a.author,chat:a.threadJid,externalId:a.externalId};c=(c=b.get(c))!=null?c:[];return c.map(function(b){b.reactToMsgId=a.msgId;return b})})})})}function n(a,b){return a.reactions.bulkPut(b).then(function(){i(b)})}function o(a,b){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){yield d("MAWTransactor").runInLSDB(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.e2ee_reactions;yield d("LSQueryBulkUtils").bulkPut(a,c)});return function(b){return a.apply(this,arguments)}}())});return p.apply(this,arguments)}function e(a,b){return d("MAWRestoreDbState").isUsingShim_UNSAFE()&&c("qex")._("1016")?d("MAWDexieCastToPromise").promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING(o(a,b)):n(a,b)}g.getReactionLinkUpdatesForExternalIds=a;g.updateReactionLinks=e}),98);
__d("MAWLinkReactionsToMsgsApi",["MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY},"linkReactionsToMsgs",function(a){return function(b){return d("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(a,b).then(function(b){return d("MAWLinkReactionsToMsgsTxns").updateReactionLinks(a,b)})}});function a(a){return h(a)}g.linkReactionsToMsgs=a}),98);
__d("MAWOfflineThreadTxns",["MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadMessageRequestCapabilitiesTxns","MAWWriteBulkWriteIncomingAdminMsgTxns","WAArrayZip","WAGlobals","WAJids","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""]);h=function(){return a};return a}var i=new Set();function a(a,b,c){var e=new Set(b),f=new Map(),g=new Map();c.forEach(function(a){g.set(a.jid,"exists"),f.set(a.jid,a),e["delete"](a.jid)});if(e.size===0)return d("MAWDexieTable").dexieResolve({threadCreationResult:g,threads:f});e.forEach(function(a){i.has(a)&&d("WATagsLogger").TAGS(["occamadillo","incoming_processing"]).LOG(h(),a)});return n(a,e).then(function(b){b.oneToOneThreadsCreationData.forEach(function(a){i.add(a.thread.jid)});b.groupThreadsCreationData.forEach(function(a,b){i.add(b),a.groupInfo==null&&g.set(b,"missing")});return a.threads.bulkAdd(o(b),{allKeys:!0}).then(function(b){return d("MAWDbThreadTxns").getThreads(a,Array.from(e.values())).then(function(b){l(b);var c=p(b);return d("MAWDexieTable").dexieAll([j(a,c),d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,b)]).then(function(){b.forEach(function(a){return f.set(a.jid,a)});return{threadCreationResult:g,threads:f}})})})})}function j(a,b){return d("MAWDexieTable").dexieAll([k(a,b),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(Array.from(b.values()))])}function k(a,b){var c=[],e=d("WAGlobals").getMyUserJid();b.forEach(function(a,b){c.push({threadJid:b,type:"participant",userJid:b}),e!==b&&c.push({threadJid:b,type:"participant",userJid:e})});return d("MAWDbParticipantTxns").bulkAddParticipantsInThreads(a,c).then(function(){})}function l(a){a.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,a.optimisticThreadKey,void 0,"createAllThreadsForOfflineMsgs")})})}function m(a,b){return{folder:null,jid:a,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsg:null,newestMsgTs:b!=null?d("WATimeUtils").castUnixTimeToMillisTime(b):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(d("WATimeUtils").millisTime(),a)}}function n(a,b){var c=[],e=[];b.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){return c.push(a)},user:function(a){return e.push(a)}})});return d("MAWDbGroupInfoTxns").getGroupInfos(a,c).then(function(a){var b=new Map(d("WAArrayZip").zip(c,a));a=new Map(c.map(function(a){var c=b.get(a);return[a,{groupInfo:c,thread:m(a,c==null?void 0:c.creationTs)}]}));var f=new Map(e.map(function(a){return[a,{thread:m(a,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:f}})}function o(a){var b=a.groupThreadsCreationData;a=a.oneToOneThreadsCreationData;return Array.from(b.values()).map(function(a){a=a.thread;return a}).concat(Array.from(a.values()).map(function(a){a=a.thread;return a}))}function p(a){var b=new Map();a.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){},user:function(c){return b.set(c,a)}})});return b}g.createAllThreadsForOfflineMsgs=a}),98);
__d("MAWPreprocessMsgs",["MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"]);l=function(){return a};return a}var m=c("MAWHIMLogger").TAGS(["MAWPreprocessMsgs"]);function a(a){var b=[],c=[];a.forEach(function(a){var d=a.msgData;a=a.unstoredContent;switch(d.type){case"IncomingMsg":if(a==null){m.ERROR(l());return}var e=a.unstoredDbEditActionMsg;a=a.unstoredDbReaction;if(a!=null){a={chatJid:d.id.chat,unstoredReaction:a};b.push(a)}e!=null&&c.push({chatJid:d.id.chat,msg:e});break;case"IncomingCiphertextMsg":default:break}});return{editActionMsgs:c,reactionMsgs:b}}function b(a,b,c){b.receiveFlow.addPoint("him_get_preprocessing_data_start");return n(a,b,c).then(function(a){var c;b.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:a.action,type:(c=a.type)!=null?c:""}});return a})}function n(a,b,c){var e=b.msgData,f=b.receiveFlow,g=b.unstoredContent;b=e.folder;var l=e.id,n=e.ts,p={id:l,receiveFlow:f,thread:c,ts:n},q=d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(e.type){case"IncomingMsg":if(g==null)return q;var r=e.device,s=g.unstoredDbMsg;f=g.unstoredDbRavenActionMsg;var t=g.unstoredDbReaction,u=g.unstoredIncomingDbGroupInvite;if(f!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:f,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));else if(t!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:t,type:d("MAWMsgType").MSG_TYPE.REACTION}));else if(u!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,folder:b,msg:u,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE}));else if(s==null)return q;else if(s.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){f=e.msg;if(f.version==="v3"&&f.type==="ephemeral")return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:f,type:s.type}));else{m.ERROR(k());return q}}else if(s.type===d("MAWMsgType").MSG_TYPE.ICDC_ALERT)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,data:null,device:r,folder:b,type:s.type}));else if(s.type===d("MAWMsgType").MSG_TYPE.TEXT||s.type===d("MAWMsgType").MSG_TYPE.FUTUREPROOF)return d("MAWWriteMsgTxns").prepareTextMsgWriteData(a,s,c).then(function(a){var b=a.editMsgHistories,c=a.existingEditMsgHistory,e=a.existingMsg,f=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza;a=a.pendingRevokedStanza;var i=o(e,s,c);if(g||f||e!=null&&i!==!0)return q;if(i&&e!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingEditMsgHistory:c,existingMsg:e,msg:s,type:s.type});if(h!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:s,pendingDeleteForMeStanza:h,type:s.type});return a!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:s,pendingRevokedStanza:a,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,editMsgHistories:b,msg:s,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.IMAGE||s.type===d("MAWMsgType").MSG_TYPE.VIDEO||s.type===d("MAWMsgType").MSG_TYPE.PTT||s.type===d("MAWMsgType").MSG_TYPE.GIF||s.type===d("MAWMsgType").MSG_TYPE.STICKER||s.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||s.type===d("MAWMsgType").MSG_TYPE.RAVEN){s.type===d("MAWMsgType").MSG_TYPE.IMAGE&&((t=e.msg.metadata)==null?void 0:t.groupId)!=null&&(s.groupId=e.msg.metadata.groupId,s.groupIndex=e.msg.metadata.groupIndex,s.groupSize=e.msg.metadata.groupSize);m.LOG(j(),s.externalId);return d("MAWMediaManagementTxns").prepareMediaWriteData(a,s,g==null?void 0:g.unstoredDbMedia,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread,e=a.isDeleteForMeOrRevoked,f=a.pendingDeleteForMeStanza,h=a.pendingRevokedStanza;a=a.shouldDropDocument;var j=[g==null?void 0:g.unstoredDbMedia,o(b,s)],k=j[0];j=j[1];k==null&&m.LOG(i(),s.externalId);if(a===!0||e||c||k==null||b!=null&&!j)return q;if(j&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingMsg:b,media:k,msg:s,type:s.type});if(f!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:s,pendingDeleteForMeStanza:f,type:s.type});return h!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:s,pendingRevokedStanza:h,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,media:k,msg:s,type:s.type})})}else if(s.type===d("MAWMsgType").MSG_TYPE.XMA){var v=g==null?void 0:g.unstoredXMA;return v==null?q:d("MAWWriteXMAMessageTxns").prepareXMAWriteData(a,s,v,c).then(function(a){var b=a.xmaData.existingMsg,c=o(b,s);if(a.associatedMsg!=null&&a.associatedData!=null&&!a.associatedData.isDeletedWithThread&&!a.associatedData.isDeleteForMeOrRevoked)if(c&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:a.associatedMsg,device:r,existingMsg:b,msg:a.xmaMsg,type:s.type,xma:v});else return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:a.associatedMedia,associatedMsg:a.associatedMsg,device:r,msg:a.xmaMsg,type:s.type,xma:v});if(c&&b!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,device:r,existingMsg:b,msg:a.xmaMsg,type:s.type,xma:v});c=a.xmaData;var e=c.isDeletedWithThread,f=c.isDeleteForMeOrRevoked,g=c.pendingDeleteForMeStanza;c=c.pendingRevokedStanza;if(e||f||b!=null)return q;if(g!=null)return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:a.xmaMsg,pendingDeleteForMeStanza:g,type:s.type});return c!=null?babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,device:r,msg:a.xmaMsg,pendingRevokedStanza:c,type:s.type}):babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:a.xmaMsg,type:s.type,xma:v})})}else if(s.type===d("MAWMsgType").MSG_TYPE.REVOKED)return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,s.revokedExternalId,c.jid,l.author),d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,s.externalId,c.jid,l.author)]).then(function(a){var b=a[0];a=a[1];return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:s,originalMsg:b,previousRevokeMsg:a,type:s.type})});else if(s.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){u=d("WAJids").isAuthorMe(l.author)?d("WAGlobals").getMyUserJid():l.author;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,l.externalId,c.jid,u)]).then(function(a){a=a[0];return babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,existingMsg:a,screenshotActionType:s.msgContent.screenshotActionType,type:s.type})})}else if(s.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,device:r,msg:s,type:s.type}));else{m.ERROR(h(),s.type);return q}case"IncomingCiphertextMsg":if(!((f=e==null?void 0:e.createPlaceholder)!=null?f:!1))return q;var w=d("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(l,n);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,w,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT})});case"UnavailableMsg":case"FrankingInvalidMsg":var x=d("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(l,n);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,x,c).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?q:babelHelpers["extends"]({},p,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:x,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}function o(a,b,c){if(a==null&&c==null)return!1;return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.CIPHERTEXT||(c==null?void 0:c.msgContent.content)===""}g.classifyIncomingMsgs=a;g.getMessageDataByType=b;g.isCiphertextUpdate=o}),98);
__d("MAWSharedOfflineQueueMetric",["$InternalEnum","FBLogger","WAGlobals","WAPREList","WATagsLogger","WATimeUtils","WAWaterFlow"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Waterflow should start before the start of the processing"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Possible stuck reason: ",""]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["offline-resume"]);f=b("$InternalEnum").Mirrored(["OFFLINE","ONLINE"]);var m=b("$InternalEnum").Mirrored(["WA_CLIENT_INFRA","WA_CLIENT_INFRA_DUPLICATED_START","WA_PASSIVE_MODE","WA_PASSIVE_MODE_FAIL","MAW_INFRA","MAW_NOT_IDLE_OQ"]),n=function(){function a(a,b,c,e){this.$1=0,this.$3=c,this.$2=d("WAWaterFlow").makeWaterflow("offline-resume",d("WAPREList").PRE_METRIC.OFFLINE_QUEUE),this.$6(a),this.$7(),this.$8(b),this.$9(e),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)}var b=a.prototype;b.$8=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"passive-mode-start":b.$2.isOnGoing()||b.$2.startMetric();b.$2.startPoint(m.WA_PASSIVE_MODE,{passiveModeAcks:a.count});b.$10("passive");break;case"passive-mode-end":b.$2.endPoint(m.WA_PASSIVE_MODE);b.$10("passive-end");break;default:a.type,b.$2.addPoint(m.WA_PASSIVE_MODE_FAIL),b.$10("passive-end")}})};b.$9=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();b.$10("wa");break}})};b.$6=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$11(a.offlineStats);b.$10("wa-start");break;case"offline-end":b.$2.isOnGoing()&&(b.$2.endPoint(m.WA_CLIENT_INFRA),b.$10("maw"));break;case"offline-entity":b.$12(a.serverTs,a.offline);b.$10("wa");break;case"offline-processed":b.$13(a.count);b.$10("wa");break;case"connection-lost":b.$2.isOnGoing()&&b.$2.endFail("connection-lost");b.$14();break;default:a}})};b.$10=function(a,b){var c=this;b===void 0&&(b=15e3);clearTimeout(this.$5);this.$2.isOnGoing()&&(this.$5=setTimeout(function(){c.$2.isOnGoing()&&(c.$2.endFail(a+"-stuck"),l.WARN(k(),a))},b))};b.$14=function(){clearTimeout(this.$5)};b.$7=function(){var a=this;this.$3.subscribe(function(b){switch(b.type){case"idle-oq-safe-guard":if(!a.$2.isOnGoing())break;a.$2.addPoint(m.MAW_NOT_IDLE_OQ);break;case"maw-infra-start":if(!a.$2.isOnGoing())break;a.$10("maw");a.$2.startPoint(m.MAW_INFRA);break;case"maw-infra-batch":a.$2.isOnGoing()||(a.$2.startMetric(),a.$2.startPoint(m.MAW_INFRA));a.$10("maw");break;case"maw-infra-end":if(!a.$2.isOnGoing())break;a.$2.endPoint(m.MAW_INFRA);a.$14();b.success?a.$2.endSuccess():a.$2.endFail("fail");break;default:b}})};b.addWAMessage=function(){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(a){a=a.waMessage;return{waMessage:((a=a)!=null?a:0)+1}}),this.$10("wa"))};b.addMAWEntity=function(a){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(b){b=b.mawProcessedCount;return{mawProcessedCount:((b=b)!=null?b:0)+a}}),this.$10("maw"))};b.$11=function(a){this.$2.isOnGoing()?this.$2.addPoint(m.WA_CLIENT_INFRA_DUPLICATED_START):(this.$1++,this.$2.startMetric(),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)),this.$2.startPoint(m.WA_CLIENT_INFRA,{batchSize:d("WAGlobals").getConfig().batchSize(),expectedAppdata:a.appdata,expectedCount:a.count,expectedMessage:a.message,expectedNotification:a.notification,expectedReceipt:a.receipt,offlineResumeCount:this.$1,useIncreasedSignalFutureMessagesMax:d("WAGlobals").getConfig().getSignalFutureMessagesMax()>2e3,waDanglingQueue:d("WAGlobals").getConfig().waDanglingQueue()})};b.getDetails=function(){var a;return((a=this.$2)==null?void 0:a.getAnnotations())||{}};b.$13=function(a){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{waProcessed:((b=b.waProcessed)!=null?b:0)+a}})};b.addRuntimeErrorDuringOffflineQueue=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{runtimeErrors:((a=a.runtimeErrors)!=null?a:0)+1}})}};b.addDecryptionError=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{decryptErrors:((a=a.decryptErrors)!=null?a:0)+1}})}};b.addRetriesTrack=function(a){if(this.$2.isOnGoing()){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{retries:((b=b.retries)!=null?b:0)+a}})}};b.$12=function(a,b){var c=this;if(!this.$2.isOnGoing()){l.WARN(j());return}this.$2.reAnnotate(function(d){var e=d.mailboxAgeSec,f=d.maxOffline;d=d.waDownloaded;e=e;e==null&&a!=null&&(e=c.$4-a,l.LOG(i(),e));e!=null&&a!=null&&(c.$4-a>e&&(e=c.$4-a,l.LOG(h(),e)));return{mailboxAgeSec:e,maxOffline:Math.max((e=f)!=null?e:0,b),waDownloaded:((f=d)!=null?f:0)+1}})};return a}(),o;function a(a,b,d,e){if(o!=null){var f=o;c("FBLogger")("messenger_web_devx").mustfix("Offline sync reported is inited twice");return f}o=new n(a,b,d,e);return o}function e(){if(o==null){c("FBLogger")("messenger_web_devx").mustfix("Offline sync reported is not inited");return null}return o}g.OfflineMode=f;g.OfflineStages=m;g.makeOfflineQueueMetric=a;g.getOfflineQueueMetric=e}),98);
__d("WAThrottle",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=null,e;function f(){var f=Date.now(),g=f-c;for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];e=i;g>=b?(clearTimeout(d),d=null,a.apply(void 0,i),c=Date.now()):d==null&&(d=setTimeout(function(){return a.apply(void 0,e)},b-g))}return f}f.throttle=a}),66);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","WAOfflineUtils","WATagsLogger","WAThrottle","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""]);k=function(){return a};return a}var l=1e3/3,m=d("WATagsLogger").TAGS(["ProtocolQueue","MAWConsumer"]);a=function(){function a(){var a=this;this.$1={};this.$2={};this.$3=0;this.$4="wa";this.$5=!1;this.$6=0;this.$7=0;this.$8=0;this.$9=0;this.$10=null;this.$16=d("WAThrottle").throttle(function(){if(a.$5)return;a.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},l);this.$12=d("WAThrottle").throttle(function(){a.$4==="wa"&&a.$5===!1&&a.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},l)}var b=a.prototype;b.subscribeToWAEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$10=d("MAWQplProxy").performanceAbsoluteNow();b.$6=a.offlineStats.count;b.$8=a.offlineStats.message;b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,b.$10);b.$5=!1;b.$4="wa";break;case"offline-processed":break;case"offline-entity":b.$7++;b.$12();break;case"offline-end":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Complete);b.$4="maw";break;case"connection-lost":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break;default:a}})};b.subscribeToMawEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"maw-infra-start":b.$10==null&&(b.$10=d("MAWQplProxy").performanceAbsoluteNow());b.$13();break;case"maw-infra-end":a.success?b.notifyUICurrentProcessingSucceeded():b.$14();b.$10=null;break}})};b.subscribeToMessageEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();break}})};b.addWAMessage=function(){this.$9++,this.$12()};b.$13=function(){this.$3=0,this.$5=!1,this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)};b.setThreadMetadata=function(a){var b=a.reduce(function(a,b){a[b.from]=b.t;return a},{});a=a.reduce(function(a,b){b=b.from;a[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing};return a},{});m.DEV(k(),JSON.stringify(b),JSON.stringify(a));this.$1=b;this.$2=a};b.notifyUIChatReady=function(a){this.$2[a]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)};b.updateChatState=function(a){var b=this;Object.entries(a).forEach(function(a){var c=a[0];a=a[1];if(b.$1[c]!=null){var e=b.$1[c];a>=e&&(b.$2[c]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}});this.$16()};b.addMAWEntity=function(a){this.$3+=a,this.$16()};b.notifyUICurrentProcessingSucceeded=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$5=!0;this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete);this.$1={};this.$2={}};b.$14=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed);this.$1={};this.$2={}};b.maybeNotifyUI=function(){this.$16()};b.$11=function(a,b){d("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:a,timestamp:b!=null?b:d("MAWQplProxy").performanceAbsoluteNow()})};b.$15=function(a){var b=d("MAWQplProxy").performanceAbsoluteNow();b={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:a,timestamp:b,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.LOG(j(),JSON.stringify(b));a===d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",b),function(){m.LOG(i())},function(a){m.ERROR(h(),a)}):d("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",b)};return a}();b=new a();g.ConsumerUINotifier=a;g.offlineResumeUINotifier=b}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=[],e=d("WAGlobals").getMyUserJid();b.forEach(function(b){return d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(){c.push(d("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(a,b.jid,e))},user:function(){}})});return d("MAWDexieTable").dexieAll(c).then(function(a){a.forEach(function(a,b){a.forEach(function(b,a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(b)})})})})}g.loadGroupInvites=a}),98);
__d("MAWLoadMsgsTxns",["MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeTypesCreators","MAWBridgeXMA","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDbXMATxns","MAWDexieTable","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWXMAUtils","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);h=function(){return a};return a}function i(a,b){return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b[0],e=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,e.hashedPlaintextHash).then(function(b){d("MAWMediaAfterTxns").handleNewMediaAfterTxn(c,e,b,a)})}))})}function j(a,b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.defaultPreviewMediaId).then(function(e){c("gkx")("821")?c("promiseDone")(d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,b,a)):d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(e,b,!1)})})}))})}function k(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessages(a,b).then(function(a){a.forEach(function(a){return d("MAWDbReactionUtils").dispatchReaction(a)});return a})}function a(a,b,c,e,f,g){f===void 0&&(f=!1);return d("MAWDbMsgTxns").getMsgsFromOffset(a,b,c,e,f,!1,g).then(function(b){var c=b.msgs,e=babelHelpers.objectWithoutPropertiesLoose(b,["msgs"]);return d("MAWDexieTable").dexieAll(c.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return babelHelpers["extends"]({msgs:c,replyMediaInfo:a},e)})}).then(function(e){var l=e.hasMoreAfter,m=e.hasMoreBefore,n=e.msgs,o=e.replyMediaInfo;e=n.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(o||[])[b])}).filter(Boolean);e.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:e}});e=n.filter(function(a){return a.ephemeralCounterStarted});e.length>0&&(d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.OnLoad]).LOG(h(),e.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(e)}));(n.length>0||c==null)&&d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(b,n,f,m,l,g)});return d("MAWDexieTable").dexieAll([k(a,n),d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,n),i(a,n),j(a,n)]).then(function(a){a=a[0];return{hasMoreAfter:l,hasMoreBefore:m,msgs:n,reactions:a}})})}g.loadMsgsAndMediaFromOffset=a}),98);
__d("MAWLoadThreadsTxns",["FBLogger","MAWBridgeParticipants","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsg","MAWDbParticipantTxns","MAWDbReaction","MAWDbReactionUtils","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMessageRequestCapabilitiesTxns","MAWLoadMsgsTxns","MAWThreadSnippetBuildTxns","MAWTransactionMode","WAGlobals","WAJids","WALogger","err","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="loadContentsForThreads");b.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,e==null?void 0:e.get(a.jid),void 0,f)})});return d("MAWDexieTable").dexieAll([].concat(b.map(function(b){return j(a,b,c)}),[h(a,b),l(a,b),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(b),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])).then(function(){return b})}function b(a,b,c,e){return d("MAWDexieTable").dexieAll([h(a,[c]),j(a,c,e),i(a,c)]).then(function(e){e=e[0];b||n(a,c.jid,d("WAJids").interpretAsGroupJid(c.jid)!=null,!1,c.cannotReplyReason,c.archived);return e})}function h(a,b){return b.length===0?d("MAWDexieTable").dexieResolve([]):d("MAWDbParticipantTxns").getParticipantsInThreads(a,b.map(function(a){return a.jid})).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)});return a})}function i(a,b){var e=b.newestMsg,f=b.snippetMsg;f=(f=f)!=null?f:e;return f==null?d("MAWDexieTable").dexieResolve():d("MAWDexieTable").dexieAll([a.messages.get({msgId:f}),a.reactions.get({reactionId:f})]).then(function(e){var f=e[0];e=e[1];f!=null&&e!=null&&c("FBLogger")("maw_db").warn("[MAWLoadThreadsTxns] msgId collision detected between Reaction and Message");e!=null&&c("qex")._("1016")!==!0&&d("MAWDbReactionUtils").dispatchReaction(e);return k(a,f,b,e).then(function(a){if(a!=null){var c=a.snippetParams,e=a.snippetSenderContactId;a=a.snippetType;d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({snippetParams:c,snippetSenderContactId:e,snippetType:a,threadJid:b.jid})})}})})}function j(a,b,c){return d("MAWLoadMsgsTxns").loadMsgsAndMediaFromOffset(a,b.jid,null,c,!0)}function k(a,b,c,e){e=e!=null?d("MAWDbReaction").castToIncomingDbReaction(e):e;return e!=null&&e.ts>(b!=null?d("MAWDbMsg").getCanonicalTsFromMsg(b):0)?d("MAWThreadSnippetBuildTxns").buildReactionThreadSnippet(a,e.author,e.reaction,c.jid):b==null?d("MAWDexieTable").dexieResolve(null):d("MAWThreadSnippetBuildTxns").buildThreadSnippet(a,b)}function l(a,b){var c=[];b.forEach(function(a){return d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return c.push(a)},user:function(){}})});return a.groupInfo.bulkGet(c).then(function(a){a.forEach(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}e=function(a){a=a.threadJid;return m(a)};var m=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return n.apply(void 0,[a].concat(c))}});function n(a,b,e,f,g,h){e===void 0&&(e=!0);f===void 0&&(f=!0);var i=d("WAGlobals").getMyUserJid();return d("MAWDbParticipantTxns").getParticipant(a,b,i).then(function(a){if(!a.success){var j=e?"group":"one_to_one";d("WALogger").LOG(["[Occamadillo] User is not a participant of "+j+" thread\n        "+b.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);if(g==null){var k;c("FBLogger")("maw_db","checkIfParticipant").catching((k=a.payload)!=null?k:c("err")(a.error)).warn("[Occamdillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",i,j,b.toString(),f,h)}c("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamdillo] User not a participant from checkIfParticipant");k={cannotReplyReason:"viewer_not_subscribed",threadJid:b};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(k)})}})}g.loadContentsForThreads=a;g.loadParticipantsAndMsgs=b;g.loadParticipants=h;g.loadGroups=l;g.checkIfGroupParticipant=e}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMessageRequestCapabilitiesTxns","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="fetchAndEmitThread");return d("WAJids").switchOnMsgrChatJidType(b,{group:function(b){return d("MAWThreadManagementTxns").getGroupThread(a,b,c).then(function(a){return a==null?null:{created:a.created,thread:a.thread}})},user:function(b){var f;return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,{createTs:e==null?void 0:d("WATimeUtils").castUnixTimeToMillisTime(e),folder:(f=c)!=null?f:void 0,userJid:b})}}).then(function(b){return b==null||b.thread==null?null:d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b.thread],1,null,f).then(function(){return b})})}function h(a,b){if(!c("gkx")("23922"))return d("MAWDexieTable").dexieResolve();b=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return{oldestMsgId:a,thread:b}})});return d("MAWDexieTable").dexieAll(b).then(function(a){a.forEach(function(a){var b=a.oldestMsgId;a=a.thread;return d("MAWIndexedDb").afterTransaction({tag:"UpdateMessageRange",value:d("MAWBridgeTypesCreators").createBridgeUpdateMessageRange({newestMsgId:null,newestMsgTs:null,oldestMsgId:b,thread:a})})})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();b=Array.from(b);return a.threads.where("jid").anyOf(b).toArray().then(function(b){return h(a,b).then(function(){var c=b.filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWLoadThreadsTxns").loadParticipants(a,c),d("MAWLoadThreadsTxns").loadGroups(a,c),d("MAWLoadMessageRequestCapabilitiesTxns").loadMessageRequestDataForThreads(c),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,c)])})}).then(function(){})}g.fetchAndEmitThread=a;g.emitThreadContents=b}),98);
__d("MAWBulkHandleIncomingMsgApi",["MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsApi","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAMsgMap","WAOdsEnums","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""]);o=function(){return a};return a}var p=c("gkx")("2014");function a(a){var b;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(b=d("MAWTransactionMode")).READWRITE,deletedMessages:b.READWRITE,deviceChangeAlerts:b.READWRITE,editMsgHistory:b.READWRITE,ephemeralSettings:b.READWRITE,existingUsers:b.READWRITE,ftsBackloggedMessages:b.READWRITE,ftsPurgeBacklog:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READWRITE,media:b.READWRITE,mediaBackup:b.READWRITE,messages:b.READWRITE,participants:b.READWRITE,pendingReceipts:b.READWRITE,pendingStanzas:b.READWRITE,reactions:b.READWRITE,threads:b.READWRITE,unrenderedMessages:b.READWRITE,xma:b.READWRITE},"bulkHandleIncomingMsgs",function(b){return function(){var e=d("MAWDexieTable").dexieResolve(),f=new(d("WAMsgMap").MsgMap)();d("MAWODSProxy").odsBumpEntityKey({amount:a.length,entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"});d("MAWDexieTable").setDexiePSDItem("offlineQueueSize",a.length);var g=new Set(a.map(function(a){a=a.msgData;return a.id.chat})),h=d("MAWPreprocessMsgs").classifyIncomingMsgs(a),i=h.editActionMsgs,j=h.reactionMsgs,k=function(a,b){var e=f.get(a);if(!b.success)f.set(a,b);else if(e==null)c("MAWHIMLogger").ERROR(o(),b);else if(!e.success)c("MAWHIMLogger").WARN(n());else if(p)f.set(a,d("WAResultOrError").makeResult(babelHelpers["extends"]({},e.value,b.value)));else{e=e.value;b=b.value;(b==null?void 0:b.outOfSyncEphemeralSetting)!=null&&(e=babelHelpers["extends"]({},e,{outOfSyncEphemeralSetting:b.outOfSyncEphemeralSetting}));if((b==null?void 0:b.plaintextHashs)!=null){var g;e=babelHelpers["extends"]({},e,{plaintextHashs:(g=e.plaintextHashs)!=null?g:b.plaintextHashs})}(b==null?void 0:b.reactToExternalId)!=null&&(e=babelHelpers["extends"]({},e,{reactToExternalId:b.reactToExternalId}));e=babelHelpers["extends"]({},e,{msgType:(g=(g=e)==null?void 0:g.msgType)!=null?g:b==null?void 0:b.msgType});f.set(a,d("WAResultOrError").makeResult(e))}};return q(b,g).then(function(h){var n=h.threadCreationResult,o=h.threads,q=function(a,b){f.set(a,d("WAResultOrError").makeResult({protocolMsgId:a,unknownGroup:b==="missing"}))};h=d("MAWDexieTable").dexieAll(a.map(function(a){var e;e=[o.get(a.msgData.id.chat),(e=n.get(a.msgData.id.chat))!=null?e:"missing"];var f=e[0];e=e[1];if(f==null){c("MAWHIMLogger").ERROR(m(),e);c("MAWHIMLogger").WARN(l(),e,a.msgData.id.externalId);return}q(a.msgData.id,e);return d("MAWPreprocessMsgs").getMessageDataByType(b,a,f)}).filter(Boolean))["catch"](function(a){a.message="[getAllMessagesProcessingData] "+a.message;throw a});return d("MAWDexieTable").dexieAll([d("MAWBulkWriteReactionsTxns").prepareReactionsData(b,j),h]).then(function(a){var c=a[0],h=a[1];return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(b,c).then(function(){var a=p?t(h):h;a.forEach(function(a){e=e.then(function(){return d("MAWHandleIncomingMsgApi").handleIncomingMsg(b,a)}).then(function(b){k(a.id,b),r(a.id,a.ts)})});e["catch"](function(a){a.message="[writeIncomingMsgs] "+a.message;throw a});return e}).then(function(){var a=i.length===0?d("MAWDexieTable").dexieResolve():d("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(b,i).then(function(a){return d("MAWBulkEditMsgsTxns").bulkEditMsgs(b,i,a)});return a.then(function(){return d("MAWThreadFetchAndEmitTxns").emitThreadContents(b,g).then(function(){return{msgResults:f}})})})})})}})().then(function(a){var b=new Set();a.msgResults.values().forEach(function(a){if(a.success){a=a.value;(a==null?void 0:a.reactToExternalId)!=null?b.add(a.reactToExternalId):(a==null?void 0:a.protocolMsgId)!=null&&b.add(a.protocolMsgId.externalId)}});return d("MAWLinkReactionsToMsgsApi").linkReactionsToMsgs(Array.from(b)).then(function(){return a})})}function q(a,b){var c=Array.from(b);return d("MAWDbThreadTxns").getThreads(a,c).then(function(b){return d("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(a,c,b)})}function r(a,b){var c;a=a.chat.toString();d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((c={},c[a]=b,c));d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1);(a=d("MAWSharedOfflineQueueMetric").getOfflineQueueMetric())==null?void 0:a.addMAWEntity(1)}var s=c("MAWHIMLogger").TAGS(["MergeActions"]);function t(a){s.LOG(k(),a.length);var b=new(d("WAMsgMap").MsgMap)();for(var c=0;c<a.length;c++){var e=a[c];s.LOG(j(),e.id.externalId);e.receiveFlow.addPoint("him_merge_actions");var f=b.get(e.id);if(f==null){b.set(e.id,e);continue}if(f.action===e.action&&f.type===e.type){e.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(e.action){case d("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:if(f.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||f.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.ERROR(i());continue}b.set(e.id,e);continue;case d("MAWMsgActionType").MSG_ACTION.WRITE:case d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:if(f.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||f.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.ERROR(h());continue}switch(e.type){case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:f.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE&&b.set(e.id,e);break;default:b.set(e.id,e)}break;case d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case d("MAWMsgActionType").MSG_ACTION.REVOKE:f.action!==d("MAWMsgActionType").MSG_ACTION.REVOKE&&b.set(e.id,e);break}}f=[];for(e=0;e<a.length;e++){var g;c=a[e];var l=b.get(c.id);c.receiveFlow.addAnnotations({string:{final_action:(g=l==null?void 0:l.action)!=null?g:"undefined",initial_action:c.action}});if(l==null||l.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)continue;f.push(l);b["delete"](c.id)}return f}g.bulkHandleIncomingMsgs=a}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}g.convertXMATargetTypeToExtendedContentTargetType=a}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAStanzaUtils","WATagsLogger","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Author info is missing from msg: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message type: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message content type: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""]);l=function(){return a};return a}e=b("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function m(a,b){var e,f=a.contentType;switch(f){case d("EchoMessage").EchoMessageContentType.TEXT:return a.xContentType===d("EchoMessage").EchoXMessageContentType.BUMP&&c("gkx")("4323")?d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:d("MAWMsgType").MSG_TYPE.TEXT;case d("EchoMessage").EchoMessageContentType.MEDIA:return n(a);case d("EchoMessage").EchoMessageContentType.PLACEHOLDER:if(a.contentSubtype===d("EchoMessage").EchoMessageContentSubtype.UNSEND)return d("MAWMsgType").MSG_TYPE.REVOKED;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(e=b)!=null?e:""]).ERROR(l(),d("EchoMessage").EchoMessageContentType.getName(f),a.xContentType!=null?d("EchoMessage").EchoXMessageContentType.getName(a.xContentType):"unknown",d("EchoMessage").EchoMessageContentSubtype.getName(a.contentSubtype),a.serializationOrigin!=null?d("EchoMessage").EchoSerializationOriginType.getName(a.serializationOrigin):"unknown");break;case d("EchoMessage").EchoMessageContentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return d("MAWMsgType").MSG_TYPE.CIPHERTEXT;default:d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(e=b)!=null?e:""]).ERROR(k(),d("EchoMessage").EchoMessageContentType.getName(f))}return null}function n(a,b){a=a.mediaData;if(a!=null){switch(a.attachmentType){case d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessageMediaFieldUtils").AttachmentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessageMediaFieldUtils").AttachmentType.PTT:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessageMediaFieldUtils").AttachmentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(b=b)!=null?b:""]).ERROR(j(),d("EchoMessageMediaFieldUtils").AttachmentType.getName(a.attachmentType))}return null}function a(a,b,c,e,f){var g=a.from;if(g==null){var h;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(h=f)!=null?h:""]).ERROR(i(),e);return null}h=m(a,f);if(h==null||a.isTombstoned!=null&&a.isTombstoned)return null;switch(h){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:return s(a,b,c,g,h,e,f);case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.XMA:return q(a,b,c,g,h,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return v(a,b,c,g,h,e)}return null}function o(a,b,c,d,e,f){a=t(a,b,c,d,e,f);return p(e,a)}function p(a,b){switch(a){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}}function q(a,b,c,e,f,g){b=t(a,b,c,e,f,g);c=a.text;if(a.xmaData!=null&&a.xmaData.xmaTargetType!=null){e=babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(a.xmaData.xmaTargetType)});c!=null&&(e.msgContent={content:c});return e}return null}function r(a){if(a==null)return void 0;else switch(a){case d("EchoMessage").MessageTextSize.SMALL:return 1;case d("EchoMessage").MessageTextSize.MEDIUM:return 2;case d("EchoMessage").MessageTextSize.LARGE:return 3;default:return void 0}}function s(a,b,c,e,f,g,i){var j=a.text;if(j==null){var k;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",(k=i)!=null?k:""]).ERROR(h(),g);return null}k=t(a,b,c,e,f,g,i);if(f===d("MAWMsgType").MSG_TYPE.REVOKED){j!=null&&(k.msgContent={content:j});a.revokeSentTimestampMs!=null&&(k.originalTs=d("WATimeUtils").castToUnixTime(a.revokeSentTimestampMs));return babelHelpers["extends"]({},k,{revokedExternalId:d("WAStanzaUtils").toStanzaId("0"),type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:a.revokeUnsentTimestampMS!=null?d("WATimeUtils").castToUnixTime(a.revokeUnsentTimestampMS):k.ts})}else if(f===d("MAWMsgType").MSG_TYPE.CIPHERTEXT)return babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:r(a.textSize),type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT});else{b=babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:r(a.textSize),type:d("MAWMsgType").MSG_TYPE.TEXT});return babelHelpers["extends"]({},b,{editCount:Math.max(a.editHistory.length-1,0),groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize})}}function t(a,b,c,e,f,g,h){h=u(e,c);e={ack:h===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h,externalId:g,groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize,isForwarded:a.isForwarded,sortOrderMs:a.sortOrderMs,threadJid:b,ts:d("WATimeUtils").castToUnixTime(a.displayTimestampMs/1e3),type:f};a.authoritativeTimestampMs!=null?e.serverTs=d("WATimeUtils").castToUnixTime(a.authoritativeTimestampMs/1e3):e.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);if(a.quoteData!=null){h=d("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(a,c);h!=null&&(e.quote=h,e.quoteExternalId=h.content.externalId)}return e}function u(a,b){a=d("MAWJids").toUserJid(a.localKey);return a===b?d("WAJids").AUTHOR_ME:a}function v(a,b,c,e,f,g){a=t(a,b,c,e,f,g);return babelHelpers["extends"]({},a,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}g.MAWRestoreType=e;g.getDbMsgTypeFromEchoMessage=m;g.getUnstoredDbMessageFromEchoMessage=a;g.resolveAuthorFromEchoAddress=u}),98);
__d("MAWRepliesRestoreUtils",["EchoEncodingUtils","FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""]);h=function(){return a};return a}function a(a,b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return a;else{b={author:b.author,externalId:b.externalId,ts:b.ts,type:b.type};b={content:b,remoteJid:null};return babelHelpers["extends"]({},a,{quote:b})}}function b(a,b){if(a.quoteData!=null&&a.quoteData.quoteMessageId!=null&&a.quoteData.quoteMessageSender!=null){b={author:d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(a.quoteData.quoteMessageSender,b),externalId:(b=a.quoteData)==null?void 0:b.quoteMessageId,ts:a.displayTimestampMs,type:c("gkx")("458")?(b=d("EchoEncodingUtils").convertXMessageContentTypeToDbMsgType(a.xContentType))!=null?b:d("MAWMsgType").MSG_TYPE.TEXT:d("MAWMsgType").MSG_TYPE.TEXT};return{content:b,remoteJid:null}}else d("WALogger").ERROR(h(),a.messageId);return null}f=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,threads:e.READWRITE,xma:e.READONLY},"updateQuoteDataForReplyMessages",function(a){return function(b,c){c==null?void 0:c.addPoint("replies_restore_start");b=b.restoredMsgsData;if(b){var e=b.existingMsgs;b=b.newlyAddedMsgs;b=b.concat(e);return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,b.threadJid,b).then(function(a){var c=[];b.quoteExternalId!=null&&c.push(b);a!=null&&c.push.apply(c,a);return c})})).then(function(b){b=b.reduce(function(a,b){return b.length>0?a.concat(b):a},[]);return i(a,b)}).then(function(a){c==null?void 0:c.addPoint("replies_restore_end",{"int":{replies:a}});return a})}return d("MAWDexieTable").dexieResolve(0)}});function i(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var e=j(b);if(b.threadJid!=null)return d("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(a,e,b.threadJid).then(function(a){return babelHelpers["extends"]({},a,{msgId:b.msgId,originalTs:b.originalTs,rowId:b.rowId,threadJid:b.threadJid,unsendMsgContentDeleteTs:b.unsendMsgContentDeleteTs})});else c("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(a){return a.filter(Boolean).filter(function(a){return a.quote!=null})}).then(function(b){return a.messages.bulkPut(b).then(function(c){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a,void 0,void 0,"EncryptedBackups")})})})}).then(function(a){return(a=b==null?void 0:b.length)!=null?a:0})})}function j(a){a.msgId;a.originalTs;a.rowId;a.threadJid;a.unsendMsgContentDeleteTs;a=babelHelpers.objectWithoutPropertiesLoose(a,["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"]);return a}g.addQuoteDataToReplyMessage=a;g.getQuoteDataFromEchoMessage=b;g.updateQuoteDataForReplyMessages=f;g.enhanceAndPersistReplyMessagesWithQuoteData=i}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]);o=function(){return a};return a}function a(a,c,d){d==null?void 0:d.addPoint("reactions_restore_start");var e=a.echoMsgMap,f=a.restoredMsgsData,g=0;if(f){a=f.existingMsgs;var i=f.newlyAddedMsgs;i=i.concat(a);var j=f.threadJid;a=i.filter(function(a){var b=e.get(a.externalId);return q(e,a)&&b!=null&&r(b)});if(a.length===0)return(h||(h=b("Promise"))).resolve();var k=a.flatMap(function(a){var b=e.get(a.externalId);a=u(f.threadJid,c,a.externalId,a.msgId,a.author,b);return a.map(function(a){return{chatJid:j,unstoredReaction:a}})});return k.length===0?(h||(h=b("Promise"))).resolve():p(k).then(function(a){g+=k.length,d==null?void 0:d.addPoint("reactions_restore_end",{"int":{reactions:g}})})}return(h||(h=b("Promise"))).resolve()}var p=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:(c=d("MAWTransactionMode")).READWRITE,messages:c.READWRITE,reactions:c.READWRITE,threads:c.READWRITE},"restoreWriteReactionsToDb",function(a){return function(b){return d("MAWBulkWriteReactionsTxns").prepareReactionsData(a,b).then(function(b){return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,b)})}});function q(a,b){a=a.get(b.externalId);if(a==null){d("WALogger").ERROR(o());return!1}if(d("WAJids").isAuthorSystem(b.author)){d("WALogger").ERROR(n());return!1}if(d("MAWAuthor").getAuthorUserJid(b.author)==null){d("WALogger").ERROR(m());return!1}return!0}function r(a){return a.reactions!=null&&a.reactions.length!==0&&a.reactionXOfflineThreadingIds!=null&&a.reactionXOfflineThreadingIds.length!==0&&a.reactionAuthoritativeTimestampMs!=null&&a.reactionAuthoritativeTimestampMs.length!==0}function s(a,b,c){if((a==null?void 0:a.length)===0){d("WALogger").ERROR(l());return!1}if(b==null){d("WALogger").ERROR(k());return!1}if(c==null){d("WALogger").ERROR(j());return!1}return!0}function t(a,b,c){return(a||[]).map(function(a,e){if(c==null||b==null||(c==null?void 0:c.length)<=e||(b==null?void 0:b.length)<=e){d("WALogger").WARN(i());return[]}return[a,b[e],c[e]]})}function u(a,b,c,e,f,g){var h=d("MAWAuthor").getAuthorUserJid(f);if(g==null||h==null)return[];var i=g.reactionAuthoritativeTimestampMs;i=i===void 0?[]:i;var j=g.reactionXOfflineThreadingIds;j=j===void 0?[]:j;g=g.reactions;return t(g,j,i).filter(function(a){var b=a[0];a=a[1];return a!=null&&s(b.displayName,a.displayName,d("MAWAuthor").getAuthorUserJid(f))}).map(function(f){var g=f[0],i=f[1];f=f[2];var j=g.displayName;g=d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(g,b);g={ack:g===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,author:g,externalId:d("WAStanzaUtils").toStanzaId(i.displayName||""),groupingKey:j,reaction:j,reactToAuthor:h,reactToExternalId:c,senderTimestampMs:null,threadJid:a,ts:d("WATimeUtils").castToUnixTime(Number(f.displayName)/1e3)};return e!=null?babelHelpers["extends"]({},g,{reactToMsgId:e}):g})}g.writeEchoReactionsToReactionsStore=a;g.getReactionsForReactionStore=u}),98);
__d("MAWXMALoggingUtils",["WAArmadilloXMA.pb","objectEntries"],(function(a,b,c,d,e,f,g){"use strict";var h=c("objectEntries")(d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE).reduce(function(a,b){var c=b[0];b=b[1];a.set(b,c);return a},new Map());function a(a){return a!=null?h.get(a):void 0}g.getXmaTargetTypeStringFromEnum=a}),98);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWHIMLogger","MAWMsgType","MAWXMALoggingUtils","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"]);j=function(){return a};return a}function a(a){var b=new Set(),e=a.map(function(a){var c,e=a.decodedMsg,f=a.receiveFlow;a=a.stanza;var g=a.message.decrypted,h=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(e==null?void 0:e.xmaTargetTypeForLogging);f.addAnnotations({bool:{furuteproof:(e==null?void 0:(c=e.unstoredDbMsg)==null?void 0:c.type)===d("MAWMsgType").MSG_TYPE.FUTUREPROOF},"int":{xmaTargetType:(c=e==null?void 0:e.xmaTargetTypeForLogging)!=null?c:-1},string:{contentType:(c=e==null?void 0:e.contentTypeForLogging)!=null?c:"",xmaTargetTypeString:h}});if(d("MAWXMAUtils").isRtcXMA(e==null?void 0:(c=e.unstoredXMA)==null?void 0:(h=c.unstoredDbXMA)==null?void 0:h.targetType)){f.endFail("rtc_xma_not_supported");b.add(a.stanzaQueueId);return null}if(g.type==="InstamadilloMsg"){f.endFail("instamadillo_not_supported");b.add(a.stanzaQueueId);return null}if(g.type==="InvisibleMsg"){b.add(a.stanzaQueueId);return null}return{msgData:g,receiveFlow:f,unstoredContent:e}}).filter(Boolean);c("MAWHIMLogger").LOG(j(),e.length);return d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(e).then(function(d){var f=d.msgResults;c("MAWHIMLogger").LOG(i(),e.length);a.map(function(a){a=a.stanza;var d=f.get(a.message.decrypted.id);if(d==null){b.has(a.stanzaQueueId)||c("MAWHIMLogger").ERROR(h());return}d.success===!0&&b.add(a.stanzaQueueId)});return{followUpParams:{incomingMsgResults:f,incomingMsgs:a},toAck:Array.from(b)}})["catch"](function(b){var c="Not an Error instance",d="N/A";typeof b.message==="string"&&(c=b.message);typeof b.stack==="string"&&(d=b.stack);a.forEach(function(a){a.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:c,errorStack:d}})});throw b})}g.handleIncomingMessagesStanzas=a}),98);
__d("WASmaxInPreKeysIQErrorItemNotFoundMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","item-not-found");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",404);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorItemNotFoundMixin=a}),98);
__d("WASmaxInPreKeysRequestErrorsFetchDigest",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorItemNotFoundMixin","WASmaxInPreKeysIQErrorNotAcceptableMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInPreKeysIQErrorNotAcceptableMixin").parseIQErrorNotAcceptableMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorNotAcceptable",value:b.value});var c=d("WASmaxInPreKeysIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(a);if(c.success)return d("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:c.value});var e=d("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(a);return e.success?d("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:e.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorNotAcceptable","IQErrorItemNotFound","IQErrorFallbackClient"],[b,c,e])}g.parseRequestErrorsFetchDigest=a}),98);
__d("WASmaxInPreKeysFetchDigestResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrorsFetchDigest","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInPreKeysRequestErrorsFetchDigest").parseRequestErrorsFetchDigest(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRequestErrorsFetchDigest:b.value}))}g.parseFetchDigestResponseRequestError=a}),98);
__d("WASmaxInPreKeysFetchDigestResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInPreKeysServerErrors").parseServerErrors(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorServerErrors:b.value}))}g.parseFetchDigestResponseServerError=a}),98);
__d("WASmaxInPreKeysKeysHashMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){a=d("WASmaxParseUtils").flattenedChildWithTag(a,"hash");if(!a.success)return a;a=d("WASmaxParseUtils").contentBytesRange(a.value,20,20);return!a.success?a:d("WAResultOrError").makeResult({hashElementValue:a.value})}g.parseKeysHashMixin=a}),98);
__d("WASmaxInPreKeysPreKeyIDListMixin",["WAResultOrError","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"id");if(!b.success)return b;b=d("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(a);return!b.success?b:b}function a(a){a=d("WASmaxParseUtils").flattenedChildWithTag(a,"list");if(!a.success)return a;a=d("WASmaxParseUtils").mapChildrenWithTag(a.value,"id",0,2e4,h);return!a.success?a:d("WAResultOrError").makeResult({listId:a.value})}g.parsePreKeyIDListListId=h;g.parsePreKeyIDListMixin=a}),98);
__d("WASmaxInPreKeysIdentityDigestBundleMixin",["WAResultOrError","WASmaxInPreKeysIdentityKeyMixin","WASmaxInPreKeysKeyTypeMixin","WASmaxInPreKeysKeysHashMixin","WASmaxInPreKeysPreKeyIDListMixin","WASmaxInPreKeysRegistrationIDMixin","WASmaxInPreKeysSignedPreKeyMixin"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInPreKeysRegistrationIDMixin").parseRegistrationIDMixin(a);if(!b.success)return b;var c=d("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(a);if(!c.success)return c;var e=d("WASmaxInPreKeysPreKeyIDListMixin").parsePreKeyIDListMixin(a);if(!e.success)return e;var f=d("WASmaxInPreKeysSignedPreKeyMixin").parseSignedPreKeyMixin(a);if(!f.success)return f;var g=d("WASmaxInPreKeysKeyTypeMixin").parseKeyTypeMixin(a);a=d("WASmaxInPreKeysKeysHashMixin").parseKeysHashMixin(a);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({},b.value,c.value,e.value,f.value,{keyTypeMixin:g.success?g.value:null},a.value))}g.parseIdentityDigestBundleMixin=a}),98);
__d("WASmaxInPreKeysFetchDigestResponseSuccess",["WAResultOrError","WASmaxInPreKeysIQResultResponseMixin","WASmaxInPreKeysIdentityDigestBundleMixin","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"digest");if(!c.success)return c;var e=d("WASmaxParseReference").optionalAttrStringFromReference(b,["digest","identity_type"]);if(!e.success)return e;e=d("WASmaxParseUtils").optionalLiteral(d("WASmaxParseUtils").attrString,c.value,"identity_type",e.value);if(!e.success)return e;c=d("WASmaxInPreKeysIdentityDigestBundleMixin").parseIdentityDigestBundleMixin(c.value);if(!c.success)return c;a=d("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({hasDigestIdentityType:e.value!=null,digestIdentityDigestBundleMixin:c.value},a.value))}g.parseFetchDigestResponseSuccess=a}),98);
__d("WASmaxOutPreKeysFetchDigestRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin"],(function(a,b,c,d,e,f,g){function a(){var a=d("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(d("WASmaxJsx").smax("iq",{type:"get"},d("WASmaxJsx").smax("digest",null)));return a}g.makeFetchDigestRequest=a}),98);
__d("WASmaxPreKeysFetchDigestRPC",["WAComms","WASmaxInPreKeysFetchDigestResponseRequestError","WASmaxInPreKeysFetchDigestResponseServerError","WASmaxInPreKeysFetchDigestResponseSuccess","WASmaxOutPreKeysFetchDigestRequest","WASmaxParsingFailure","WASmaxRpcUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a){var c,e,f,g,h;return b("regeneratorRuntime").async(function(i){while(1)switch(i.prev=i.next){case 0:c=d("WASmaxOutPreKeysFetchDigestRequest").makeFetchDigestRequest();i.next=3;return b("regeneratorRuntime").awrap(d("WAComms").sendSmaxStanza(c,a));case 3:e=i.sent;f=d("WASmaxInPreKeysFetchDigestResponseSuccess").parseFetchDigestResponseSuccess(e,c);if(!f.success){i.next=7;break}return i.abrupt("return",{name:"FetchDigestResponseSuccess",value:f.value});case 7:g=d("WASmaxInPreKeysFetchDigestResponseRequestError").parseFetchDigestResponseRequestError(e,c);if(!g.success){i.next=10;break}return i.abrupt("return",{name:"FetchDigestResponseRequestError",value:g.value});case 10:h=d("WASmaxInPreKeysFetchDigestResponseServerError").parseFetchDigestResponseServerError(e,c);if(!h.success){i.next=13;break}return i.abrupt("return",{name:"FetchDigestResponseServerError",value:h.value});case 13:throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("FetchDigest",{Success:f,RequestError:g,ServerError:h}));case 14:case"end":return i.stop()}},null,this)}g.sendFetchDigestRPC=a}),98);
__d("WARequestPreKeyDigestProtocol",["WABinary","WAConvertRegistrationIdMixin","WAConvertSignedPreKeyMixin","WACryptoDependencies","WACryptoUtils","WAParsableXmlNode","WAResultOrError","WASignalKeys","WASmaxPreKeysFetchDigestRPC","WATagsLogger","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS(["requestPreKeyDigestProtocol"]);function a(a){return d("WASmaxPreKeysFetchDigestRPC").sendFetchDigestRPC({withoutRetry:!1}).then(function(b){switch(b.name){case"FetchDigestResponseServerError":var c=b.value.errorServerErrors.name;j.ERROR(i(),b.name,c);return d("WAResultOrError").makeError({type:"server-error",payload:c});case"FetchDigestResponseRequestError":c=b.value.errorRequestErrorsFetchDigest.name;j.ERROR(h(),b.name,c);return d("WAResultOrError").makeError({type:"request-error",payload:c});default:b.name;c=k(b.value.digestIdentityDigestBundleMixin);return l(c,a).then(function(a){return a==="ok"?d("WAResultOrError").makeResult():d("WAResultOrError").makeError({type:"compare-error",payload:a})})}})}function k(a){var b=d("WAConvertRegistrationIdMixin").registrationIdMixin(a),c=d("WAConvertSignedPreKeyMixin").convertSignedPreKeyMixin(a),e=a.listId.map(function(a){return d("WASignalKeys").castToPreKeyId(d("WAParsableXmlNode").convertBytesToUint(a.elementValue,3))});a=a.hashElementValue;return{regId:b,skeyId:c.id,preKeyIds:e,hash:a}}function l(a,c){var e,f,g,h;return b("regeneratorRuntime").async(function(i){while(1)switch(i.prev=i.next){case 0:if(!(a.regId!==c.regInfo.regId)){i.next=2;break}return i.abrupt("return","RegIdMismatch");case 2:if(!(a.skeyId!==c.signedPreKey.id)){i.next=4;break}return i.abrupt("return","SignedPreKeyIdMismatch");case 4:e=new Map();c.preKeys.forEach(function(a){return e.set(a.id,a)});f=a.preKeyIds.some(function(a){return!e.has(a)});if(!f){i.next=9;break}return i.abrupt("return","UnknownPreKey");case 9:g=a.preKeyIds.map(function(a){return e.get(a)}).filter(Boolean);i.next=12;return b("regeneratorRuntime").awrap(m(c,g));case 12:h=i.sent;if(d("WACryptoUtils").uint8ArraysEqual(h,a.hash)){i.next=15;break}return i.abrupt("return","HashMismatch");case 15:return i.abrupt("return","ok");case 16:case"end":return i.stop()}},null,this)}function m(a,b){var c=new(d("WABinary").Binary)();c.writeByteArray(a.regInfo.staticKeyPair.publicKey);c.writeByteArray(a.signedPreKey.keyPair.publicKey);c.writeByteArray(a.signedPreKey.signature);b.forEach(function(a){c.writeByteArray(a.keyPair.publicKey)});return d("WACryptoDependencies").getCrypto().subtle.digest("SHA-1",c.readByteArray()).then(function(a){return new Uint8Array(a)})}g.requestPreKeyDigestProtocol=a}),98);
__d("WARequestPreKeyDigest",["WABridge","WAErr","WAGenerateAndUploadPreKeys","WAGetKeysForUpload","WAGlobals","WALogger","WAOdsEnums","WARequestPreKeyDigestProtocol","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["PreKey digest comparison failed: ",""]);i=function(){return a};return a}function j(a){var e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:g.next=2;return b("regeneratorRuntime").awrap(a(function(a){a=a.cryptoManager;return d("WAGetKeysForUpload").getKeysForUpload(a)}));case 2:e=g.sent;if(!(e.success===!1)){g.next=6;break}d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PREKEY_DIGEST,key:"fail"});throw c("WAErr")("Error while loading keys: "+e.error);case 6:g.next=8;return b("regeneratorRuntime").awrap(d("WARequestPreKeyDigestProtocol").requestPreKeyDigestProtocol(e.value));case 8:f=g.sent;if(!(f.success===!1)){g.next=16;break}d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PREKEY_DIGEST,key:"fail"});if(!(f.error.type==="compare-error")){g.next=15;break}d("WALogger").ERROR(i(),f.error.payload);d("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys(null,{reason:"prekey digest comparison failed"})["catch"](function(a){d("WALogger").ERROR(h(),a)});return g.abrupt("return");case 15:throw c("WAErr")("Error while requesting key digest: "+f.error.type+" "+f.error.payload);case 16:f.success,d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PREKEY_DIGEST,key:"success"});case 18:case"end":return g.stop()}},null,this)}function a(a){return j(function(a){return d("WAGlobals").getWaOneQueue().enqueue(a,{operationType:"request_prekey_digest",flush:!1})})}g.requestPreKeyDigestFn=j;g.requestPreKeyDigest=a}),98);